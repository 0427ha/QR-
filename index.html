<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>스마트 시설 통합 대시보드</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
        /* 혼잡도 색상 */
        .level-여유 { background-color: #4CAF50; } /* Green */
        .level-보통 { background-color: #FFC107; } /* Yellow */
        .level-혼잡 { background-color: #FF9800; } /* Orange */
        .level-매우_혼잡 { background-color: #F44336; } /* Red */
        /* 2D 평면도 스타일 */
        #visualization-canvas {
            border: 1px solid #e5e7eb;
            background-color: #ffffff;
            border-radius: 8px;
        }
        /* 시각적으로 중요한 텍스트 */
        .highlight-text {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
        }
        /* 로딩 애니메이션 */
        .animate-pulse-slow {
            animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">
    <div id="app" class="max-w-7xl mx-auto">
        <header class="mb-8">
            <h1 class="text-3xl font-extrabold text-gray-900 flex items-center">
                <i data-lucide="layout-dashboard" class="w-8 h-8 mr-3 text-indigo-600"></i>
                스마트 시설 통합 운영 대시보드
            </h1>
            <p id="last-updated" class="text-sm text-gray-500 mt-1">마지막 업데이트: --:--:-- (목업 데이터)</p>
        </header>

        <!-- 핵심 요약 (안전 및 환경) -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- 안전 현황 요약 (SC-01) -->
            <div id="safety-summary" class="card bg-indigo-600 text-white md:col-span-1 flex flex-col justify-between">
                <div>
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-semibold">안전 인력 투입 현황 (SC-01)</h2>
                        <i data-lucide="shield-check" class="w-6 h-6"></i>
                    </div>
                    <p class="text-lg mt-2">총 시설 인원: <span id="safety-total-personnel" class="highlight-text">--</span> 명</p>
                    <p class="text-lg">예상 운항 횟수: <span id="safety-flight-count" class="highlight-text">--</span> 회</p>
                </div>
                <div class="mt-4 pt-3 border-t border-indigo-400">
                    <p class="font-bold text-xl" id="safety-action-required">조치 필요 여부: 확인 중...</p>
                    <p class="text-sm mt-1" id="safety-ratio-info">인원/운항 비율: --</p>
                </div>
            </div>

            <!-- 환경 제어 요약 (ENV-01) -->
            <div id="environment-summary" class="card bg-cyan-600 text-white md:col-span-1 flex flex-col justify-between">
                <div>
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-semibold">환경 및 에너지 제어 (ENV-01)</h2>
                        <i data-lucide="thermometer" class="w-6 h-6"></i>
                    </div>
                    <p class="text-lg mt-2">실내 온도: <span id="env-temp" class="highlight-text">--</span> °C</p>
                    <p class="text-lg">실내 습도: <span id="env-humidity" class="highlight-text">--</span> %</p>
                </div>
                <div class="mt-4 pt-3 border-t border-cyan-400">
                    <p class="font-bold text-xl" id="env-hvac-status">냉난방 제어: --</p>
                    <p class="text-sm mt-1" id="env-lighting-status">조명 제어: --</p>
                </div>
            </div>

            <!-- GPT AI 경고 요약 (GPT-01) -->
            <div id="gpt-alert-summary" class="card bg-gray-500 text-white md:col-span-1 flex flex-col justify-between">
                <div>
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-semibold">AI 이상 감지 (GPT-01)</h2>
                        <i data-lucide="alert-triangle" class="w-6 h-6"></i>
                    </div>
                    <p class="text-lg mt-2">최근 경고 건수: <span id="gpt-alert-count" class="highlight-text">--</span> 건</p>
                </div>
                <div class="mt-4 pt-3 border-t border-gray-400">
                    <p class="font-bold text-xl" id="gpt-latest-risk">최신 위험: 특이 사항 없음</p>
                    <p class="text-sm mt-1" id="gpt-latest-location">위치: N/A</p>
                </div>
            </div>
        </div>

        <!-- 실시간 모니터링 (VI-01, LI-01) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div class="lg:col-span-2">
                <div class="card h-full">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <i data-lucide="map" class="w-5 h-5 mr-2 text-gray-500"></i>
                        2D 평면도 혼잡 시각화 (VI-01)
                    </h2>
                    <div class="bg-gray-100 p-2 rounded-lg relative" style="height: 400px;">
                        <canvas id="visualization-canvas" width="800" height="400" class="w-full h-full"></canvas>
                        <p class="absolute bottom-2 left-2 text-xs text-gray-500">
                            * 점의 크기와 색상은 구역별 혼잡도를 나타냅니다.
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="lg:col-span-1">
                <div class="card h-full">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <i data-lucide="list-ordered" class="w-5 h-5 mr-2 text-gray-500"></i>
                        구역별 실시간 리스트 (LI-01)
                    </h2>
                    <div id="congestion-list" class="space-y-3 max-h-[350px] overflow-y-auto pr-2">
                        <!-- 목업 데이터 로드 예정 -->
                        <div class="text-center p-8 text-gray-500">목업 데이터 로딩 중...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 예측 및 경고 목록 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- 시간대별 혼잡 예측 (CH-01) -->
            <div class="card">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i data-lucide="activity" class="w-5 h-5 mr-2 text-gray-500"></i>
                    3시간 후 혼잡 예측 (CH-01)
                </h2>
                <div id="prediction-list" class="space-y-4">
                    <div class="text-center p-8 text-gray-500">예측 데이터 로딩 중...</div>
                </div>
            </div>

            <!-- GPT AI 경고 상세 목록 (GPT-01) -->
            <div class="card">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i data-lucide="bell" class="w-5 h-5 mr-2 text-gray-500"></i>
                    AI 비정형 위험 경고 상세 (GPT-01)
                </h2>
                <div id="alert-list" class="space-y-4 max-h-[300px] overflow-y-auto pr-2">
                    <div class="text-center p-8 text-gray-500">경고 데이터 로딩 중...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript 로직 -->
    <script>
        // 기존 API_URL 사용 대신, 목업 데이터를 사용합니다.
        // const API_URL = 'http://127.0.0.1:5000/api/v1/dashboard/data'; // 주석 처리
        
        const ctx = document.getElementById('visualization-canvas').getContext('2d');
        const CANVAS_WIDTH = 800;
        const CANVAS_HEIGHT = 400;

        // --- 목업 데이터 정의 (API 서버 대신 이 데이터를 사용합니다) ---
        const MOCK_DASHBOARD_DATA = {
            "realtime": [
                { "area_id": "A-01", "area_name": "탑승 게이트 1", "current_personnel": 150, "max_capacity": 200, "congestion_ratio": 0.75, "congestion_level": "혼잡", "coordinates": { "x": 150, "y": 100 }, "timestamp": Date.now() / 1000 },
                { "area_id": "A-02", "area_name": "라운지 중앙", "current_personnel": 80, "max_capacity": 300, "congestion_ratio": 0.26, "congestion_level": "여유", "coordinates": { "x": 400, "y": 250 }, "timestamp": Date.now() / 1000 },
                { "area_id": "A-03", "area_name": "보안 검색대", "current_personnel": 180, "max_capacity": 220, "congestion_ratio": 0.82, "congestion_level": "매우 혼잡", "coordinates": { "x": 650, "y": 150 }, "timestamp": Date.now() / 1000 },
                { "area_id": "A-04", "area_name": "환승 통로", "current_personnel": 45, "max_capacity": 150, "congestion_ratio": 0.30, "congestion_level": "보통", "coordinates": { "x": 250, "y": 350 }, "timestamp": Date.now() / 1000 }
            ],
            "predictions": {
                "predicted_congestion": [
                    {
                        "area_name": "탑승 게이트 1",
                        "prediction_segments": [
                            { "time_offset_min": 60, "predicted_ratio": 0.95, "level": "매우 혼잡" },
                            { "time_offset_min": 120, "predicted_ratio": 0.70, "level": "혼잡" },
                            { "time_offset_min": 180, "predicted_ratio": 0.40, "level": "보통" }
                        ]
                    },
                    {
                        "area_name": "보안 검색대",
                        "prediction_segments": [
                            { "time_offset_min": 60, "predicted_ratio": 0.60, "level": "혼잡" },
                            { "time_offset_min": 120, "predicted_ratio": 0.55, "level": "혼잡" },
                            { "time_offset_min": 180, "predicted_ratio": 0.25, "level": "여유" }
                        ]
                    }
                ],
                "ai_alerts": [
                    { "alert_time": Date.now() / 1000 - 60, "location": "보안 검색대", "risk_summary": "장시간 정지된 미확인 물체 감지 (폭발물 위험은 낮음)", "snapshot_url": "#" },
                    { "alert_time": Date.now() / 1000 - 300, "location": "환승 통로", "risk_summary": "2인 이상 소란 행위 감지 및 분산 조치 완료", "snapshot_url": "#" }
                ]
            },
            "safety": {
                "total_personnel": 125,
                "flight_count": 22,
                "personnel_to_flight_ratio": 5.68, // 125/22
                "safety_threshold_exceeded": true, // 임계치 5.0 초과 가정
                "required_personnel_action": "⚠️ 인력 재배치 또는 추가 필요"
            },
            "environment": {
                "current_temperature": 25.1,
                "target_temperature": 23.0,
                "current_humidity": 45.8,
                "hvac_auto_control_status": true,
                "lighting_auto_control_status": true,
                "target_illuminance": 500,
                "current_noise_level_db": 68.5
            }
        };
        // --- 목업 데이터 정의 끝 ---


        // --- 유틸리티 함수 ---
        function formatRatio(ratio) {
            return (ratio * 100).toFixed(0) + '%';
        }

        function getLevelColor(level) {
            switch (level) {
                case '여유': return '#4CAF50'; // Green
                case '보통': return '#FFC107'; // Yellow
                case '혼잡': return '#FF9800'; // Orange
                case '매우 혼잡': return '#F44336'; // Red
                default: return '#cccccc';
            }
        }

        function formatTimestamp(timestamp) {
            // JS timestamp는 밀리초 단위이므로 1000을 곱합니다 (MOCK_DATA의 Date.now()/1000에 맞춤)
            const date = new Date(timestamp * 1000); 
            return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        // --- 2D 평면도 시각화 (VI-01) ---
        function drawVisualization(realtimeData) {
            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            
            // 건물 평면도 배경 (간단한 회색 배경)
            ctx.fillStyle = '#f9fafb';
            ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

            realtimeData.forEach(item => {
                const { x, y } = item.coordinates;
                const ratio = item.congestion_ratio;
                const color = getLevelColor(item.congestion_level);
                
                // 좌표 스케일링 (CANVAS_WIDTH/800, CANVAS_HEIGHT/400에 맞춰 조정)
                const scaledX = (x / 800) * document.getElementById('visualization-canvas').width;
                const scaledY = (y / 400) * document.getElementById('visualization-canvas').height;

                // 원 크기: 혼잡도에 따라 (최소 10px, 최대 40px)
                const radius = 10 + (ratio * 30); 

                // 1. 혼잡도 원 그리기
                ctx.beginPath();
                ctx.arc(scaledX, scaledY, radius, 0, Math.PI * 2);
                ctx.fillStyle = color;
                ctx.globalAlpha = 0.7; // 투명도
                ctx.fill();
                ctx.globalAlpha = 1.0;
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.stroke();

                // 2. 구역 이름 및 인원 표시
                ctx.fillStyle = '#1f2937'; // Dark text
                ctx.textAlign = 'center';
                ctx.font = 'bold 12px Inter';
                ctx.fillText(item.area_name, scaledX, scaledY - radius - 5);
                
                ctx.font = '10px Inter';
                ctx.fillText(`${item.current_personnel}명 (${formatRatio(ratio)})`, scaledX, scaledY + radius + 15);
            });
        }

        // --- 데이터 렌더링 함수 (생략 없음) ---
        
        // 실시간 리스트 (LI-01) 렌더링
        function renderCongestionList(realtimeData) {
            const listContainer = document.getElementById('congestion-list');
            listContainer.innerHTML = ''; // 초기화
            
            // 혼잡도 순으로 내림차순 정렬
            realtimeData.sort((a, b) => b.congestion_ratio - a.congestion_ratio);

            realtimeData.forEach(item => {
                const colorClass = `level-${item.congestion_level.replace(' ', '_')}`;
                const textColor = item.congestion_level === '여유' ? 'text-gray-900' : 'text-white';
                
                const html = `
                    <div class="flex items-center p-3 rounded-lg shadow-sm border border-gray-200">
                        <div class="w-12 h-8 rounded-md flex items-center justify-center font-bold text-sm ${colorClass} ${textColor}">
                            ${item.congestion_level}
                        </div>
                        <div class="ml-4 flex-1">
                            <p class="font-semibold text-gray-800">${item.area_name} (${item.area_id})</p>
                            <p class="text-sm text-gray-500">인원: ${item.current_personnel}/${item.max_capacity} (${formatRatio(item.congestion_ratio)})</p>
                        </div>
                    </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', html);
            });
        }

        // 예측 목록 (CH-01) 렌더링
        function renderPredictionList(predictions) {
            const listContainer = document.getElementById('prediction-list');
            listContainer.innerHTML = '';
            
            predictions.predicted_congestion.forEach(areaPrediction => {
                const segmentsHtml = areaPrediction.prediction_segments.map(segment => {
                    const colorClass = `level-${segment.level.replace(' ', '_')}`;
                    const textColor = segment.level === '여유' ? 'text-gray-900' : 'text-white';

                    return `
                        <div class="flex flex-col items-center mx-2 p-2 rounded-lg ${colorClass} text-center ${textColor}">
                            <span class="text-xs font-semibold">${segment.time_offset_min}분 후</span>
                            <span class="text-sm font-bold mt-1">${formatRatio(segment.predicted_ratio)}</span>
                            <span class="text-xs">${segment.level}</span>
                        </div>
                    `;
                }).join('');

                const html = `
                    <div class="border border-gray-200 p-4 rounded-lg">
                        <p class="font-bold text-gray-800 mb-2">${areaPrediction.area_name}</p>
                        <div class="flex justify-around">
                            ${segmentsHtml}
                        </div>
                    </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', html);
            });
        }

        // GPT 경고 목록 (GPT-01) 렌더링
        function renderAlerts(alerts) {
            const alertCountElem = document.getElementById('gpt-alert-count');
            const latestRiskElem = document.getElementById('gpt-latest-risk');
            const latestLocationElem = document.getElementById('gpt-latest-location');
            const alertListContainer = document.getElementById('alert-list');
            const gptSummaryCard = document.getElementById('gpt-alert-summary');
            
            alertListContainer.innerHTML = '';
            alertCountElem.textContent = alerts.ai_alerts.length;

            if (alerts.ai_alerts.length === 0) {
                latestRiskElem.textContent = '특이 사항 없음';
                latestLocationElem.textContent = '위치: N/A';
                alertListContainer.innerHTML = '<div class="text-center p-4 text-gray-500">최근 갱신 시점 이후 AI 감지 위험 없음.</div>';
                gptSummaryCard.classList.replace('bg-red-600', 'bg-gray-500');
                gptSummaryCard.classList.remove('animate-pulse-slow');
                return;
            }
            
            gptSummaryCard.classList.replace('bg-gray-500', 'bg-red-600');
            gptSummaryCard.classList.add('animate-pulse-slow'); // 위험 경고 시 깜빡임 효과

            // 최신 경고 업데이트
            const latestAlert = alerts.ai_alerts[0];
            latestRiskElem.textContent = latestAlert.risk_summary.substring(0, 30) + (latestAlert.risk_summary.length > 30 ? '...' : '');
            latestLocationElem.textContent = `위치: ${latestAlert.location}`;

            // 상세 목록
            alerts.ai_alerts.forEach(alert => {
                const time = formatTimestamp(alert.alert_time);
                const html = `
                    <div class="bg-red-50 p-3 rounded-lg border border-red-200">
                        <p class="font-bold text-red-700 flex items-center">
                            <i data-lucide="siren" class="w-4 h-4 mr-2"></i>
                            [${time}] ${alert.location}
                        </p>
                        <p class="text-sm text-gray-700 mt-1">${alert.risk_summary}</p>
                        <a href="${alert.snapshot_url}" target="_blank" class="text-xs text-indigo-500 hover:underline mt-1 block">스냅샷 보기 (Mock)</a>
                    </div>
                `;
                alertListContainer.insertAdjacentHTML('beforeend', html);
            });
        }

        // 안전 현황 (SC-01) 렌더링
        function renderSafetyStatus(safety) {
            const summaryElem = document.getElementById('safety-summary');
            document.getElementById('safety-total-personnel').textContent = safety.total_personnel;
            document.getElementById('safety-flight-count').textContent = safety.flight_count;
            document.getElementById('safety-ratio-info').textContent = `인원/운항 비율: ${safety.personnel_to_flight_ratio.toFixed(2)} (임계치: 5.0)`;
            document.getElementById('safety-action-required').textContent = safety.required_personnel_action;

            // 색상 업데이트
            if (safety.safety_threshold_exceeded) {
                summaryElem.classList.replace('bg-indigo-600', 'bg-yellow-600');
                summaryElem.classList.add('animate-pulse-slow');
            } else {
                summaryElem.classList.replace('bg-yellow-600', 'bg-indigo-600');
                summaryElem.classList.remove('animate-pulse-slow');
            }
        }

        // 환경 제어 현황 (ENV-01, EN-01) 렌더링
        function renderEnvironmentStatus(environment) {
            document.getElementById('env-temp').textContent = environment.current_temperature.toFixed(1);
            document.getElementById('env-humidity').textContent = environment.current_humidity.toFixed(1);

            const hvacTarget = environment.target_temperature ? `(목표: ${environment.target_temperature}℃)` : '';
            const lightingTarget = environment.target_illuminance ? `(목표 조도: ${environment.target_illuminance} Lux)` : '';

            document.getElementById('env-hvac-status').textContent = `냉난방 제어: ${environment.hvac_auto_control_status ? '자동 ON' : 'OFF'} ${hvacTarget}`;
            document.getElementById('env-lighting-status').textContent = `조명 제어: ${environment.lighting_auto_control_status ? '자동 ON' : 'OFF'} ${lightingTarget}`;
        }


        // --- 메인 데이터 호출 및 통합 처리 ---

        // API 호출 대신 목업 데이터를 사용하도록 수정했습니다.
        function loadMockData() {
            // 목업 데이터 로드
            const data = MOCK_DASHBOARD_DATA;
            
            // 1. 실시간 데이터 (LI-01, VI-01)
            drawVisualization(data.realtime);
            renderCongestionList(data.realtime);

            // 2. 예측 및 경고 (CH-01, GPT-01)
            renderPredictionList(data.predictions);
            renderAlerts(data.predictions);

            // 3. 안전 현황 (SC-01)
            renderSafetyStatus(data.safety);

            // 4. 환경 제어 (ENV-01, EN-01)
            renderEnvironmentStatus(data.environment);

            // 마지막 업데이트 시간 기록
            document.getElementById('last-updated').textContent = `마지막 업데이트: ${formatTimestamp(Date.now() / 1000)} (목업 데이터)`;

            // 아이콘 다시 렌더링 (Lucide)
            lucide.createIcons();
        }

        // 초기 로드 및 타이머 설정 (5초마다 업데이트)
        window.onload = function() {
            // 캔버스 크기 조정 (반응형 대응)
            const canvas = document.getElementById('visualization-canvas');
            const container = canvas.parentElement;
            const resizeCanvas = () => {
                const width = container.clientWidth - 4; // 패딩 고려
                const height = 400; // 고정 높이
                canvas.width = width;
                canvas.height = height;
                // 데이터를 다시 그려야 함
                loadMockData(); 
            };
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas(); // 초기 크기 설정

            // 초기 데이터 로드
            loadMockData();
            
            // 5초 간격으로 데이터 업데이트
            // setInterval(loadMockData, 5000); // 5초마다 데이터 업데이트 (선택 사항)
        };
    </script>
</body>
</html>