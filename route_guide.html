<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì œ GPS ê¸°ë°˜ ë‚´ë¹„ê²Œì´ì…˜ ì‹œë®¬ë ˆì´ì…˜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .container { max-width: 800px; }
        .card { background-color: white; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); }
        .gps-status-ok { background-color: #d1fae5; color: #065f46; border: 1px solid #34d399; }
        .gps-status-err { background-color: #fee2e2; color: #991b1b; border: 1px solid #f87171; }
        
        #route-map {
            width: 100%;
            height: auto;
            border: 1px solid #e5e7eb;
            background-color: #ffffff;
            border-radius: 0.75rem;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            min-height: 250px; 
        }

        #navigation-bar {
            position: fixed; 
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 10;
            background-color: #1e3a8a;
            color: white;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.2);
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
            padding: 1rem;
        }

        #navigation-bar.active {
            transform: translateY(0);
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="container mx-auto pb-32">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-6 border-b-4 border-blue-500 pb-2">
            ğŸ›°ï¸ ì‹¤ì œ GPS ê¸°ë°˜ ë‚´ë¹„ê²Œì´ì…˜
        </h1>

        <div class="card p-6 rounded-xl mb-6">
            <div id="gps-status-message" class="p-3 mb-4 rounded-lg text-sm font-medium gps-status-err">
                GPS ìƒíƒœ: ë‚´ë¹„ê²Œì´ì…˜ì„ ì‹œì‘í•´ì•¼ ìœ„ì¹˜ ì¶”ì ì„ ì‹œì‘í•©ë‹ˆë‹¤.
            </div>
            
            <h2 class="text-xl font-bold text-gray-700 mb-4">ê²½ë¡œ ì„¤ì •</h2>
            <div class="flex flex-col sm:flex-row gap-4">
                <div class="flex-1">
                    <label for="start-area" class="block text-sm font-medium text-gray-700 mb-1">ì¶œë°œ êµ¬ì—­</label>
                    <select id="start-area" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-gray-50">
                        </select>
                </div>
                <div class="flex-1">
                    <label for="end-area" class="block text-sm font-medium text-gray-700 mb-1">ë„ì°© êµ¬ì—­</label>
                    <select id="end-area" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </select>
                </div>
                <button id="search-button" onclick="startRouteGuidance()" class="sm:self-end mt-2 sm:mt-0 px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150 shadow-md">
                    ê²½ë¡œ ê²€ìƒ‰ ë° ë‚´ë¹„ê²Œì´ì…˜ ì¤€ë¹„
                </button>
            </div>
        </div>

        <div class="card p-6 rounded-xl">
            <h2 class="text-xl font-bold text-gray-700 mb-4">ê²½ë¡œ ì§€ë„ ì‹œê°í™”</h2>
            
            <canvas id="route-map" width="700" height="400" class="mb-6"></canvas>

            <div id="route-guidance-output">
                <p class="text-gray-500">ì§€ë„ë¥¼ ì‹œê°í™”í•˜ê¸° ìœ„í•´ ì¶œë°œì§€ ë° ë„ì°©ì§€ë¥¼ ì„¤ì •í•˜ê³  ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
            </div>
            
            <div id="steps-list" class="mt-8 hidden">
                <h3 class="text-lg font-bold text-gray-700 mb-3">ì „ì²´ ê²½ë¡œ ì§€ì¹¨ ë¯¸ë¦¬ë³´ê¸°:</h3>
                </div>
        </div>
    </div>

    <div id="navigation-bar" class="p-4 flex items-center justify-between">
        <div class="flex items-center space-x-3">
            <div id="current-turn-icon" class="text-4xl flex-shrink-0">
                </div>
            <div class="flex flex-col min-w-0">
                <p id="nav-next-instruction" class="text-xl font-extrabold leading-snug truncate">
                    ê²½ë¡œë¥¼ ê²€ìƒ‰í•´ ì£¼ì„¸ìš”.
                </p>
                <p id="nav-step-info" class="text-sm text-blue-200 mt-0.5">
                    ì´ ê±°ë¦¬: 0m | ì´ ì‹œê°„: 0ë¶„
                </p>
            </div>
        </div>
        <button id="nav-control-button" onclick="toggleNavigation()" class="px-5 py-2 bg-green-500 text-white font-bold rounded-full shadow-lg hover:bg-green-600 transition duration-150 flex-shrink-0" disabled>
            GPS ë‚´ë¹„ ì‹œì‘
        </button>
    </div>

    <script>
        // --- ì§€ë„ ë° ê²½ë¡œ ë°ì´í„° ì •ì˜ (ì‹¤ì œ GPS í˜•ì‹ì˜ ê°€ìƒ ì¢Œí‘œ ì‚¬ìš©) ---
        const AREA_NAMES = {
            'A': 'ì¶œë°œ/ë„ì°© í™€ (Gate A)', 'B': 'ë³´ì•ˆ ê²€ìƒ‰ëŒ€ (Security)', 'C': 'ë©´ì„¸ êµ¬ì—­ (Duty-Free)',
            'D': 'í™˜ìŠ¹ ë¼ìš´ì§€ (Transfer)', 'E': 'íƒ‘ìŠ¹ ê²Œì´íŠ¸ (Gate E)', 'F': 'ì‹¤ì™¸ ì£¼ì°¨ì¥ (Parking Lot)',
            'G': 'ì‹¤ì™¸ ë²„ìŠ¤ í„°ë¯¸ë„ (Bus Terminal)', 'H': 'ì§€í•˜ì²  ì—°ê²° í†µë¡œ (Subway Link)'
        };
        const AREA_IDS = Object.keys(AREA_NAMES);
        
        // **ìˆ˜ì •ëœ ê°€ìƒ ì¢Œí‘œ**: ê±°ë¦¬ê°€ í˜„ì‹¤ì ìœ¼ë¡œ ë‚˜ì˜¤ë„ë¡ ì†Œìˆ˜ì  4ìë¦¬ ì´í•˜ë§Œ ë³€ê²½
        const AREA_COORDINATES = {
            'A': { lat: 37.513400, lon: 127.058800 }, // ì¶œë°œ/ë„ì°© í™€
            'B': { lat: 37.513405, lon: 127.058810 }, // ë³´ì•ˆ ê²€ìƒ‰ëŒ€
            'C': { lat: 37.513415, lon: 127.058820 }, // ë©´ì„¸ êµ¬ì—­
            'D': { lat: 37.513420, lon: 127.058830 }, // í™˜ìŠ¹ ë¼ìš´ì§€
            'E': { lat: 37.513430, lon: 127.058850 }, // íƒ‘ìŠ¹ ê²Œì´íŠ¸
            'F': { lat: 37.513390, lon: 127.058790 }, // ì‹¤ì™¸ ì£¼ì°¨ì¥
            'G': { lat: 37.513410, lon: 127.058805 }, // ë²„ìŠ¤ í„°ë¯¸ë„
            'H': { lat: 37.513410, lon: 127.058835 }  // ì§€í•˜ì²  ì—°ê²° í†µë¡œ
        };
        
        // ê²½ë¡œ ì—°ê²° ì •ë³´ (Dijkstra ê³„ì‚°ìš©) - ì‹œê°„(time)ì€ ê°€ì¤‘ì¹˜ë¡œ ì‚¬ìš©ë˜ì§€ë§Œ, UIì—ì„œëŠ” ì´ì œ ë‚¨ì€ ê±°ë¦¬ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë™ì  ê³„ì‚°ë¨.
        const ALL_CONNECTIONS = [
            // u, v, distance(m), time(min), turn, instruction (ê²½ë¡œ ê°€ì´ë“œ)
            { u: 'A', v: 'B', distance: 16.7, time: 0.5, turn: "ì§ì§„", instruction: "ì •ë©´ì˜ ë³´ì•ˆ ê²€ìƒ‰ëŒ€(B) ë°©í–¥ìœ¼ë¡œ ì§ì§„í•©ë‹ˆë‹¤." },
            { u: 'B', v: 'C', distance: 22.3, time: 0.8, turn: "ìš°íšŒì „", instruction: "ë³´ì•ˆ ê²€ìƒ‰ëŒ€ë¥¼ í†µê³¼í•œ í›„ ë©´ì„¸ êµ¬ì—­(C)ìœ¼ë¡œ ìš°íšŒì „í•©ë‹ˆë‹¤." },
            { u: 'C', v: 'D', distance: 18.0, time: 0.6, turn: "ì§ì§„", instruction: "ì¤‘ì•™ ë³µë„ë¥¼ ë”°ë¼ í™˜ìŠ¹ ë¼ìš´ì§€(D)ë¡œ ì§ì§„í•©ë‹ˆë‹¤." },
            { u: 'D', v: 'E', distance: 25.1, time: 1.0, turn: "ìš°íšŒì „", instruction: "ì˜¤ë¥¸ìª½ íƒ‘ìŠ¹ ê²Œì´íŠ¸(E) ë°©í–¥ìœ¼ë¡œ ìš°íšŒì „í•©ë‹ˆë‹¤." },
            { u: 'A', v: 'F', distance: 25.0, time: 0.8, turn: "ì¢ŒíšŒì „", instruction: "ì™¼ìª½ ì£¼ì°¨ì¥(F) ì…êµ¬ë¡œ ì§„ì…í•©ë‹ˆë‹¤." },
            { u: 'A', v: 'H', distance: 22.3, time: 0.7, turn: "ì§ì§„", instruction: "ì§€í•˜ì²  ì—°ê²° í†µë¡œ(H) ìª½ìœ¼ë¡œ ì§ì§„í•©ë‹ˆë‹¤." },
            { u: 'C', v: 'H', distance: 16.7, time: 0.5, turn: "ì§ì§„", instruction: "ì§€í•˜ì²  ì—°ê²° í†µë¡œ(H) ë°©í–¥ìœ¼ë¡œ ì§ì§„í•©ë‹ˆë‹¤." },
            { u: 'E', v: 'G', distance: 22.3, time: 0.9, turn: "ì¢ŒíšŒì „", instruction: "íƒ‘ìŠ¹ ê²Œì´íŠ¸ë¥¼ ì§€ë‚˜ ë²„ìŠ¤ í„°ë¯¸ë„(G) ë°©í–¥ìœ¼ë¡œ ì¢ŒíšŒì „í•©ë‹ˆë‹¤." },
            
            // ì—­ë°©í–¥ ê²½ë¡œë„ í¬í•¨ (ê°„ë‹¨í™”ë¥¼ ìœ„í•´ ëŒ€ì¹­ì ìœ¼ë¡œ ê°€ì •)
            { u: 'B', v: 'A', distance: 16.7, time: 0.5, turn: "ì§ì§„", instruction: "ì¶œë°œ/ë„ì°© í™€(A) ë°©í–¥ìœ¼ë¡œ ì§ì§„í•©ë‹ˆë‹¤." },
            { u: 'C', v: 'B', distance: 22.3, time: 0.8, turn: "ì¢ŒíšŒì „", instruction: "ë©´ì„¸ êµ¬ì—­ì—ì„œ ë³´ì•ˆ ê²€ìƒ‰ëŒ€(B) ë°©í–¥ìœ¼ë¡œ ì¢ŒíšŒì „í•©ë‹ˆë‹¤." },
            { u: 'D', v: 'C', distance: 18.0, time: 0.6, turn: "ì§ì§„", instruction: "í™˜ìŠ¹ ë¼ìš´ì§€ì—ì„œ ë©´ì„¸ êµ¬ì—­(C)ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤." },
            { u: 'E', v: 'D', distance: 25.1, time: 1.0, turn: "ì¢ŒíšŒì „", instruction: "ê²Œì´íŠ¸(E)ë¥¼ ë‚˜ì™€ í™˜ìŠ¹ ë¼ìš´ì§€(D) ë°©í–¥ìœ¼ë¡œ ì¢ŒíšŒì „í•©ë‹ˆë‹¤." },
            { u: 'F', v: 'A', distance: 25.0, time: 0.8, turn: "ìš°íšŒì „", instruction: "í™€(A)ë¡œ ëŒì•„ì™€ì„œ ìš°íšŒì „í•©ë‹ˆë‹¤." },
            { u: 'H', v: 'A', distance: 22.3, time: 0.7, turn: "ì§ì§„", instruction: "í™€(A) ë°©í–¥ìœ¼ë¡œ ëŒì•„ì˜µë‹ˆë‹¤." },
            { u: 'H', v: 'C', distance: 16.7, time: 0.5, turn: "ì§ì§„", instruction: "ë©´ì„¸ êµ¬ì—­(C) ë°©í–¥ìœ¼ë¡œ ì§ì§„í•©ë‹ˆë‹¤." },
            { u: 'G', v: 'E', distance: 22.3, time: 0.9, turn: "ì§ì§„", instruction: "ë²„ìŠ¤ í„°ë¯¸ë„ì—ì„œ íƒ‘ìŠ¹ ê²Œì´íŠ¸(E) ë°©í–¥ìœ¼ë¡œ ì§ì§„í•©ë‹ˆë‹¤." }
        ];

        const TURN_ICONS = {
            'ì§ì§„': 'arrow-up', 'ìš°íšŒì „': 'corner-down-right', 'ì¢ŒíšŒì „': 'corner-down-left', 'ë„ì°©': 'map-pin'
        };
        
        // --- ì „ì—­ ìƒíƒœ ë³€ìˆ˜ ---
        let lastRouteData = null; 
        let currentStepIndex = 0; 
        let isNavigating = false; 
        let gpsWatchId = null; 
        let userGpsPosition = null; 
        const DISTANCE_THRESHOLD = 5; // ë¯¸í„° ë‹¨ìœ„, ë‹¤ìŒ ë…¸ë“œë¡œ ì „í™˜í•  ìµœì†Œ ê·¼ì ‘ ê±°ë¦¬ (5më¡œ ì¡°ì •)

        // **ìˆ˜ì • ì¶”ê°€**: í˜„ì‹¤ì ì¸ ì˜ˆìƒ ì‹œê°„ì„ ìœ„í•œ í‰ê·  ì†ë„ ì •ì˜ (5km/h)
        const AVERAGE_SPEED_MPS = 5000 / 3600; // 5 km/h â‰ˆ 1.39 m/s 

        // DOM ìš”ì†Œ ìºì‹±
        const startSelect = document.getElementById('start-area');
        const endSelect = document.getElementById('end-area');
        const outputDiv = document.getElementById('route-guidance-output');
        const searchButton = document.getElementById('search-button');
        const navBar = document.getElementById('navigation-bar');
        const navControlButton = document.getElementById('nav-control-button');
        const gpsStatusMessage = document.getElementById('gps-status-message');
        const stepsListDiv = document.getElementById('steps-list');
        const canvas = document.getElementById('route-map');
        const ctx = canvas.getContext('2d');
        const navInstruction = document.getElementById('nav-next-instruction');

        // Lat/Lon -> Canvas ì¢Œí‘œ ë³€í™˜ì„ ìœ„í•œ ë§µ ê²½ê³„ ê³„ì‚°
        const mapBounds = {
            minLat: Infinity, maxLat: -Infinity, minLon: Infinity, maxLon: -Infinity
        };
        
        AREA_IDS.forEach(id => {
            const coord = AREA_COORDINATES[id];
            mapBounds.minLat = Math.min(mapBounds.minLat, coord.lat);
            mapBounds.maxLat = Math.max(mapBounds.maxLat, coord.lat);
            mapBounds.minLon = Math.min(mapBounds.minLon, coord.lon);
            mapBounds.maxLon = Math.max(mapBounds.maxLon, coord.lon);
        });

        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---

        /**
         * Haversine ê³µì‹ì„ ì‚¬ìš©í•˜ì—¬ ë‘ ìœ„ê²½ë„ ì‚¬ì´ì˜ ê±°ë¦¬ë¥¼ ë¯¸í„°(m) ë‹¨ìœ„ë¡œ ê³„ì‚°í•©ë‹ˆë‹¤.
         */
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // ì§€êµ¬ ë°˜ê²½ (ë¯¸í„°)
            const Ï†1 = lat1 * Math.PI/180;
            const Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180;
            const Î”Î» = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // ë¯¸í„° ë‹¨ìœ„ ê±°ë¦¬
        }

        /**
         * ìœ„ê²½ë„ ì¢Œí‘œë¥¼ Canvasì˜ í”½ì…€ ì¢Œí‘œë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
         */
        function latLonToCanvas(lat, lon) {
            // Lat/Lon ë²”ìœ„ê°€ ë„ˆë¬´ ì‘ì„ ê²½ìš°, ë§µ ë“œë¡œì‰ ì‹œ í™•ëŒ€ë¥¼ ìœ„í•´ ì‘ì€ ìƒìˆ˜ ê°’ì„ ë”í•´ ì¤Œ
            const latRange = (mapBounds.maxLat - mapBounds.minLat) || 0.0000001; 
            const lonRange = (mapBounds.maxLon - mapBounds.minLon) || 0.0000001; 
            
            const padding = 0.1; // ë§µ ì—¬ë°±ì„ ìœ„í•œ ë¹„ìœ¨
            const drawWidth = canvas.width * (1 - 2 * padding);
            const drawHeight = canvas.height * (1 - 2 * padding);
            const offsetX = canvas.width * padding;
            const offsetY = canvas.height * padding;

            // X ì¢Œí‘œ ê³„ì‚° (ê²½ë„ - ë™ì„œ)
            const x = ((lon - mapBounds.minLon) / lonRange) * drawWidth + offsetX;
            
            // Y ì¢Œí‘œ ê³„ì‚° (ìœ„ë„ - ë‚¨ë¶)
            // ì§€ë„ì˜ ìœ„ìª½ì´ ì‘ì€ Yê°’(ë¶ìª½)ì´ ë˜ë„ë¡ ë’¤ì§‘ìŠµë‹ˆë‹¤.
            const y = drawHeight - (((lat - mapBounds.minLat) / latRange) * drawHeight) + offsetY;
            
            return { x, y };
        }
        
        // --- GPS ìœ„ì¹˜ ì¶”ì  ë¡œì§ (ë³€ê²½ ì—†ìŒ) ---

        /**
         * GPS ìœ„ì¹˜ ì¶”ì ì„ ì‹œì‘í•©ë‹ˆë‹¤.
         */
        function startGpsTracking() {
            if (!navigator.geolocation) {
                updateGpsStatus("error", "ì˜¤ë¥˜: ì´ ë¸Œë¼ìš°ì €ëŠ” GPS(Geolocation)ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                return;
            }

            if (gpsWatchId) {
                navigator.geolocation.clearWatch(gpsWatchId);
            }

            // GPS ìœ„ì¹˜ ì¶”ì  ì‹œì‘
            gpsWatchId = navigator.geolocation.watchPosition(
                handleGpsSuccess, 
                handleGpsError, 
                {
                    enableHighAccuracy: true, // ë†’ì€ ì •í™•ë„ ìš”êµ¬
                    timeout: 5000, 
                    maximumAge: 0 // ìºì‹œëœ ìœ„ì¹˜ ëŒ€ì‹  ìµœì‹  ìœ„ì¹˜ë¥¼ ìš”ì²­
                }
            );
            updateGpsStatus("ok", "GPS ì¶”ì  ì‹œì‘. ìœ„ì¹˜ ê¶Œí•œì„ ìŠ¹ì¸í•˜ê³  ì´ë™í•˜ì„¸ìš”.");
        }

        /**
         * GPS ìœ„ì¹˜ íšë“ ì„±ê³µ ì‹œ í˜¸ì¶œë˜ëŠ” ì½œë°± í•¨ìˆ˜.
         */
        function handleGpsSuccess(position) {
            const { latitude, longitude, accuracy } = position.coords;
            userGpsPosition = { lat: latitude, lon: longitude };
            
            // GPS ìƒíƒœ ì—…ë°ì´íŠ¸
            updateGpsStatus("ok", `í˜„ì¬ GPS ìœ„ì¹˜ ìˆ˜ì‹ ë¨. ì •í™•ë„: ${Math.round(accuracy)}m`);

            // ê²½ë¡œ ì•ˆë‚´ ì¤‘ì¼ ë•Œë§Œ ì—…ë°ì´íŠ¸ ë¡œì§ ì‹¤í–‰
            if (isNavigating && lastRouteData && lastRouteData.steps.length > currentStepIndex) {
                updateGpsPosition(userGpsPosition);
            }
            
            // ì‚¬ìš©ì ìœ„ì¹˜ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìœ¼ë¯€ë¡œ ë§µì„ ë‹¤ì‹œ ê·¸ë¦½ë‹ˆë‹¤.
            drawMap(); 
        }

        /**
         * GPS ìœ„ì¹˜ íšë“ ì‹¤íŒ¨ ì‹œ í˜¸ì¶œë˜ëŠ” ì½œë°± í•¨ìˆ˜.
         */
        function handleGpsError(error) {
            let message = "";
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    message = "ì˜¤ë¥˜: ìœ„ì¹˜ ì •ë³´ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. (ê¶Œí•œ í•„ìš”)";
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = "ì˜¤ë¥˜: ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (GPS ì‹ í˜¸ ë¶ˆëŸ‰)";
                    break;
                case error.TIMEOUT:
                    message = "ì˜¤ë¥˜: ìœ„ì¹˜ ì •ë³´ ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.";
                    break;
                default:
                    message = "ì•Œ ìˆ˜ ì—†ëŠ” GPS ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
            }
            updateGpsStatus("error", message);
            stopGpsTracking();
        }
        
        /**
         * GPS ìœ„ì¹˜ ì¶”ì ì„ ì¤‘ì§€í•©ë‹ˆë‹¤.
         */
        function stopGpsTracking() {
            if (gpsWatchId) {
                navigator.geolocation.clearWatch(gpsWatchId);
                gpsWatchId = null;
            }
            updateGpsStatus("error", "GPS ì¶”ì  ì¤‘ì§€ë¨. ë‚´ë¹„ê²Œì´ì…˜ ë¹„í™œì„±í™”.");
        }

        /**
         * ì‚¬ìš©ìì˜ ìµœì‹  GPS ìœ„ì¹˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‚´ë¹„ê²Œì´ì…˜ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function updateGpsPosition(currentGps) {
            if (!lastRouteData || !lastRouteData.steps || currentStepIndex >= lastRouteData.steps.length) {
                return; // ë‚´ë¹„ê²Œì´ì…˜ ì¢…ë£Œ ìƒíƒœ
            }

            const currentStep = lastRouteData.steps[currentStepIndex];
            // í˜„ì¬ ë‹¨ê³„ì˜ ëª©í‘œ ì§€ì  (ë‹¤ìŒ ë…¸ë“œ)
            const targetAreaId = currentStep.to_area;
            const targetGps = AREA_COORDINATES[targetAreaId];
            
            if (!targetGps) return;

            // 1. ëª©í‘œ ì§€ì ê¹Œì§€ì˜ ë‚¨ì€ ê±°ë¦¬ ê³„ì‚°
            const distanceToTarget = calculateDistance(
                currentGps.lat, currentGps.lon, 
                targetGps.lat, targetGps.lon
            );

            // 2. ë„¤ë¹„ê²Œì´ì…˜ ë°” ì—…ë°ì´íŠ¸
            updateNavigationBar(currentStep, distanceToTarget);
            highlightStep(currentStepIndex);

            // 3. ê·¼ì ‘ì„±(Proximity) í™•ì¸: ëª©í‘œ ì§€ì ì— ì¶©ë¶„íˆ ê°€ê¹Œì›Œì¡ŒëŠ”ì§€ í™•ì¸
            if (distanceToTarget < DISTANCE_THRESHOLD) {
                // ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™
                currentStepIndex++;

                // ìµœì¢… ë„ì°© í™•ì¸
                if (currentStepIndex >= lastRouteData.steps.length) {
                    handleArrival();
                    return;
                }
                
                // ë‹¤ìŒ ë‹¨ê³„ ì •ë³´ë¡œ ì—…ë°ì´íŠ¸
                const nextStep = lastRouteData.steps[currentStepIndex];
                // ë‹¤ìŒ ë‹¨ê³„ì˜ ëª©í‘œê¹Œì§€ì˜ ë‚¨ì€ ê±°ë¦¬ë¡œ ë„¤ë¹„ê²Œì´ì…˜ ë°” ì—…ë°ì´íŠ¸
                updateNavigationBar(nextStep, calculateDistance(currentGps.lat, currentGps.lon, AREA_COORDINATES[nextStep.to_area].lat, AREA_COORDINATES[nextStep.to_area].lon));
            }
        }
        
        // --- UI ë° ë§µ ë“œë¡œì‰ ë¡œì§ (ë³€ê²½ ì—†ìŒ) ---

        /**
         * ë§µì— êµ¬ì—­, ìµœì  ê²½ë¡œ, ì‚¬ìš©ì ìœ„ì¹˜ë¥¼ ì‹œê°í™”í•©ë‹ˆë‹¤.
         */
        function drawMap() {
            resizeCanvas(); 
            ctx.clearRect(0, 0, canvas.width, canvas.height); 
            
            const data = lastRouteData || {};
            const optimalPath = data.optimal_path_areas || [];

            // 1. ëª¨ë“  ì—°ê²°ì„  (Map Background) ê·¸ë¦¬ê¸°
            ctx.strokeStyle = '#e5e7eb'; 
            ctx.lineWidth = 2;
            ALL_CONNECTIONS.forEach(conn => {
                const start = latLonToCanvas(AREA_COORDINATES[conn.u].lat, AREA_COORDINATES[conn.u].lon);
                const end = latLonToCanvas(AREA_COORDINATES[conn.v].lat, AREA_COORDINATES[conn.v].lon);
                
                ctx.beginPath();
                ctx.moveTo(start.x, start.y);
                ctx.lineTo(end.x, end.y);
                ctx.stroke();
            });

            // 2. ìµœì  ê²½ë¡œ ì„  ê·¸ë¦¬ê¸°
            if (optimalPath.length > 1) {
                ctx.strokeStyle = '#ef4444'; 
                ctx.lineWidth = 5;
                ctx.lineCap = 'round';
                
                ctx.beginPath();
                let firstPoint = true;
                for (const areaId of optimalPath) {
                    const coord = latLonToCanvas(AREA_COORDINATES[areaId].lat, AREA_COORDINATES[areaId].lon);
                    if (firstPoint) {
                        ctx.moveTo(coord.x, coord.y);
                        firstPoint = false;
                    } else {
                        ctx.lineTo(coord.x, coord.y);
                    }
                }
                ctx.stroke();
            }

            // 3. ì‚¬ìš©ì ìœ„ì¹˜ ë§ˆì»¤ ê·¸ë¦¬ê¸° (ì‹¤ì œ GPS ìœ„ì¹˜)
            if (isNavigating && userGpsPosition) {
                const userCanvasCoord = latLonToCanvas(userGpsPosition.lat, userGpsPosition.lon);
                
                // ì‚¬ìš©ì ë§ˆì»¤ (ì´ˆë¡ìƒ‰ ì›)
                ctx.fillStyle = '#10b981'; 
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(userCanvasCoord.x, userCanvasCoord.y, 10, 0, Math.PI * 2);
                ctx.fill();
                ctx.stroke();
                
                // GPSê°€ ì¼œì ¸ ìˆì„ ë•Œ í˜„ì¬ ë‹¨ê³„ì˜ ëª©í‘œ ë…¸ë“œë¥¼ í‘œì‹œ
                if (currentStepIndex < lastRouteData.steps.length) {
                    const targetId = lastRouteData.steps[currentStepIndex].to_area;
                    const targetCoord = latLonToCanvas(AREA_COORDINATES[targetId].lat, AREA_COORDINATES[targetId].lon);
                    
                    // ëª©í‘œ ì§€ì ê¹Œì§€ ì ì„  í‘œì‹œ
                    ctx.strokeStyle = 'rgba(16, 185, 129, 0.5)';
                    ctx.setLineDash([5, 5]); 
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(userCanvasCoord.x, userCanvasCoord.y);
                    ctx.lineTo(targetCoord.x, targetCoord.y);
                    ctx.stroke();
                    ctx.setLineDash([]); // ì ì„  ì„¤ì • í•´ì œ
                }
            }
            
            // 4. ëª¨ë“  êµ¬ì—­ ë…¸ë“œì™€ ë¼ë²¨ ê·¸ë¦¬ê¸°
            const areaData = data.optimal_path_areas || [];
            AREA_IDS.forEach(id => {
                const coord = latLonToCanvas(AREA_COORDINATES[id].lat, AREA_COORDINATES[id].lon);
                
                const isStart = id === data.start_area_id;
                const isEnd = id === data.end_area_id;

                // ë…¸ë“œ ìƒ‰ìƒ ì„¤ì •
                if (isStart) {
                    ctx.fillStyle = '#3b82f6'; // íŒŒë€ìƒ‰ (Start)
                } else if (isEnd) {
                    ctx.fillStyle = '#ef4444'; // ë¹¨ê°„ìƒ‰ (End)
                } else {
                    ctx.fillStyle = '#9ca3af'; // íšŒìƒ‰ (Other)
                }
                
                // ë…¸ë“œ ì› ê·¸ë¦¬ê¸°
                ctx.beginPath();
                ctx.arc(coord.x, coord.y, isStart || isEnd ? 8 : 5, 0, Math.PI * 2);
                ctx.fill();
                
                // ë…¸ë“œ ë¼ë²¨ í…ìŠ¤íŠ¸
                ctx.fillStyle = '#1f2937';
                ctx.font = `12px Inter`;
                ctx.textAlign = 'center';
                
                // ë¼ë²¨ ìœ„ì¹˜ ì¡°ì • (ê°„ë‹¨í™”)
                ctx.fillText(`${id}`, coord.x, coord.y - 15);
            });
        }

        // --- ê²½ë¡œ ê²€ìƒ‰ (Dijkstra, ë³€ê²½ ì—†ìŒ) ---

        function findOptimalRoute(startNode, endNode) {
            const distances = {};
            const previousNodes = {};
            const priorityQueue = new Set();
            
            AREA_IDS.forEach(id => {
                distances[id] = Infinity;
                previousNodes[id] = null;
            });

            distances[startNode] = 0;
            priorityQueue.add(startNode);

            const getMinNode = () => {
                let minTime = Infinity;
                let minNode = null;
                priorityQueue.forEach(node => {
                    if (distances[node] < minTime) {
                        minTime = distances[node];
                        minNode = node;
                    }
                });
                return minNode;
            };

            while (priorityQueue.size > 0) {
                const currentNode = getMinNode();
                if (!currentNode) break;

                priorityQueue.delete(currentNode);

                if (currentNode === endNode) break;

                const neighbors = ALL_CONNECTIONS.filter(conn => conn.u === currentNode);

                for (const neighbor of neighbors) {
                    const nextNode = neighbor.v;
                    const travelTime = neighbor.time;
                    const newTime = distances[currentNode] + travelTime;

                    if (newTime < distances[nextNode]) {
                        distances[nextNode] = newTime;
                        previousNodes[nextNode] = currentNode;
                        priorityQueue.add(nextNode);
                    }
                }
            }

            let path = [];
            let currentNode = endNode;
            while (currentNode) {
                path.unshift(currentNode);
                currentNode = previousNodes[currentNode];
                // DijkstraëŠ” ì‹œì‘ ë…¸ë“œë§Œ ë”°ë¡œ ì˜ˆì™¸ ì²˜ë¦¬í•  í•„ìš” ì—†ì´ ë£¨í”„ë¥¼ ëŒì§€ë§Œ,
                // ì´ì „ì— êµ¬í˜„ëœ ë¡œì§ì„ ìœ ì§€í•˜ê¸° ìœ„í•´ (startNodeê°€ previousNodesì— ì—†ëŠ” ê²½ìš°ë¥¼ ëŒ€ë¹„)
                 if (currentNode === startNode) { 
                    path.unshift(startNode);
                    break;
                 }
                 if (!currentNode && path[0] === startNode) break; // ì‹œì‘ ë…¸ë“œì—ì„œ ë©ˆì·„ì„ ë•Œ
                 if (!currentNode && path.length > 0) break; // ê²½ë¡œê°€ ì—°ê²°ë˜ì§€ ì•Šì€ ê²½ìš°
                 if (!currentNode) break; // ì‹œì‘ ë…¸ë“œì— ë„ë‹¬í•˜ì§€ ëª»í•œ ê²½ìš°
            }

            // ê²½ë¡œ ë³µì› í›„ ì¬í™•ì¸
            if (path[0] !== startNode || path[path.length - 1] !== endNode) {
                // ë‹¤ìµìŠ¤íŠ¸ë¼ê°€ ê²½ë¡œë¥¼ ì°¾ì§€ ëª»í–ˆê±°ë‚˜ ì‹œì‘ ë…¸ë“œë¥¼ í¬í•¨í•˜ì§€ ì•Šì€ ê²½ìš°
                return { total_time_min: Infinity, optimal_path_areas: [] };
            }
            
            return { total_time_min: distances[endNode], optimal_path_areas: path };
        }

        function createRouteGuidance(optimalPath, totalTime) {
            if (!optimalPath || optimalPath.length < 2) return { steps: [], total_distance_m: 0, total_time_min: 0 };
            
            const steps = [];
            let totalDistance = 0;
            
            for (let i = 0; i < optimalPath.length - 1; i++) {
                const from_area = optimalPath[i];
                const to_area = optimalPath[i+1];
                
                const connection = ALL_CONNECTIONS.find(conn => conn.u === from_area && conn.v === to_area);
                if (!connection) continue;
                
                const { distance, time, turn, instruction } = connection;
                totalDistance += distance;

                const is_last_step = (i === optimalPath.length - 2);
                const final_turn_type = is_last_step ? "ë„ì°©" : turn;
                const final_instruction = is_last_step 
                    ? `ìµœì¢… ëª©ì ì§€ì¸ ${AREA_NAMES[to_area]}ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤. ê²½ë¡œ ì•ˆë‚´ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.` 
                    : `${instruction} í›„ ${AREA_NAMES[to_area]} ë°©í–¥ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.`;
                
                steps.push({
                    "step_id": i + 1,
                    "from_area": from_area,
                    "to_area": to_area,
                    "distance_m": distance,
                    "travel_time_min": time, // UIì— í‘œì‹œí•  ì˜ˆìƒ ì‹œê°„ì€ ë™ì  ê³„ì‚°ë˜ì§€ë§Œ, ì´ ì‹œê°„ ê³„ì‚°ì„ ìœ„í•´ ìœ ì§€
                    "turn_type": final_turn_type,
                    "detailed_instruction": final_instruction
                });
            }
            
            return { steps: steps, total_distance_m: totalDistance, total_time_min: totalTime };
        }
        
        // --- ì£¼ìš” ë¡œì§ í•¨ìˆ˜ (ë³€ê²½ ì—†ìŒ) ---

        /**
         * ê²½ë¡œ ê²€ìƒ‰ ë° ë‚´ë¹„ê²Œì´ì…˜ ë°ì´í„° ì¤€ë¹„
         */
        function startRouteGuidance() {
            if (isNavigating) stopNavigation(); // ê¸°ì¡´ ë‚´ë¹„ê²Œì´ì…˜ ì¤‘ì§€

            const startId = startSelect.value;
            const endId = endSelect.value;
            
            if (startId === endId) {
                outputDiv.innerHTML = `<div class="p-4 bg-yellow-100 rounded-lg text-yellow-700">ì¶œë°œì§€ì™€ ë„ì°©ì§€ê°€ ë™ì¼í•©ë‹ˆë‹¤.</div>`;
                navBar.classList.remove('active');
                return;
            }

            // UI ìƒíƒœ ì—…ë°ì´íŠ¸
            searchButton.disabled = true;
            searchButton.innerText = 'ê²½ë¡œ ê³„ì‚° ì¤‘...';

            // 1. ìµœì  ê²½ë¡œ ê³„ì‚°
            const { total_time_min, optimal_path_areas } = findOptimalRoute(startId, endId);
            
            if (total_time_min === Infinity) {
                outputDiv.innerHTML = `<div class="p-4 bg-red-100 rounded-lg text-red-700">ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!</div>`;
                searchButton.disabled = false;
                searchButton.innerText = 'ê²½ë¡œ ê²€ìƒ‰ ë° ë‚´ë¹„ê²Œì´ì…˜ ì¤€ë¹„';
                navBar.classList.remove('active');
                return;
            }

            // 2. ìƒì„¸ ì•ˆë‚´ ë‹¨ê³„ ìƒì„±
            const { steps, total_distance_m } = createRouteGuidance(optimal_path_areas, total_time_min);
            
            lastRouteData = {
                start_area_id: startId,
                end_area_id: endId,
                optimal_path_areas: optimal_path_areas,
                total_time_min: Math.ceil(total_time_min), // ì´ ì‹œê°„ì€ ë¶„ ë‹¨ìœ„ë¡œ ì˜¬ë¦¼í•˜ì—¬ í‘œì‹œ
                total_distance_m: total_distance_m,
                steps: steps
            };
            
            currentStepIndex = 0;
            
            renderGuidanceSummary(lastRouteData);
            renderStepsList(lastRouteData.steps);
            drawMap(); 
            
            navBar.classList.add('active'); 
            navControlButton.innerText = 'GPS ë‚´ë¹„ ì‹œì‘';
            navControlButton.disabled = false;
            navControlButton.classList.remove('bg-yellow-500', 'bg-blue-600');
            navControlButton.classList.add('bg-green-500');
            
            searchButton.disabled = false;
            searchButton.innerText = 'ê²½ë¡œ ê²€ìƒ‰ ë° ë‚´ë¹„ê²Œì´ì…˜ ì¤€ë¹„';
        }
        
        /**
         * ë‚´ë¹„ê²Œì´ì…˜ ì‹œì‘/ì¤‘ì§€ í† ê¸€
         */
        function toggleNavigation() {
            if (!lastRouteData) return;
            
            if (navControlButton.innerText === 'ê²½ë¡œ ì¬ì„¤ì •') {
                resetApp();
                return;
            }
            
            if (isNavigating) {
                stopNavigation();
            } else {
                startNavigation();
            }
        }

        /**
         * ë‚´ë¹„ê²Œì´ì…˜ ì‹œì‘
         */
        function startNavigation() {
            isNavigating = true;
            navControlButton.innerText = 'GPS ë‚´ë¹„ ì¤‘ì§€';
            navControlButton.classList.remove('bg-green-500');
            navControlButton.classList.add('bg-yellow-500');
            
            // GPS ì¶”ì  ì‹œì‘ (ì‹¤ì œ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ê°€ ì—¬ê¸°ì„œë¶€í„° ì‹œì‘)
            startGpsTracking();

            // ì‹œì‘ ì‹œ í˜„ì¬ ë‹¨ê³„ ì •ë³´ ì—…ë°ì´íŠ¸ (ì²« ë²ˆì§¸ ë‹¨ê³„)
            if (currentStepIndex < lastRouteData.steps.length) {
                // ì´ˆê¸° ê±°ë¦¬ì™€ ì‹œê°„ì€ GPS ì—…ë°ì´íŠ¸ë¥¼ í†µí•´ ê³§ ê³„ì‚°ë  ê²ƒì´ë¯€ë¡œ 0ìœ¼ë¡œ ì„¤ì •
                updateNavigationBar(lastRouteData.steps[currentStepIndex], 0); 
                highlightStep(currentStepIndex);
            }
        }
        
        /**
         * ë‚´ë¹„ê²Œì´ì…˜ ì¤‘ì§€
         */
        function stopNavigation() {
            isNavigating = false;
            navControlButton.innerText = 'GPS ë‚´ë¹„ ì¬ê°œ';
            navControlButton.classList.remove('bg-yellow-500');
            navControlButton.classList.add('bg-green-500');
            
            // GPS ì¶”ì  ì¤‘ì§€
            stopGpsTracking();
        }

        /**
         * ìµœì¢… ë„ì°© ì²˜ë¦¬
         */
        function handleArrival() {
            stopNavigation(); // GPS ì¶”ì  ì¤‘ì§€
            navInstruction.textContent = `ë„ì°©! ${AREA_NAMES[lastRouteData.end_area_id]}ì— ë„ì°©í•˜ì…¨ìŠµë‹ˆë‹¤.`;
            document.getElementById('nav-step-info').textContent = 'ê²½ë¡œ ì•ˆë‚´ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
            navControlButton.innerText = 'ê²½ë¡œ ì¬ì„¤ì •';
            navControlButton.classList.remove('bg-yellow-500', 'bg-green-500');
            navControlButton.classList.add('bg-blue-600');
            navControlButton.disabled = false;
            document.getElementById('current-turn-icon').innerHTML = `<i data-lucide="check-circle" class="w-8 h-8"></i>`;
            highlightStep(currentStepIndex - 1, true); 
            updateGpsStatus("ok", "ì„±ê³µì ìœ¼ë¡œ ëª©ì ì§€ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤.");
            lucide.createIcons();
        }


        // --- UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ---
        
        function updateGpsStatus(type, message) {
            gpsStatusMessage.textContent = `GPS ìƒíƒœ: ${message}`;
            gpsStatusMessage.classList.remove('gps-status-ok', 'gps-status-err');
            if (type === 'ok') {
                gpsStatusMessage.classList.add('gps-status-ok');
            } else {
                gpsStatusMessage.classList.add('gps-status-err');
            }
        }

        function renderGuidanceSummary(data) {
            const pathSummary = data.optimal_path_areas.map(id => AREA_NAMES[id]).join(' â†’ ');

            outputDiv.innerHTML = `
                <div class="mb-4 p-4 bg-blue-50 border-b border-blue-200 rounded-lg">
                    <p class="text-md text-gray-700 font-semibold">
                        <span class="text-green-700">ì¶œë°œì§€: ${AREA_NAMES[data.start_area_id]}</span>
                        <span class="mx-3 text-gray-400">|</span>
                        <span class="text-red-700">ìµœì¢… ëª©ì ì§€: ${AREA_NAMES[data.end_area_id]}</span>
                    </p>
                    <p class="text-2xl font-extrabold text-gray-900 mt-2">
                        ì´ ì˜ˆìƒ ì†Œìš” ì‹œê°„: <span class="text-blue-600">${data.total_time_min}ë¶„</span>
                        <span class="text-lg font-medium text-gray-500">(${Math.round(data.total_distance_m)}m)</span>
                    </p>
                    <p class="text-sm text-gray-500 mt-1 truncate">ê²½ë¡œ ìš”ì•½: ${pathSummary}</p>
                </div>
            `;
            // í•˜ë‹¨ ë‚´ë¹„ê²Œì´ì…˜ ë°” ì´ˆê¸°í™”
            document.getElementById('nav-next-instruction').textContent = 'GPS ë‚´ë¹„ê²Œì´ì…˜ì„ ì‹œì‘í•´ ì£¼ì„¸ìš”.';
            document.getElementById('nav-step-info').textContent = `ì´ ê±°ë¦¬: ${Math.round(data.total_distance_m)}m | ì´ ì‹œê°„: ${data.total_time_min}ë¶„`;
            document.getElementById('current-turn-icon').innerHTML = `<i data-lucide="compass" class="w-8 h-8"></i>`;
            lucide.createIcons();
        }

        function renderStepsList(steps) {
            let stepsHtml = '';
            steps.forEach((step, index) => {
                const iconName = TURN_ICONS[step.turn_type] || TURN_ICONS['ì§ì§„'];
                const iconColor = step.turn_type === 'ë„ì°©' ? 'text-green-600' : 'text-blue-600';
                
                // ìƒì„¸ ì§€ì¹¨ ëª©ë¡ì—ì„œëŠ” ê²½ë¡œ ê³„ì‚° ì‹œ ì‚¬ìš©ëœ ê³ ì • ì‹œê°„ì„ í‘œì‹œ
                stepsHtml += `
                    <div id="step-${index}" class="flex items-start mb-4 p-3 bg-white rounded-lg border-l-4 border-gray-200 transition duration-100">
                        <div class="flex-shrink-0 text-2xl font-bold mr-4 p-2 rounded-full bg-gray-50 shadow ${iconColor}">
                            <i data-lucide="${iconName}" class="w-5 h-5"></i>
                        </div>
                        <div class="flex-grow">
                            <p class="font-semibold text-md text-gray-800 leading-snug">${step.detailed_instruction}</p>
                            <p class="text-xs text-gray-500 mt-1">
                                ${AREA_NAMES[step.from_area]} â†’ ${AREA_NAMES[step.to_area]} (${step.travel_time_min}ë¶„, ${Math.round(step.distance_m)}m)
                            </p>
                        </div>
                    </div>
                `;
            });
            stepsListDiv.innerHTML = stepsHtml;
            stepsListDiv.classList.remove('hidden');
            lucide.createIcons();
        }
        
        /**
         * ë„¤ë¹„ê²Œì´ì…˜ ë°”ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤. (ê°€ì¥ ì¤‘ìš”í•œ ìˆ˜ì • ë¶€ë¶„)
         */
        function updateNavigationBar(step, distanceToTarget) {
            navInstruction.textContent = step.detailed_instruction;
            
            // **ìˆ˜ì •ëœ ë¡œì§**: ë‚¨ì€ ê±°ë¦¬ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë™ì  ë‚¨ì€ ì‹œê°„ ê³„ì‚°
            const remainingTimeSeconds = distanceToTarget / AVERAGE_SPEED_MPS; // ì´ˆ ë‹¨ìœ„
            const remainingTimeMinutes = Math.max(1, Math.ceil(remainingTimeSeconds / 60)); // ìµœì†Œ 1ë¶„, ë¶„ ë‹¨ìœ„ë¡œ ì˜¬ë¦¼

            if (step.turn_type === 'ë„ì°©') {
                 document.getElementById('nav-step-info').textContent = 'ëª©ì ì§€ì— ê±°ì˜ ë„ì°©í–ˆìŠµë‹ˆë‹¤.';
            } else {
                 // ë‚¨ì€ ê±°ë¦¬ì— ë¹„ë¡€í•˜ì—¬ ê³„ì‚°ëœ ë‚¨ì€ ì‹œê°„ì„ í‘œì‹œ
                 document.getElementById('nav-step-info').textContent = `ë‹¤ìŒ ì§€ì ê¹Œì§€ ${Math.round(distanceToTarget)}m ë‚¨ìŒ | ì•½ ${remainingTimeMinutes}ë¶„ ì˜ˆìƒ`;
            }

            const iconName = TURN_ICONS[step.turn_type] || TURN_ICONS['ì§ì§„'];
            document.getElementById('current-turn-icon').innerHTML = `<i data-lucide="${iconName}" class="w-8 h-8"></i>`;
            lucide.createIcons();
        }

        function highlightStep(index, isFinal = false) {
            document.querySelectorAll('#steps-list > div').forEach((el, i) => {
                el.classList.remove('bg-blue-100', 'border-blue-500', 'bg-green-100', 'border-green-500');
                if (i === index) {
                    if (isFinal) {
                        el.classList.add('bg-green-100', 'border-green-500');
                    } else {
                        el.classList.add('bg-blue-100', 'border-blue-500');
                    }
                    el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            });
        }
        
        function resetApp() {
            stopGpsTracking();
            lastRouteData = null;
            isNavigating = false;
            currentStepIndex = 0;
            userGpsPosition = null;
            drawMap();
            navBar.classList.remove('active');
            outputDiv.innerHTML = `<p class="text-gray-500">ì§€ë„ë¥¼ ì‹œê°í™”í•˜ê¸° ìœ„í•´ ì¶œë°œì§€ ë° ë„ì°©ì§€ë¥¼ ì„¤ì •í•˜ê³  ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>`;
            stepsListDiv.classList.add('hidden');
            navControlButton.innerText = 'GPS ë‚´ë¹„ ì‹œì‘';
            navControlButton.disabled = true;
            navControlButton.classList.remove('bg-yellow-500', 'bg-blue-600');
            navControlButton.classList.add('bg-green-500');
            document.getElementById('current-turn-icon').innerHTML = `<i data-lucide="compass" class="w-8 h-8"></i>`;
            updateGpsStatus("error", "ë‚´ë¹„ê²Œì´ì…˜ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ê²½ë¡œë¥¼ ë‹¤ì‹œ ê²€ìƒ‰í•´ ì£¼ì„¸ìš”.");
            lucide.createIcons();
        }
        
        // --- ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ë³€ê²½ ì—†ìŒ) ---

        function populateAreaSelects() {
            AREA_IDS.forEach(id => {
                const name = AREA_NAMES[id];
                startSelect.insertAdjacentHTML('beforeend', `<option value="${id}">${id}: ${name}</option>`);
                endSelect.insertAdjacentHTML('beforeend', `<option value="${id}">${id}: ${name}</option>`);
            });
            startSelect.value = 'A'; 
            endSelect.value = 'E'; 
        }

        function resizeCanvas() {
            const containerWidth = canvas.parentElement.clientWidth;
            canvas.width = Math.min(containerWidth, 700); 
            canvas.height = canvas.width * (400 / 700); 
            if (canvas.height < 250) canvas.height = 250; 
        }

        window.onload = function() {
            populateAreaSelects();
            resizeCanvas(); 
            drawMap(); 
            document.getElementById('current-turn-icon').innerHTML = `<i data-lucide="compass" class="w-8 h-8"></i>`;
            updateGpsStatus("error", "ë‚´ë¹„ê²Œì´ì…˜ì„ ì‹œì‘í•˜ë ¤ë©´ 'GPS ë‚´ë¹„ ì‹œì‘'ì„ ëˆ„ë¥´ì„¸ìš”.");
            lucide.createIcons();

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
            searchButton.addEventListener('click', startRouteGuidance);
            navControlButton.addEventListener('click', toggleNavigation);
        };

        window.addEventListener('resize', drawMap); 
    </script>
</body>
</html>