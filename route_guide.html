<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìŠ¤ë§ˆíŠ¸ ê³µí•­ ë‚´ë¹„ê²Œì´ì…˜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f3f4f6;
            touch-action: none; /* ì§€ë„ ì¡°ì‘ì„ ìœ„í•´ ìŠ¤í¬ë¡¤ ë°©ì§€ */
            overflow: hidden; /* ì „ì²´ í™”ë©´ ê³ ì • */
        }
        
        /* ì§€ë„ ì»¨í…Œì´ë„ˆ: í™”ë©´ ì „ì²´ ì°¨ì§€ */
        #map-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background-color: #e5e7eb;
        }
        
        /* ìƒë‹¨ ë°” */
        #top-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(4px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 10px 16px;
            border-bottom-left-radius: 16px;
            border-bottom-right-radius: 16px;
        }

        /* í•˜ë‹¨ íŒ¨ë„ (ì„¤ì • ë° ì•ˆë‚´) */
        #bottom-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 20;
            background: white;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            padding: 24px 20px 30px 20px;
            transition: transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        
        /* ì¤Œ ì»¨íŠ¸ë¡¤ */
        .zoom-controls {
            position: absolute;
            top: 50%;
            right: 16px;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 10;
        }
        
        .zoom-btn {
            width: 48px;
            height: 48px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            color: #4b5563;
            font-size: 24px;
            transition: all 0.2s;
        }
        .zoom-btn:active {
            background-color: #f3f4f6;
            transform: scale(0.95);
        }

        /* í„´ ì•„ì´ì½˜ */
        .turn-icon-box {
            width: 64px;
            height: 64px;
            border-radius: 16px;
            background-color: #3b82f6;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(2); opacity: 0; }
        }
    </style>
</head>
<body>

    <!-- ìƒë‹¨ í—¤ë” (ê²€ìƒ‰ ëª¨ë“œì¼ ë•Œë§Œ í‘œì‹œ) -->
    <div id="top-bar" class="flex justify-between items-center">
        <div class="flex items-center gap-2">
            <div class="bg-blue-100 p-2 rounded-full text-blue-600">
                <i data-lucide="map-pin" class="w-5 h-5"></i>
            </div>
            <div>
                <h1 class="text-sm font-bold text-slate-800">ê³µí•­ ì‹¤ë‚´ ë‚´ë¹„ê²Œì´ì…˜</h1>
                <p id="status-text" class="text-xs text-slate-500">ê²½ë¡œë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”</p>
            </div>
        </div>
        <div id="gps-badge" class="px-2 py-1 rounded bg-gray-100 text-xs font-bold text-gray-400">
            GPS ëŒ€ê¸°
        </div>
    </div>

    <!-- ì§€ë„ ì˜ì—­ -->
    <div id="map-container">
        <canvas id="nav-canvas"></canvas>
    </div>

    <!-- ì¤Œ ì»¨íŠ¸ë¡¤ -->
    <div class="zoom-controls">
        <button class="zoom-btn" onclick="handleZoom(1.2)">
            <i data-lucide="plus" class="w-6 h-6"></i>
        </button>
        <button class="zoom-btn" onclick="handleZoom(0.8)">
            <i data-lucide="minus" class="w-6 h-6"></i>
        </button>
        <button class="zoom-btn" onclick="resetView()">
            <i data-lucide="refresh-ccw" class="w-5 h-5"></i>
        </button>
    </div>

    <!-- í•˜ë‹¨ íŒ¨ë„ -->
    <div id="bottom-panel">
        
        <!-- 1. ì„¤ì • ëª¨ë“œ (ì´ˆê¸° í™”ë©´) -->
        <div id="setup-mode">
            <div class="space-y-4">
                <div class="flex gap-3">
                    <div class="w-1/2">
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">ì¶œë°œì§€</label>
                        <!-- QRë¡œ ì¸ì‹ë˜ì–´ë„ ìˆ˜ì • ê°€ëŠ¥í•˜ë„ë¡ disabled ì œê±° -->
                        <select id="start-select" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm font-bold text-gray-800 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none appearance-none"></select>
                    </div>
                    <div class="w-1/2">
                        <label class="block text-xs font-bold text-gray-500 mb-1 ml-1">ë„ì°©ì§€</label>
                        <select id="end-select" class="w-full p-3 bg-white border border-gray-300 rounded-xl text-sm font-medium text-gray-800 focus:ring-2 focus:ring-blue-500 outline-none"></select>
                    </div>
                </div>
                
                <button onclick="calculateRoute()" id="calc-btn" class="w-full py-4 bg-slate-800 hover:bg-slate-900 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-all flex justify-center items-center gap-2 text-lg">
                    ê²½ë¡œ ê²€ìƒ‰
                </button>
            </div>
        </div>

        <!-- 2. ë‚´ë¹„ê²Œì´ì…˜ ì¤€ë¹„ ëª¨ë“œ (ê²½ë¡œ í™•ì¸) -->
        <div id="preview-mode" class="hidden space-y-4">
            <div class="flex justify-between items-center pb-4 border-b border-gray-100">
                <div>
                    <p class="text-xs text-gray-500 font-medium">ì´ ì˜ˆìƒ ì†Œìš”ì‹œê°„</p>
                    <p class="text-2xl font-extrabold text-slate-800" id="preview-time">0ë¶„</p>
                </div>
                <div class="text-right">
                    <p class="text-xs text-gray-500 font-medium">ì´ ê±°ë¦¬</p>
                    <p class="text-lg font-bold text-slate-800" id="preview-dist">0m</p>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="cancelRoute()" class="w-1/3 py-3.5 bg-gray-100 text-gray-600 font-bold rounded-xl active:scale-95">
                    ì·¨ì†Œ
                </button>
                <button onclick="startNavigation()" class="w-2/3 py-3.5 bg-blue-600 text-white font-bold rounded-xl shadow-lg active:scale-95 shadow-blue-200">
                    ì•ˆë‚´ ì‹œì‘ ğŸš€
                </button>
            </div>
        </div>

        <!-- 3. ì£¼í–‰ ëª¨ë“œ (ì‹¤ì‹œê°„ ì•ˆë‚´) -->
        <div id="driving-mode" class="hidden">
            <div class="flex items-center gap-5 mb-6">
                <!-- í„´ ì•„ì´ì½˜ -->
                <div class="turn-icon-box shrink-0">
                    <i id="turn-icon" data-lucide="arrow-up" class="w-8 h-8"></i>
                </div>
                
                <!-- ì•ˆë‚´ í…ìŠ¤íŠ¸ -->
                <div class="overflow-hidden">
                    <h3 id="nav-instruction" class="text-xl font-bold text-slate-900 leading-tight mb-1">
                        ì•ˆë‚´ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤
                    </h3>
                    <p id="nav-sub-text" class="text-base text-blue-600 font-semibold">
                        ì ì‹œ í›„ ì´ë™
                    </p>
                </div>
            </div>
            
            <button onclick="stopNavigation()" class="w-full py-3 bg-white border-2 border-red-100 text-red-500 font-bold rounded-xl hover:bg-red-50 active:scale-95 transition-colors">
                ì•ˆë‚´ ì¢…ë£Œ
            </button>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:5000'; // ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš©
        // const API_BASE = 'https://your-server-url.com'; // ì‹¤ì œ ë°°í¬ ì‹œ ë³€ê²½

        // ë§µ ë°ì´í„° (ê°€ìƒ ì¢Œí‘œê³„ 0~1000)
        const NODES = {
            'A': { name: 'ì¶œë°œ/ë„ì°© í™€', x: 100, y: 850 },
            'B': { name: 'ë³´ì•ˆ ê²€ìƒ‰ëŒ€', x: 300, y: 750 },
            'C': { name: 'ë©´ì„¸ êµ¬ì—­', x: 500, y: 500 },
            'D': { name: 'í™˜ìŠ¹ ë¼ìš´ì§€', x: 700, y: 500 },
            'E': { name: 'íƒ‘ìŠ¹ ê²Œì´íŠ¸', x: 900, y: 250 },
            'F': { name: 'ì‹¤ì™¸ ì£¼ì°¨ì¥', x: 100, y: 250 },
            'G': { name: 'ë²„ìŠ¤ í„°ë¯¸ë„', x: 300, y: 250 },
            'H': { name: 'ì§€í•˜ì²  ì—°ê²°', x: 500, y: 900 }
        };
        
        const EDGES = [
            { u: 'A', v: 'B' }, { u: 'A', v: 'F' }, { u: 'A', v: 'H' },
            { u: 'B', v: 'C' }, { u: 'C', v: 'D' }, { u: 'C', v: 'H' },
            { u: 'D', v: 'E' }, { u: 'E', v: 'G' }, { u: 'F', v: 'G' }
        ];

        const TURN_ICONS = {
            'ì§ì§„': 'arrow-up', 
            'ìš°íšŒì „': 'corner-up-right', 
            'ì¢ŒíšŒì „': 'corner-up-left', 
            'ë„ì°©': 'map-pin'
        };

        // --- ìƒíƒœ ë³€ìˆ˜ ---
        let ctx, canvas;
        // ë·°í¬íŠ¸ ìƒíƒœ (ì¤Œ/ì´ë™)
        let view = { x: 0, y: 0, scale: 1 };
        let isDragging = false;
        let lastTouch = { x: 0, y: 0 };

        let routeData = null;
        let isNavigating = false;
        let currentStepIdx = 0;
        let userPos = { x: 0, y: 0 }; // ìº”ë²„ìŠ¤ ì¢Œí‘œê³„ìƒ ë‚´ ìœ„ì¹˜
        
        // ì‹œë®¬ë ˆì´ì…˜ ë³€ìˆ˜
        let simInterval = null;
        let simProgress = 0; // 0.0 ~ 1.0 (í˜„ì¬ ìŠ¤í… ë‚´ ì§„í–‰ë¥ )

        // --- ì´ˆê¸°í™” ---
        window.onload = () => {
            canvas = document.getElementById('nav-canvas');
            ctx = canvas.getContext('2d');
            
            // ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
            const startSel = document.getElementById('start-select');
            const endSel = document.getElementById('end-select');
            
            Object.keys(NODES).forEach(key => {
                startSel.add(new Option(`${key}. ${NODES[key].name}`, key));
                endSel.add(new Option(`${key}. ${NODES[key].name}`, key));
            });

            // QR ì½”ë“œ íŒŒë¼ë¯¸í„° ì²˜ë¦¬
            const params = new URLSearchParams(window.location.search);
            const qrLoc = params.get('scanned_location');
            
            if (qrLoc && NODES[qrLoc]) {
                startSel.value = qrLoc;
                document.getElementById('status-text').innerText = "QR ìœ„ì¹˜ ì¸ì‹ë¨ (ë³€ê²½ ê°€ëŠ¥)";
                document.getElementById('status-text').className = "text-xs text-green-600 font-bold";
            } else {
                startSel.value = 'A';
                endSel.value = 'E'; // ê¸°ë³¸ê°’
            }

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ë“œë˜ê·¸/ì¤Œ)
            setupCanvasEvents();
            window.addEventListener('resize', resizeCanvas);
            
            resizeCanvas();
            resetView();
            lucide.createIcons();
            
            // ë Œë”ë§ ë£¨í”„ ì‹œì‘
            requestAnimationFrame(render);
        };

        function resizeCanvas() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
        }

        function resetView() {
            // ë§µ ì „ì²´ê°€ ë³´ì´ë„ë¡ ì¤Œ ë¦¬ì…‹
            view.scale = canvas.width / 1200; // ëŒ€ëµì ì¸ ë¹„ìœ¨
            if (view.scale > 1) view.scale = 1;
            if (view.scale < 0.5) view.scale = 0.5;
            
            // ì¤‘ì•™ ì •ë ¬
            view.x = (canvas.width - 1000 * view.scale) / 2;
            view.y = (canvas.height - 1000 * view.scale) / 2;
        }

        function handleZoom(factor) {
            const newScale = view.scale * factor;
            if (newScale > 0.2 && newScale < 5) {
                // í™”ë©´ ì¤‘ì‹¬ ê¸°ì¤€ìœ¼ë¡œ ì¤Œ
                const cx = canvas.width / 2;
                const cy = canvas.height / 2;
                view.x = cx - (cx - view.x) * factor;
                view.y = cy - (cy - view.y) * factor;
                view.scale = newScale;
            }
        }

        // --- ìº”ë²„ìŠ¤ ì´ë²¤íŠ¸ (ë“œë˜ê·¸ ì´ë™) ---
        function setupCanvasEvents() {
            const handleStart = (x, y) => {
                isDragging = true;
                lastTouch = { x, y };
            };
            const handleMove = (x, y) => {
                if (!isDragging) return;
                view.x += x - lastTouch.x;
                view.y += y - lastTouch.y;
                lastTouch = { x, y };
            };
            const handleEnd = () => { isDragging = false; };

            // ë§ˆìš°ìŠ¤
            canvas.addEventListener('mousedown', e => handleStart(e.offsetX, e.offsetY));
            canvas.addEventListener('mousemove', e => handleMove(e.offsetX, e.offsetY));
            window.addEventListener('mouseup', handleEnd);

            // í„°ì¹˜
            canvas.addEventListener('touchstart', e => {
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                handleStart(touch.clientX - rect.left, touch.clientY - rect.top);
            });
            canvas.addEventListener('touchmove', e => {
                e.preventDefault(); // ìŠ¤í¬ë¡¤ ë°©ì§€
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                handleMove(touch.clientX - rect.left, touch.clientY - rect.top);
            });
            window.addEventListener('touchend', handleEnd);
        }

        // --- 1ë‹¨ê³„: ê²½ë¡œ ê³„ì‚° (API í˜¸ì¶œ) ---
        async function calculateRoute() {
            const start = document.getElementById('start-select').value;
            const end = document.getElementById('end-select').value;

            if (start === end) return alert("ì¶œë°œì§€ì™€ ë„ì°©ì§€ê°€ ê°™ìŠµë‹ˆë‹¤.");

            const btn = document.getElementById('calc-btn');
            btn.disabled = true;
            btn.innerText = "ê³„ì‚° ì¤‘...";

            try {
                // API í˜¸ì¶œ
                const res = await fetch(`${API_BASE}/api/route/guide?start=${start}&end=${end}`);
                if (!res.ok) throw new Error("API Error");
                routeData = await res.json();

                if (!routeData.steps || routeData.steps.length === 0) throw new Error("ê²½ë¡œ ì—†ìŒ");

                // UI ì „í™˜ -> ë¯¸ë¦¬ë³´ê¸°
                document.getElementById('setup-mode').classList.add('hidden');
                document.getElementById('preview-mode').classList.remove('hidden');
                
                // ìš”ì•½ ì •ë³´ í‘œì‹œ
                document.getElementById('preview-time').innerText = routeData.total_time_min + "ë¶„";
                document.getElementById('preview-dist').innerText = routeData.total_distance_m + "m";

                // ì§€ë„ì—ì„œ ê²½ë¡œê°€ ì˜ ë³´ì´ë„ë¡ ì¶œë°œì§€ ì¤‘ì‹¬ìœ¼ë¡œ ì´ë™
                const startNode = NODES[start];
                userPos = { ...startNode }; // ë‚´ ìœ„ì¹˜ ì´ˆê¸°í™”
                
                // ì¹´ë©”ë¼ë¥¼ ì¶œë°œì§€ë¡œ ì´ë™
                const cx = canvas.width / 2;
                const cy = canvas.height / 2;
                view.scale = 1.2; // ì•½ê°„ í™•ëŒ€
                view.x = cx - startNode.x * view.scale;
                view.y = cy - startNode.y * view.scale;

            } catch (e) {
                console.error(e);
                alert("ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                cancelRoute();
            } finally {
                btn.disabled = false;
                btn.innerHTML = `ê²½ë¡œ ê²€ìƒ‰`;
            }
        }

        function cancelRoute() {
            routeData = null;
            document.getElementById('setup-mode').classList.remove('hidden');
            document.getElementById('preview-mode').classList.add('hidden');
            resetView();
        }

        // --- 2ë‹¨ê³„: ë‚´ë¹„ê²Œì´ì…˜ ì‹œì‘ ---
        function startNavigation() {
            isNavigating = true;
            currentStepIdx = 0;
            simProgress = 0;

            // UI ì „í™˜
            document.getElementById('preview-mode').classList.add('hidden');
            document.getElementById('driving-mode').classList.remove('hidden');
            
            // GPS ìƒíƒœ ì—…ë°ì´íŠ¸
            const badge = document.getElementById('gps-badge');
            badge.className = "px-2 py-1 rounded bg-blue-100 text-xs font-bold text-blue-600 animate-pulse";
            badge.innerText = "GPS ìˆ˜ì‹  ì¤‘";

            updateNavInstruction(); // ì²« ë²ˆì§¸ ì•ˆë‚´ í‘œì‹œ
            
            // ì‹œë®¬ë ˆì´ì…˜ íƒ€ì´ë¨¸ ì‹œì‘ (ì‹¤ì œ GPS ì—°ë™ ì‹œì—ëŠ” ì´ ë¶€ë¶„ì„ navigator.geolocationìœ¼ë¡œ ëŒ€ì²´)
            simInterval = setInterval(simulationLoop, 50); // 50msë§ˆë‹¤ ì—…ë°ì´íŠ¸
        }

        function stopNavigation() {
            isNavigating = false;
            clearInterval(simInterval);
            
            // UI ë³µê·€
            document.getElementById('driving-mode').classList.add('hidden');
            document.getElementById('setup-mode').classList.remove('hidden');
            
            const badge = document.getElementById('gps-badge');
            badge.className = "px-2 py-1 rounded bg-gray-100 text-xs font-bold text-gray-400";
            badge.innerText = "GPS ëŒ€ê¸°";
            
            resetView();
            routeData = null;
        }

        // --- ë‚´ë¹„ê²Œì´ì…˜ ë¡œì§ & ì‹œë®¬ë ˆì´ì…˜ ---
        function simulationLoop() {
            if (!routeData || !isNavigating) return;

            const steps = routeData.steps;
            if (currentStepIdx >= steps.length) {
                // ë„ì°© ì™„ë£Œ
                finishNavigation();
                return;
            }

            const step = steps[currentStepIdx];
            const p1 = NODES[step.from_area];
            const p2 = NODES[step.to_area];

            // ì§„í–‰ë¥  ì¦ê°€ (ì†ë„ ì¡°ì ˆ)
            simProgress += 0.005; // ì´ë™ ì†ë„

            if (simProgress >= 1.0) {
                simProgress = 0;
                currentStepIdx++;
                updateNavInstruction(); // ë‹¤ìŒ ë‹¨ê³„ ì•ˆë‚´ ì—…ë°ì´íŠ¸
            } else {
                // ì¢Œí‘œ ë³´ê°„ (ì´ë™ ì• ë‹ˆë©”ì´ì…˜)
                userPos.x = p1.x + (p2.x - p1.x) * simProgress;
                userPos.y = p1.y + (p2.y - p1.y) * simProgress;
                
                // ì‹¤ì‹œê°„ ë‚¨ì€ ê±°ë¦¬ ì—…ë°ì´íŠ¸ (ì‹œê°ì  íš¨ê³¼)
                const remainingDist = step.distance_m * (1 - simProgress);
                updateRealtimeDistance(remainingDist);
                
                // ì¹´ë©”ë¼ íŒ”ë¡œìš° (ë‚´ ìœ„ì¹˜ê°€ í•­ìƒ í™”ë©´ ì¤‘ì•™ì— ì˜¤ë„ë¡)
                const cx = canvas.width / 2;
                const cy = canvas.height / 2;
                // ë¶€ë“œëŸ¬ìš´ ì¶”ì ì„ ìœ„í•´ lerp ì‚¬ìš© ê°€ëŠ¥í•˜ë‚˜ ì—¬ê¸°ì„  ì§ì ‘ í• ë‹¹
                view.x = cx - userPos.x * view.scale;
                view.y = cy - userPos.y * view.scale;
            }
        }

        function updateNavInstruction() {
            if (currentStepIdx >= routeData.steps.length) return;
            
            const step = routeData.steps[currentStepIdx];
            const iconName = TURN_ICONS[step.turn_type] || 'arrow-up';
            
            // ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
            const iconContainer = document.getElementById('turn-icon').parentElement;
            iconContainer.innerHTML = `<i data-lucide="${iconName}" class="w-8 h-8"></i>`;
            lucide.createIcons();

            // í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ("100m ë’¤ ìš°íšŒì „" ìŠ¤íƒ€ì¼)
            const instructionEl = document.getElementById('nav-instruction');
            const subTextEl = document.getElementById('nav-sub-text');
            
            // APIì—ì„œ ë°›ì€ ìƒì„¸ ì§€ì¹¨ í™œìš© ë˜ëŠ” ì¬ê°€ê³µ
            instructionEl.innerText = step.detailed_instruction; 
            // ì˜ˆ: "ì•½ 150më¥¼ ì§ì§„í•˜ì—¬ ë‹¤ìŒ ê°ˆë¦¼ê¸¸ë¡œ ì´ë™í•©ë‹ˆë‹¤."
            
            // ê°•ì¡° í‘œì‹œ
            if (step.turn_type === 'ë„ì°©') {
                iconContainer.className = "turn-icon-box bg-green-500";
                instructionEl.className = "text-xl font-bold text-green-600 leading-tight mb-1";
            } else {
                iconContainer.className = "turn-icon-box bg-blue-600";
                instructionEl.className = "text-xl font-bold text-slate-900 leading-tight mb-1";
            }
        }

        function updateRealtimeDistance(dist) {
            const el = document.getElementById('nav-sub-text');
            if (dist < 10) {
                el.innerText = "ì ì‹œ í›„ íšŒì „/ë„ì°©";
                el.className = "text-base text-red-500 font-bold animate-pulse";
            } else {
                el.innerText = `${Math.round(dist)}m ë‚¨ìŒ`;
                el.className = "text-base text-blue-600 font-semibold";
            }
        }

        function finishNavigation() {
            clearInterval(simInterval);
            document.getElementById('nav-instruction').innerText = "ëª©ì ì§€ ë„ì°© ì™„ë£Œ!";
            document.getElementById('nav-sub-text').innerText = "ì•ˆë‚´ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.";
            
            const iconContainer = document.getElementById('turn-icon').parentElement;
            iconContainer.className = "turn-icon-box bg-green-500";
            iconContainer.innerHTML = `<i data-lucide="check" class="w-8 h-8"></i>`;
            lucide.createIcons();

            setTimeout(() => {
                alert("ë„ì°©í–ˆìŠµë‹ˆë‹¤!");
                stopNavigation();
            }, 2000);
        }

        // --- ë Œë”ë§ ---
        function render() {
            // ë°°ê²½
            ctx.fillStyle = "#f1f5f9";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.save();
            // ì¹´ë©”ë¼ ë·° ì ìš©
            ctx.translate(view.x, view.y);
            ctx.scale(view.scale, view.scale);

            // 1. ì—°ê²°ì„  (ë„ë¡œ)
            ctx.lineWidth = 20;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#e2e8f0'; // ë„ë¡œ ìƒ‰ìƒ (ì—°í•œ íšŒìƒ‰)
            EDGES.forEach(e => {
                const p1 = NODES[e.u];
                const p2 = NODES[e.v];
                ctx.beginPath();
                ctx.moveTo(p1.x, p1.y);
                ctx.lineTo(p2.x, p2.y);
                ctx.stroke();
            });
            
            // ë„ë¡œ ì¤‘ì•™ì„ 
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#ffffff';
            ctx.setLineDash([10, 10]);
            EDGES.forEach(e => {
                const p1 = NODES[e.u];
                const p2 = NODES[e.v];
                ctx.beginPath();
                ctx.moveTo(p1.x, p1.y);
                ctx.lineTo(p2.x, p2.y);
                ctx.stroke();
            });
            ctx.setLineDash([]);

            // 2. ì „ì²´ ê²½ë¡œ í•˜ì´ë¼ì´íŠ¸ (ë‚´ë¹„ ì¤‘ì¼ ë•Œ)
            if (routeData) {
                ctx.lineWidth = 8;
                ctx.strokeStyle = '#3b82f6'; // íŒŒë€ìƒ‰ ê²½ë¡œ
                ctx.lineJoin = 'round';
                ctx.beginPath();
                
                // ìµœì  ê²½ë¡œìƒì˜ ë…¸ë“œë“¤ì„ ì—°ê²°
                const pathNodes = routeData.optimal_path_areas;
                if (pathNodes.length > 0) {
                    const start = NODES[pathNodes[0]];
                    ctx.moveTo(start.x, start.y);
                    for(let i=1; i<pathNodes.length; i++) {
                        const p = NODES[pathNodes[i]];
                        ctx.lineTo(p.x, p.y);
                    }
                }
                ctx.stroke();
            }

            // 3. ë…¸ë“œ (ì¥ì†Œ)
            Object.keys(NODES).forEach(k => {
                const n = NODES[k];
                const isStart = document.getElementById('start-select').value === k;
                const isEnd = document.getElementById('end-select').value === k;

                // ê·¸ë¦¼ì
                ctx.beginPath();
                ctx.arc(n.x, n.y + 5, 12, 0, Math.PI*2);
                ctx.fillStyle = 'rgba(0,0,0,0.1)';
                ctx.fill();

                // ë…¸ë“œ ì›
                ctx.beginPath();
                ctx.arc(n.x, n.y, 12, 0, Math.PI*2);
                if (isStart) ctx.fillStyle = '#22c55e';
                else if (isEnd) ctx.fillStyle = '#ef4444';
                else ctx.fillStyle = 'white';
                ctx.fill();
                
                ctx.strokeStyle = '#64748b';
                ctx.lineWidth = 2;
                ctx.stroke();

                // í…ìŠ¤íŠ¸
                ctx.font = 'bold 24px sans-serif';
                ctx.fillStyle = '#1e293b';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'bottom';
                ctx.fillText(k, n.x, n.y - 20);
            });

            // 4. ì‚¬ìš©ì ë§ˆì»¤ (ë‚´ë¹„ê²Œì´ì…˜ ì¤‘)
            if (userPos.x !== 0 && (isNavigating || routeData)) {
                // í„ìŠ¤ íš¨ê³¼
                const time = Date.now() / 500;
                const size = 20 + Math.sin(time) * 5;
                ctx.beginPath();
                ctx.arc(userPos.x, userPos.y, size, 0, Math.PI*2);
                ctx.fillStyle = 'rgba(59, 130, 246, 0.3)';
                ctx.fill();

                // í™”ì‚´í‘œ/ì 
                ctx.beginPath();
                ctx.arc(userPos.x, userPos.y, 10, 0, Math.PI*2);
                ctx.fillStyle = '#2563eb';
                ctx.fill();
                ctx.lineWidth = 3;
                ctx.strokeStyle = 'white';
                ctx.stroke();
            }

            ctx.restore();
            requestAnimationFrame(render);
        }
    </script>
</body>
</html>