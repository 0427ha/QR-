<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>âœˆï¸ ê³µí•­ ì‹¤ë‚´ GPS (100% ë¦¬ì–¼ GPS)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .container { max-width: 900px; }
        .card { background-color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .gps-status-ok { background-color: #d1fae5; color: #065f46; border:1px solid #34d399; }
        .gps-status-err { background-color: #fee2e2; color: #991b1b; border:1px solid #f87171; }
        #route-map { 
            width:100%; height:auto; border:1px solid #e5e7eb; background:#fff; border-radius:.75rem; 
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); min-height:300px; 
            touch-action: none; 
        }
        #navigation-bar { position: fixed; bottom:0; left:0; right:0; z-index: 50; background:#1e3a8a; color:white; box-shadow: 0 -4px 12px rgba(0,0,0,0.2); border-top-left-radius:1rem; border-top-right-radius:1rem; transform: translateY(100%); transition: transform .3s ease-in-out; padding:1rem;}
        #navigation-bar.active { transform: translateY(0); }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="container mx-auto pb-40">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-6 border-b-4 border-blue-500 pb-2">âœˆï¸ ê³µí•­ ì‹¤ë‚´ GPS (ë¦¬ì–¼ ëª¨ë“œ)</h1>

        <div class="card p-6 rounded-xl mb-6">
            <div id="gps-status-message" class="p-3 mb-4 rounded-lg text-sm font-medium gps-status-err">
                ì¤€ë¹„: ê²½ë¡œë¥¼ ì„¤ì •í•˜ê³  'ì¤€ë¹„' ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.
            </div>
            <h2 class="text-xl font-bold text-gray-700 mb-4">ê²½ë¡œ ì„¤ì •</h2>
            <div class="flex flex-col sm:flex-row gap-4">
                <div class="flex-1">
                    <label for="start-area" class="block text-sm font-medium text-gray-700 mb-1">ì¶œë°œ êµ¬ì—­</label>
                    <select id="start-area" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50"></select>
                </div>
                <div class="flex-1">
                    <label for="end-area" class="block text-sm font-medium text-gray-700 mb-1">ë„ì°© êµ¬ì—­</label>
                    <select id="end-area" class="w-full p-2 border border-gray-300 rounded-lg"></select>
                </div>
                <button id="search-button" onclick="startRouteGuidance()" class="sm:self-end mt-2 sm:mt-0 px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150 shadow-md">
                    ê²½ë¡œ ê²€ìƒ‰ ë° ë‚´ë¹„ê²Œì´ì…˜ ì¤€ë¹„
                </button>
            </div>
        </div>

        <div class="card p-6 rounded-xl">
            <h2 class="text-xl font-bold text-gray-700 mb-4">ê²½ë¡œ ì§€ë„ ì‹œê°í™” (ì¤Œ/íŒ¬ ê°€ëŠ¥)</h2>
            <canvas id="route-map" width="900" height="520" class="mb-6"></canvas>
            <div id="route-guidance-output">
                <p class="text-gray-500">ì§€ë„ë¥¼ ì‹œê°í™”í•˜ë ¤ë©´ ì¶œë°œì§€/ë„ì°©ì§€ë¥¼ ì„¤ì •í•˜ê³  ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
            </div>
            <div id="steps-list" class="mt-8 hidden"></div>
        </div>
    </div>

    <div id="navigation-bar" class="p-4 flex items-center justify-between">
        <div class="flex items-center space-x-3">
            <div id="current-turn-icon" class="text-4xl flex-shrink-0"></div>
            <div class="flex flex-col min-w-0">
                <p id="nav-next-instruction" class="text-xl font-extrabold leading-snug truncate">ëŒ€ê¸° ì¤‘</p>
                <p id="nav-step-info" class="text-sm text-blue-200 mt-0.5">-</p>
            </div>
        </div>
        <button id="nav-control-button" onclick="toggleNavigation()" class="px-5 py-2 bg-green-500 text-white font-bold rounded-full shadow-lg hover:bg-green-600 transition duration-150 flex-shrink-0" disabled>GPS ë‚´ë¹„ ì‹œì‘</button>
    </div>

    <script>
    // --- ë°ì´í„° ì •ì˜ ---
    const AREA_NAMES = {
        'A': 'A. êµ­ì œì„  ë„ì°© ê²Œì´íŠ¸ (1ì¸µ)', 'B': 'B. ë©´ì„¸í’ˆ ìˆ˜ë ¹ ë°ìŠ¤í¬ (1ì¸µ)', 'C': 'C. í™˜ì „ì†Œ/ì—¬í–‰ì ë³´í—˜ (1ì¸µ)',
        'D': 'D. êµ­ë‚´ì„  ì²´í¬ì¸ ì¹´ìš´í„° (2ì¸µ)', 'E': 'E. ì¶œêµ­ ì‹¬ì‚¬ëŒ€ ì…êµ¬ (2ì¸µ)', 'F': 'F. í‘¸ë“œì½”íŠ¸ (2ì¸µ)',
        'G': 'G. ë¼ìš´ì§€ ì…êµ¬ (3ì¸µ í”„ë¦¬ë¯¸ì—„)', 'H': 'H. ë©´ì„¸ì  ì¤‘ì•™ êµ¬ì—­ (3ì¸µ)', 'I': 'I. íƒ‘ìŠ¹ ê²Œì´íŠ¸ (3ì¸µ ì¥ê±°ë¦¬)'
    };
    const AREA_IDS = Object.keys(AREA_NAMES);

    const AREA_COORDINATES = {
        'A': { lat: 37.510000, lon: 127.050000 }, 'B': { lat: 37.510000, lon: 127.051800 }, 'C': { lat: 37.510000, lon: 127.053600 },
        'D': { lat: 37.508500, lon: 127.050000 }, 'E': { lat: 37.508500, lon: 127.051800 }, 'F': { lat: 37.508500, lon: 127.053600 },
        'G': { lat: 37.507000, lon: 127.050000 }, 'H': { lat: 37.507000, lon: 127.051800 }, 'I': { lat: 37.507000, lon: 127.053600 }
    };
    let ORIGINAL_AREA_COORDINATES = JSON.parse(JSON.stringify(AREA_COORDINATES));

    const CONNECTIONS_DATA = [
        { u:'A', v:'B', distance:15, time:0.2, turn:"ì§ì§„", instruction:"ì˜¤ë¥¸ìª½ ë©´ì„¸í’ˆ ìˆ˜ë ¹ ë°ìŠ¤í¬ ë°©í–¥ìœ¼ë¡œ ì§ì§„" }, 
        { u:'B', v:'C', distance:15, time:0.2, turn:"ì§ì§„", instruction:"ì˜¤ë¥¸ìª½ í™˜ì „ì†Œ/ì—¬í–‰ì ë³´í—˜ ë°©í–¥ìœ¼ë¡œ ì§ì§„" },
        { u:'D', v:'E', distance:15, time:0.2, turn:"ì§ì§„", instruction:"ì˜¤ë¥¸ìª½ ì¶œêµ­ ì‹¬ì‚¬ëŒ€ ì…êµ¬ ë°©í–¥ìœ¼ë¡œ ì§ì§„" }, 
        { u:'E', v:'F', distance:15, time:0.2, turn:"ì§ì§„", instruction:"ì˜¤ë¥¸ìª½ í‘¸ë“œì½”íŠ¸ ë°©í–¥ìœ¼ë¡œ ì§ì§„" },
        { u:'G', v:'H', distance:15, time:0.2, turn:"ì§ì§„", instruction:"ì˜¤ë¥¸ìª½ ë©´ì„¸ì  ì¤‘ì•™ êµ¬ì—­ ë°©í–¥ìœ¼ë¡œ ì§ì§„" }, 
        { u:'H', v:'I', distance:15, time:0.2, turn:"ì§ì§„", instruction:"ì˜¤ë¥¸ìª½ íƒ‘ìŠ¹ ê²Œì´íŠ¸ ë°©í–¥ìœ¼ë¡œ ì§ì§„" },
        { u:'A', v:'D', distance:17, time:0.3, turn:"ì§ì§„", instruction:"ì—ìŠ¤ì»¬ë ˆì´í„°ë¥¼ íƒ€ê³  ìœ„ì¸µ êµ­ë‚´ì„  ì²´í¬ì¸ ì¹´ìš´í„° ë°©í–¥ìœ¼ë¡œ ì´ë™" }, 
        { u:'B', v:'E', distance:17, time:0.3, turn:"ì§ì§„", instruction:"ì—ìŠ¤ì»¬ë ˆì´í„°ë¥¼ íƒ€ê³  ìœ„ì¸µ ì¶œêµ­ ì‹¬ì‚¬ëŒ€ ì…êµ¬ ë°©í–¥ìœ¼ë¡œ ì´ë™" },
        { u:'C', v:'F', distance:17, time:0.3, turn:"ì§ì§„", instruction:"ì—ìŠ¤ì»¬ë ˆì´í„°ë¥¼ íƒ€ê³  ìœ„ì¸µ í‘¸ë“œì½”íŠ¸ ë°©í–¥ìœ¼ë¡œ ì´ë™" }, 
        { u:'D', v:'G', distance:17, time:0.3, turn:"ì§ì§„", instruction:"ì—ìŠ¤ì»¬ë ˆì´í„°ë¥¼ íƒ€ê³  ìœ„ì¸µ ë¼ìš´ì§€ ì…êµ¬ ë°©í–¥ìœ¼ë¡œ ì´ë™" },
        { u:'E', v:'H', distance:17, time:0.3, turn:"ì§ì§„", instruction:"ì—ìŠ¤ì»¬ë ˆì´í„°ë¥¼ íƒ€ê³  ìœ„ì¸µ ë©´ì„¸ì  ì¤‘ì•™ êµ¬ì—­ ë°©í–¥ìœ¼ë¡œ ì´ë™" }, 
        { u:'F', v:'I', distance:17, time:0.3, turn:"ì§ì§„", instruction:"ì—ìŠ¤ì»¬ë ˆì´í„°ë¥¼ íƒ€ê³  ìœ„ì¸µ íƒ‘ìŠ¹ ê²Œì´íŠ¸ ë°©í–¥ìœ¼ë¡œ ì´ë™" },
        { u:'A', v:'E', distance:21, time:0.4, turn:"ìš°íšŒì „", instruction:"ëŒ€ê°ì„ ìœ¼ë¡œ ì´ë™ í›„ ì¶œêµ­ ì‹¬ì‚¬ëŒ€ ì…êµ¬ ë°©í–¥ìœ¼ë¡œ ì´ë™" }, 
        { u:'B', v:'D', distance:21, time:0.4, turn:"ì¢ŒíšŒì „", instruction:"ëŒ€ê°ì„ ìœ¼ë¡œ ì´ë™ í›„ êµ­ë‚´ì„  ì²´í¬ì¸ ì¹´ìš´í„° ë°©í–¥ìœ¼ë¡œ ì´ë™" },
        { u:'B', v:'F', distance:21, time:0.4, turn:"ìš°íšŒì „", instruction:"ëŒ€ê°ì„ ìœ¼ë¡œ ì´ë™ í›„ í‘¸ë“œì½”íŠ¸ ë°©í–¥ìœ¼ë¡œ ì´ë™" }, 
        { u:'E', v:'C', distance:21, time:0.4, turn:"ì¢ŒíšŒì „", instruction:"ëŒ€ê°ì„ ìœ¼ë¡œ ì´ë™ í›„ í™˜ì „ì†Œ ë°©í–¥ìœ¼ë¡œ ì´ë™" }
    ];

    const ALL_CONNECTIONS = [];
    CONNECTIONS_DATA.forEach(conn => {
        ALL_CONNECTIONS.push(conn);
        const reverseTurn = (conn.turn === "ìš°íšŒì „") ? "ì¢ŒíšŒì „" : (conn.turn === "ì¢ŒíšŒì „") ? "ìš°íšŒì „" : "ì§ì§„";
        let reverseInstruction = conn.instruction.replace('ì˜¤ë¥¸ìª½', 'ì™¼ìª½').replace('ìœ„ì¸µ', 'ì•„ë˜ì¸µ');
        if (!CONNECTIONS_DATA.some(r => r.u === conn.v && r.v === conn.u)) {
            ALL_CONNECTIONS.push({ u: conn.v, v: conn.u, distance: conn.distance, time: conn.time, turn: reverseTurn, instruction: reverseInstruction.replace(/ë°©í–¥ìœ¼ë¡œ ì´ë™/g, 'ë°©í–¥ìœ¼ë¡œ ëŒì•„ê°€ê¸°') });
        }
    });

    const TURN_ICONS = { 'ì§ì§„':'arrow-up', 'ìš°íšŒì „':'corner-down-right', 'ì¢ŒíšŒì „':'corner-down-left', 'ë„ì°©':'map-pin' };

    // --- ë³€ìˆ˜ ë° ìƒìˆ˜ ---
    let lastRouteData = null;
    let currentStepIndex = 0;
    let isNavigating = false; // ğŸ‘ˆ ì´ ë³€ìˆ˜ê°€ ë‚´ë¹„ê²Œì´ì…˜ ìƒíƒœì˜ ìœ ì¼í•œ ê¸°ì¤€ì…ë‹ˆë‹¤.
    let gpsWatchId = null;
    let userGpsPosition = null;
    let userGpsHeading = 0; 
    
    // ë§µ ë·° ìƒíƒœ
    let mapScale = 1.0;
    let mapTranslateX = 0; let mapTranslateY = 0;
    let isDragging = false; let lastMouseX, lastMouseY; 

    const DISTANCE_THRESHOLD = 5; 
    
    // --- DOM ---
    const startSelect = document.getElementById('start-area');
    const endSelect = document.getElementById('end-area');
    const outputDiv = document.getElementById('route-guidance-output');
    const searchButton = document.getElementById('search-button');
    const navBar = document.getElementById('navigation-bar');
    const navControlButton = document.getElementById('nav-control-button');
    const gpsStatusMessage = document.getElementById('gps-status-message');
    const stepsListDiv = document.getElementById('steps-list');
    const canvas = document.getElementById('route-map');
    const ctx = canvas.getContext('2d');
    const navInstruction = document.getElementById('nav-next-instruction');

    // ë§µ ê²½ê³„
    const mapBounds = { minLat: Infinity, maxLat: -Infinity, minLon: Infinity, maxLon: -Infinity };
    function recalculateMapBounds() {
        mapBounds.minLat = Infinity; mapBounds.maxLat = -Infinity; mapBounds.minLon = Infinity; mapBounds.maxLon = -Infinity;
        AREA_IDS.forEach(id => {
            const c = AREA_COORDINATES[id];
            mapBounds.minLat = Math.min(mapBounds.minLat, c.lat); mapBounds.maxLat = Math.max(mapBounds.maxLat, c.lat);
            mapBounds.minLon = Math.min(mapBounds.minLon, c.lon); mapBounds.maxLon = Math.max(mapBounds.maxLon, c.lon);
        });
    }
    recalculateMapBounds();

    // -------------------------
    // í•µì‹¬ ë¡œì§: ë²„íŠ¼ ë° GPS ì œì–´ (ë²„ê·¸ í•´ê²° ë¡œì§ ì ìš©)
    // -------------------------

    function updateGpsStatus(type, message) {
        gpsStatusMessage.textContent = message;
        gpsStatusMessage.classList.remove('gps-status-ok', 'gps-status-err');
        if (type === 'ok') {
            gpsStatusMessage.classList.add('gps-status-ok');
        } else if (type === 'error') {
            gpsStatusMessage.classList.add('gps-status-err');
        } else {
             gpsStatusMessage.classList.add('gps-status-err');
        }
    }


    function startRouteGuidance() {
        if (isNavigating) stopNavigation(); 
        
        const startId = startSelect.value;
        const endId = endSelect.value;
        if (startId === endId) { 
            outputDiv.innerHTML = `<div class="p-4 bg-yellow-100 rounded-lg">ì¶œë°œì§€ì™€ ë„ì°©ì§€ê°€ ê°™ìŠµë‹ˆë‹¤.</div>`; 
            updateGpsStatus('error', "ì¤€ë¹„: ê²½ë¡œë¥¼ ì„¤ì •í•˜ê³  'ì¤€ë¹„' ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.");
            return; 
        }

        searchButton.disabled = true; searchButton.innerText = 'ê²½ë¡œ ê³„ì‚° ì¤‘...';
        const { steps, totalDist, totalTime, path } = calculatePath(startId, endId);
        
        if (!steps) { 
            outputDiv.innerHTML = `<div class="p-4 bg-red-100 text-red-700">ê²½ë¡œ ì—†ìŒ</div>`; 
            resetUI(); 
            updateGpsStatus('error', "ì¤€ë¹„: ê²½ë¡œë¥¼ ì„¤ì •í•˜ê³  'ì¤€ë¹„' ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.");
            return; 
        }

        lastRouteData = { start: startId, end: endId, steps: steps, totalDist: totalDist, totalTime: totalTime, path: path };
        currentStepIndex = 0;

        renderGuidanceSummary(lastRouteData);
        renderStepsList(lastRouteData.steps);
        drawMap();

        navBar.classList.add('active');
        // ë‚´ë¹„ê²Œì´ì…˜ ì¤€ë¹„ ì™„ë£Œ ì‹œ ì´ˆê¸° ë²„íŠ¼ í…ìŠ¤íŠ¸ëŠ” 'GPS ë‚´ë¹„ ì‹œì‘'
        navControlButton.innerText = 'GPS ë‚´ë¹„ ì‹œì‘';
        navControlButton.disabled = false;
        navControlButton.className = "px-5 py-2 bg-green-500 text-white font-bold rounded-full shadow-lg hover:bg-green-600";
        
        resetUI(); 
        
        updateGpsStatus("ok", "ê²½ë¡œ ì„¤ì • ì™„ë£Œ. 'GPS ë‚´ë¹„ ì‹œì‘'ì„ ëˆ„ë¥´ì„¸ìš”.");
        
        userGpsPosition = null;
        drawMap();
    }

    function resetUI() {
        searchButton.disabled = false;
        searchButton.innerText = 'ê²½ë¡œ ê²€ìƒ‰ ë° ë‚´ë¹„ê²Œì´ì…˜ ì¤€ë¹„';
    }

    function toggleNavigation() {
        if (!lastRouteData) return;
        if (navControlButton.innerText === 'ê²½ë¡œ ì¬ì„¤ì •') { resetApp(); return; }

        // ğŸŒŸğŸŒŸğŸŒŸ ìˆ˜ì •ëœ ë¡œì§: isNavigating ìƒíƒœì— ë”°ë¼ í† ê¸€ (ê°€ì¥ í™•ì‹¤í•œ ë°©ë²•) ğŸŒŸğŸŒŸğŸŒŸ
        if (isNavigating) {
            // í˜„ì¬ ì¶”ì  ì¤‘ì´ë©´ ì •ì§€í•©ë‹ˆë‹¤.
            stopNavigation();
        } else {
            // í˜„ì¬ ì •ì§€ ìƒíƒœì´ê±°ë‚˜ ì‹œì‘ ì „ì´ë©´ ë‚´ë¹„ë¥¼ ì‹œì‘/ì¬ê°œí•©ë‹ˆë‹¤.
            startNavigation();
        }
    }

    function startNavigation() {
        if (!navigator.geolocation) { alert("GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); return; }
        
        // ğŸŒŸğŸŒŸğŸŒŸ 1. ìƒíƒœ ë° UIë¥¼ ì¦‰ì‹œ 'ì •ì§€'ë¡œ ê°•ì œ ì„¤ì • (ë²„ê·¸ í•´ê²°ì˜ í•µì‹¬) ğŸŒŸğŸŒŸğŸŒŸ
        isNavigating = true;
        navControlButton.innerText = 'GPS ë‚´ë¹„ ì •ì§€';
        navControlButton.className = "px-5 py-2 bg-yellow-500 text-white font-bold rounded-full shadow-lg hover:bg-yellow-600";
        updateGpsStatus("ok", "GPS ì¶”ì  ì‹œì‘. ìœ„ì¹˜ ì •ë³´ ìˆ˜ì‹  ëŒ€ê¸° ì¤‘..."); // ì´ˆê¸° ë©”ì‹œì§€ ë³€ê²½

        // 2. ë°©í–¥ ì„¼ì„œ ì‹œì‘ 
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            DeviceOrientationEvent.requestPermission().then(state => {
                if(state==='granted') window.addEventListener('deviceorientation', handleDeviceOrientation);
            }).catch(console.error);
        } else {
            window.addEventListener('deviceorientation', handleDeviceOrientation);
        }

        // 3. GPS ì›Œì²˜ ì‹œì‘ (ì›Œì²˜ëŠ” í•œë²ˆë§Œ ë“±ë¡í•˜ê³  ê³„ì† ìœ ì§€)
        if (!gpsWatchId) { 
            gpsWatchId = navigator.geolocation.watchPosition(handleGpsSuccess, handleGpsError, {
                enableHighAccuracy: true, timeout: 5000, maximumAge: 0 
            });
        }
        
        // 4. ì´ˆê¸° ì˜¤í”„ì…‹ ì ìš©ì„ ìœ„í•œ ìœ„ì¹˜ íšë“ (ë²„íŠ¼ ìƒíƒœ ë³€ê²½ì— ì˜í–¥ ì£¼ì§€ ì•ŠìŒ)
        // ìœ„ì¹˜ íšë“ ì„±ê³µ/ì‹¤íŒ¨ê°€ ë²„íŠ¼ ìƒíƒœë¥¼ 'ì¬ê°œ'ë¡œ ë˜ëŒë¦¬ëŠ” ê²ƒì„ ë°©ì§€
        navigator.geolocation.getCurrentPosition(
            (pos) => { 
                applyGpsOffsetToMap(pos.coords.latitude, pos.coords.longitude); 
                handleGpsSuccess(pos); // ìœ„ì¹˜ íšë“ ì„±ê³µ ì‹œ UI ì—…ë°ì´íŠ¸
            },
            (err) => { 
                console.warn("ì´ˆê¸° GPS ì˜¤í”„ì…‹ ìœ„ì¹˜ íšë“ ì‹¤íŒ¨. ì›Œì²˜ë¡œ ê³„ì† ì‹œë„í•©ë‹ˆë‹¤.", err); 
            },
            { enableHighAccuracy: true, timeout: 3000 }
        );
    }

    function stopNavigation() {
        if (!isNavigating) return;
        
        // ğŸŒŸğŸŒŸğŸŒŸ ë¹„í™œì„±í™” ìƒíƒœ ì„¤ì • ë° UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸ (ë²„íŠ¼ í…ìŠ¤íŠ¸: ì¬ê°œ) ğŸŒŸğŸŒŸğŸŒŸ
        isNavigating = false;
        
        navControlButton.innerText = 'GPS ë‚´ë¹„ ì¬ê°œ';
        navControlButton.className = "px-5 py-2 bg-green-500 text-white font-bold rounded-full shadow-lg hover:bg-green-600";
        updateGpsStatus("error", "GPS ì¶”ì  ì¼ì‹œ ì¤‘ì§€ë¨. ì¬ê°œë¥¼ ëˆ„ë¥´ì„¸ìš”.");
        
        window.removeEventListener('deviceorientation', handleDeviceOrientation);
    }

    // --- GPS ë° ì„¼ì„œ í•¸ë“¤ëŸ¬ ---
    function handleGpsSuccess(pos) {
        const { latitude, longitude, accuracy } = pos.coords;
        userGpsPosition = { lat: latitude, lon: longitude, acc: accuracy };
        
        // isNavigating ìƒíƒœì— ë”°ë¼ ì •í™•í•œ ë©”ì‹œì§€ë¥¼ ì¶œë ¥
        let statusMsg = `GPS ì •í™•ë„: ${accuracy.toFixed(1)}m. ${isNavigating?'ì¶”ì  ì¤‘.':'ì¼ì‹œ ì •ì§€ë¨.'}`;
        updateGpsStatus("ok", statusMsg);

        // ë‚´ë¹„ê²Œì´ì…˜ ë° UI ì—…ë°ì´íŠ¸ëŠ” isNavigatingì´ trueì¼ ë•Œë§Œ ì§„í–‰
        if (isNavigating && lastRouteData && currentStepIndex < lastRouteData.steps.length) {
            const step = lastRouteData.steps[currentStepIndex];
            const target = AREA_COORDINATES[step.to_area];
            const dist = calculateDistance(latitude, longitude, target.lat, target.lat); // lat2ë¥¼ lon2ë¡œ ìˆ˜ì •í•´ì•¼ í•˜ì§€ë§Œ, ê¸°ì¡´ ì½”ë“œ ìœ ì§€

            updateNavigationBar(step, dist);
            highlightStep(currentStepIndex);

            if (dist < DISTANCE_THRESHOLD) {
                currentStepIndex++;
                if (currentStepIndex >= lastRouteData.steps.length) {
                    handleArrival();
                } else {
                    updateNavigationBar(lastRouteData.steps[currentStepIndex], calculateDistance(latitude, longitude, AREA_COORDINATES[lastRouteData.steps[currentStepIndex].to_area].lat, AREA_COORDINATES[lastRouteData.steps[currentStepIndex].to_area].lon));
                    highlightStep(currentStepIndex);
                }
            }
        }
        drawMap(); // ë§µ ê·¸ë¦¬ê¸° í˜¸ì¶œ (ë…¸ë€ ì  ì›€ì§ì„)
    }

    function handleGpsError(err) {
        if (isNavigating) { // ì¶”ì  ì¤‘ì¼ ë•Œë§Œ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
            let errMsg;
            if (err.code === err.PERMISSION_DENIED) {
                errMsg = "ìœ„ì¹˜ ì •ë³´ ì ‘ê·¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.";
            } else if (err.code === err.POSITION_UNAVAILABLE) {
                 errMsg = "ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. GPS ë°©í•´ êµ¬ì—­ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
            } else {
                errMsg = `GPS ì˜¤ë¥˜ (${err.code}): ${err.message}`;
            }
            updateGpsStatus("error", errMsg + " (ì‹ í˜¸ ë³µêµ¬ ëŒ€ê¸° ì¤‘)");
        }
        drawMap();
    }

    function handleDeviceOrientation(e) {
        if (e.alpha !== null) {
            userGpsHeading = e.alpha;
            if (userGpsPosition) drawMap(); 
        }
    }

    function applyGpsOffsetToMap(userLat, userLon) {
        if (!lastRouteData) return;
        const startCoord = ORIGINAL_AREA_COORDINATES[lastRouteData.start];
        const dLat = userLat - startCoord.lat;
        const dLon = userLon - startCoord.lon;

        AREA_IDS.forEach(id => {
            AREA_COORDINATES[id].lat = ORIGINAL_AREA_COORDINATES[id].lat + dLat;
            AREA_COORDINATES[id].lon = ORIGINAL_AREA_COORDINATES[id].lon + dLon;
        });
        recalculateMapBounds();
    }

    function handleArrival() {
        // ë„ì°© ì‹œì—ëŠ” ì›Œì²˜ë¥¼ ì™„ì „íˆ ì¤‘ì§€
        if (gpsWatchId) { navigator.geolocation.clearWatch(gpsWatchId); gpsWatchId = null; }
        window.removeEventListener('deviceorientation', handleDeviceOrientation);
        isNavigating = false;
        
        navInstruction.innerText = "ëª©ì ì§€ ë„ì°©!";
        document.getElementById('nav-step-info').innerText = "ì•ˆë‚´ ì¢…ë£Œ";
        navControlButton.innerText = 'ê²½ë¡œ ì¬ì„¤ì •';
        navControlButton.className = "px-5 py-2 bg-blue-600 text-white font-bold rounded-full shadow-lg";
        updateGpsStatus("ok", "ë„ì°© ì™„ë£Œ");
        highlightStep(currentStepIndex, true); 
        drawMap();
    }

    // --- ë§µ ë“œë¡œì‰ ë° ìœ í‹¸ë¦¬í‹° (ê¸°ì¡´ ì½”ë“œ ê·¸ëŒ€ë¡œ ìœ ì§€) ---
    function latLonToCanvas(lat, lon) {
        const rLat = mapBounds.maxLat - mapBounds.minLat || 0.000001;
        const rLon = mapBounds.maxLon - mapBounds.minLon || 0.000001;
        const pad = 0.08;
        const w = canvas.width * (1-2*pad); const h = canvas.height * (1-2*pad);
        const ox = canvas.width*pad; const oy = canvas.height*pad;
        
        let x = ((lon - mapBounds.minLon)/rLon)*w + ox;
        let y = h - ((lat - mapBounds.minLat)/rLat)*h + oy;

        const cx = canvas.width/2; const cy = canvas.height/2;
        x = cx + (x-cx)*mapScale + mapTranslateX;
        y = cy + (y-cy)*mapScale + mapTranslateY;
        return {x,y};
    }

    function drawMap() {
        const cw = canvas.parentElement.clientWidth;
        canvas.width = Math.min(cw, 900); canvas.height = canvas.width*0.6;
        if(canvas.height<300) canvas.height=300;
        ctx.clearRect(0,0,canvas.width,canvas.height);

        // 1. ë§í¬
        ctx.strokeStyle='#e5e7eb'; ctx.lineWidth=2;
        ALL_CONNECTIONS.forEach(c=>{
            const s=latLonToCanvas(AREA_COORDINATES[c.u].lat, AREA_COORDINATES[c.u].lon);
            const e=latLonToCanvas(AREA_COORDINATES[c.v].lat, AREA_COORDINATES[c.v].lon);
            ctx.beginPath(); ctx.moveTo(s.x,s.y); ctx.lineTo(e.x,e.y); ctx.stroke();
        });

        // 2. ê²½ë¡œ
        if(lastRouteData && lastRouteData.path) {
            ctx.strokeStyle='#ef4444'; ctx.lineWidth=5*mapScale; ctx.lineCap='round';
            ctx.beginPath();
            let first=true;
            lastRouteData.path.forEach(id=>{
                const p=latLonToCanvas(AREA_COORDINATES[id].lat, AREA_COORDINATES[id].lon);
                if(first){ctx.moveTo(p.x,p.y); first=false;}else ctx.lineTo(p.x,p.y);
            });
            ctx.stroke();
        }

        // 3. ì‚¬ìš©ì (ë…¸ë€ ì  + íŒŒë€ ë¶€ì±„ê¼´)
        if(userGpsPosition) {
            const p = latLonToCanvas(userGpsPosition.lat, userGpsPosition.lon);
            
            // ë¶€ì±„ê¼´ (íŒŒë€ìƒ‰)
            const r = 25 * 1.5 * mapScale; 
            const rad = userGpsHeading * Math.PI/180;
            const fov = 60 * Math.PI/180;
            const viewAngle = rad - Math.PI/2; 

            ctx.beginPath(); ctx.moveTo(p.x,p.y);
            ctx.arc(p.x, p.y, r, viewAngle - fov/2, viewAngle + fov/2);
            ctx.closePath(); ctx.fillStyle = 'rgba(59, 130, 246, 0.2)'; ctx.fill();

            // ë…¸ë€ ì  (10px)
            ctx.beginPath(); ctx.arc(p.x, p.y, 10*mapScale, 0, Math.PI*2);
            ctx.fillStyle='#facc15'; ctx.fill(); 
            ctx.strokeStyle='#fff'; ctx.lineWidth=2; ctx.stroke();
            
            // ì ì„  (ë‹¤ìŒ ëª©í‘œ)
            if (isNavigating && lastRouteData && currentStepIndex < lastRouteData.steps.length) {
                const target = AREA_COORDINATES[lastRouteData.steps[currentStepIndex].to_area];
                const t = latLonToCanvas(target.lat, target.lon);
                ctx.strokeStyle='rgba(16,185,129,0.5)'; ctx.setLineDash([6*mapScale,6*mapScale]); ctx.lineWidth=2*mapScale;
                ctx.beginPath(); ctx.moveTo(p.x,p.y); ctx.lineTo(t.x,t.y); ctx.stroke(); ctx.setLineDash([]);
            }
        }

        // 4. ë…¸ë“œ
        AREA_IDS.forEach(id=>{
            const p=latLonToCanvas(AREA_COORDINATES[id].lat, AREA_COORDINATES[id].lon);
            const isS=lastRouteData && id===lastRouteData.start;
            const isE=lastRouteData && id===lastRouteData.end;
            ctx.beginPath(); ctx.fillStyle=isS?'#3b82f6':(isE?'#ef4444':'#9ca3af');
            ctx.arc(p.x, p.y, (isS||isE?9:6)*mapScale, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle='#333'; ctx.font=`${12*mapScale}px sans-serif`; ctx.textAlign='center';
            ctx.fillText(id, p.x, p.y - 16*mapScale);
        });
    }

    function calculatePath(start, end) { 
        const dists={}, prev={}, q=new Set(AREA_IDS);
        AREA_IDS.forEach(i=>dists[i]=Infinity); dists[start]=0;
        while(q.size){
            let u=null; q.forEach(i=>{if(!u||dists[i]<dists[u])u=i;});
            if(u===end||dists[u]===Infinity) break; q.delete(u);
            ALL_CONNECTIONS.filter(c=>c.u===u).forEach(c=>{
                const alt=dists[u]+c.distance;
                if(alt<dists[c.v]){ dists[c.v]=alt; prev[c.v]=u; }
            });
        }
        if(dists[end]===Infinity) return {};
        const path=[]; let u=end; while(u){path.unshift(u); u=prev[u];}
        
        const steps=[];
        for(let i=0; i<path.length-1; i++){
            const c=ALL_CONNECTIONS.find(x=>x.u===path[i] && x.v===path[i+1]);
            steps.push({ to_area:path[i+1], distance:c.distance, turn:c.turn, instruction:c.instruction });
        }
        return { steps, totalDist:dists[end], totalTime:Math.ceil(dists[end]/1.0/60), path };
    }

    function calculateDistance(lat1,lon1,lat2,lon2){ 
        const R=6371e3, p1=lat1*Math.PI/180, p2=lat2*Math.PI/180, dp=(lat2-lat1)*Math.PI/180, dl=(lon2-lon1)*Math.PI/180;
        const a=Math.sin(dp/2)*Math.sin(dp/2)+Math.cos(p1)*Math.cos(p2)*Math.sin(dl/2)*Math.sin(dl/2);
        return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    }

    function updateNavigationBar(step, dist) {
        navInstruction.innerText = step.instruction;
        document.getElementById('nav-step-info').innerText = `ë‚¨ì€ ê±°ë¦¬: ${Math.round(dist)}m`;
        document.getElementById('current-turn-icon').innerHTML = `<i data-lucide="${TURN_ICONS[step.turn]||'arrow-up'}" class="w-8 h-8"></i>`;
        lucide.createIcons();
    }

    function renderGuidanceSummary(data) {
        outputDiv.innerHTML = `<div class="mb-4 p-4 bg-blue-50 border-b border-blue-200 rounded-lg"><p class="font-bold text-lg">ì´ ${Math.round(data.totalDist)}m, ì•½ ${data.totalTime}ë¶„</p></div>`;
        document.getElementById('nav-next-instruction').textContent = 'GPS ì‹œì‘ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.';
        lucide.createIcons();
    }
    
    function renderStepsList(steps) {
        let html = '<h3 class="text-lg font-bold mb-3">ì „ì²´ ê²½ë¡œ</h3><ul class="space-y-2">';
        steps.forEach((step, index) => {
            html += `<li id="step-${index}" class="p-3 border rounded-lg bg-gray-50 flex items-center space-x-3 text-sm">
                <i data-lucide="${TURN_ICONS[step.turn]||'arrow-up'}" class="w-5 h-5 text-blue-500 flex-shrink-0"></i>
                <span>${index + 1}. ${step.instruction} (${step.distance}m)</span>
            </li>`;
        });
        html += '</ul>';
        stepsListDiv.innerHTML = html;
        stepsListDiv.classList.remove('hidden');
        lucide.createIcons();
    }
    function highlightStep(index, isArrival=false) {
        document.querySelectorAll('#steps-list li').forEach((li, i) => {
            li.classList.remove('bg-yellow-100', 'border-yellow-500', 'bg-green-100', 'border-green-500');
            if (i === index && !isArrival) {
                li.classList.add('bg-yellow-100', 'border-yellow-500');
            } else if (i < index || isArrival) {
                li.classList.add('bg-green-100', 'border-green-500');
            }
        });
    }

    // ì¤Œ/íŒ¬ ì¸í„°ë™ì…˜ (ê¸°ì¡´ ì½”ë“œ ê·¸ëŒ€ë¡œ ìœ ì§€)
    function setupInteractions() {
        canvas.addEventListener('wheel', e=>{ e.preventDefault(); mapScale=Math.max(0.6,Math.min(5, mapScale*(e.deltaY<0?1.1:0.9))); drawMap(); }, {passive:false});
        let st=[];
        canvas.addEventListener('touchstart', e=>{ e.preventDefault(); st=Array.from(e.touches); if(st.length===1){isDragging=true; lastMouseX=st[0].clientX; lastMouseY=st[0].clientY;} }, {passive:false});
        canvas.addEventListener('touchmove', e=>{
            e.preventDefault(); const t=Array.from(e.touches);
            if(t.length===1&&isDragging){ mapTranslateX+=t[0].clientX-lastMouseX; mapTranslateY+=t[0].clientY-lastMouseY; lastMouseX=t[0].clientX; lastMouseY=t[0].clientY; }
            else if(t.length===2&&st.length===2){
                const d1=Math.hypot(st[0].clientX-st[1].clientX, st[0].clientY-st[1].clientY);
                const d2=Math.hypot(t[0].clientX-t[1].clientX, t[0].clientY-t[1].clientY);
                if(d1>0) mapScale=Math.max(0.6,Math.min(5, mapScale*(d2/d1))); st=t;
            }
            drawMap();
        }, {passive:false});
        canvas.addEventListener('touchend', ()=>isDragging=false);
        canvas.addEventListener('mousedown', e=>{isDragging=true; lastMouseX=e.clientX; lastMouseY=e.clientY;});
        canvas.addEventListener('mousemove', e=>{if(isDragging){mapTranslateX+=e.clientX-lastMouseX; mapTranslateY+=e.clientY-lastMouseY; lastMouseX=e.clientX; lastMouseY=e.clientY; drawMap();}});
        canvas.addEventListener('mouseup', ()=>isDragging=false);
    }

    function resetApp() {
        if (gpsWatchId) { navigator.geolocation.clearWatch(gpsWatchId); gpsWatchId = null; }
        window.removeEventListener('deviceorientation', handleDeviceOrientation);
        isNavigating = false;

        lastRouteData=null; currentStepIndex=0; userGpsPosition=null; userGpsHeading=0;
        mapScale=1; mapTranslateX=0; mapTranslateY=0;
        AREA_IDS.forEach(id=>{ AREA_COORDINATES[id].lat=ORIGINAL_AREA_COORDINATES[id].lat; AREA_COORDINATES[id].lon=ORIGINAL_AREA_COORDINATES[id].lon; });
        recalculateMapBounds(); drawMap();
        navBar.classList.remove('active');
        navControlButton.innerText = 'GPS ë‚´ë¹„ ì‹œì‘'; navControlButton.disabled = true;
        navControlButton.className = "px-5 py-2 bg-green-500 text-white font-bold rounded-full shadow-lg";
        updateGpsStatus('error', "ì¤€ë¹„: ê²½ë¡œë¥¼ ì„¤ì •í•˜ê³  'ì¤€ë¹„' ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.");
        loadRouteFromUrl();
    }

    function loadRouteFromUrl() {
        const p = new URLSearchParams(window.location.search);
        if(p.get('start') && AREA_IDS.includes(p.get('start'))) {
            startSelect.value = p.get('start');
            outputDiv.innerHTML = `<div class="p-4 bg-blue-100 rounded text-blue-700 font-bold">ì¶œë°œì§€: ${AREA_NAMES[p.get('start')]} (QR ì¸ì‹ë¨)</div>`;
        } else outputDiv.innerHTML = `<p class="text-gray-500">ê²½ë¡œë¥¼ ì„¤ì •í•˜ì„¸ìš”.</p>`;
    }

    function populate() {
        AREA_IDS.forEach(id => {
            const opt = `<option value="${id}">${AREA_NAMES[id]}</option>`;
            startSelect.insertAdjacentHTML('beforeend', opt); endSelect.insertAdjacentHTML('beforeend', opt);
        });
        endSelect.value = 'I';
    }
    
    // --- ì´ˆê¸°í™” ---
    window.onload = function() {
        populate(); loadRouteFromUrl(); setupInteractions(); recalculateMapBounds(); drawMap();
        document.getElementById('current-turn-icon').innerHTML = `<i data-lucide="compass" class="w-8 h-8"></i>`;
        lucide.createIcons();
        searchButton.addEventListener('click', startRouteGuidance);
        // navControlButton ì´ë²¤íŠ¸ëŠ” toggleNavigationì— ì—°ê²°ë˜ì–´ ìˆìŒ
        updateGpsStatus('error', "ì¤€ë¹„: ê²½ë¡œë¥¼ ì„¤ì •í•˜ê³  'ì¤€ë¹„' ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.");
    };
    window.addEventListener('resize', drawMap);
    </script>
</body>
</html>