<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>Square Grid Indoor Nav</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
    body { background: #000; color: white; margin:0; overflow: hidden; touch-action: none; font-family: -apple-system, sans-serif; }
    #map-canvas { width:100%; height:65vh; background:#111; border-radius:0 0 30px 30px; }
    
    /* ìƒë‹¨ ì •ë³´ì°½ */
    .overlay { 
        position: absolute; top: 20px; left:0; right:0; 
        text-align: center; z-index: 10; pointer-events: none; 
    }
    
    /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
    .bottom-panel { 
        position: absolute; bottom: 0; left:0; right:0; 
        height: 35vh; background: #000; 
        padding: 20px; box-sizing: border-box; 
        display: flex; flex-direction: column; 
        border-top: 1px solid #333;
    }
    
    /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .btn { 
        background: linear-gradient(135deg, #3b82f6, #2563eb); 
        color: white; border:none; padding: 18px; 
        font-size: 1.3rem; font-weight: 800; 
        border-radius: 20px; width: 100%; 
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        margin-top: auto; 
    }
    .btn:active { transform: scale(0.98); }

    .step-badge {
        position: absolute; top: 20px; right: 20px;
        background: rgba(30, 41, 59, 0.8); border: 1px solid #334155;
        padding: 6px 12px; border-radius: 99px; font-size: 0.8rem; font-weight: bold; color: #94a3b8;
    }
    </style>
</head>
<body>

<div class="step-badge">ğŸ‘£ <span id="step-count">0</span> steps</div>

<div class="overlay">
    <div id="instr" class="text-3xl font-black text-cyan-400 drop-shadow-[0_0_10px_rgba(34,211,238,0.8)]">ëŒ€ê¸° ì¤‘</div>
    <div id="dist" class="text-xl text-gray-400 mt-1 font-mono"></div>
</div>

<canvas id="map-canvas"></canvas>

<div class="bottom-panel">
    <div class="flex gap-3 mb-4">
        <div class="flex-1">
            <label class="text-xs text-gray-500 ml-1">ì¶œë°œ</label>
            <select id="start" class="w-full bg-gray-800 text-white p-4 rounded-xl font-bold border border-gray-700 outline-none"></select>
        </div>
        <div class="flex-1">
            <label class="text-xs text-gray-500 ml-1">ë„ì°©</label>
            <select id="end" class="w-full bg-gray-800 text-white p-4 rounded-xl font-bold border border-gray-700 outline-none"></select>
        </div>
    </div>
    
    <div class="text-center text-gray-500 text-xs mb-4 leading-relaxed">
        âš ï¸ <b>ì œìë¦¬ ê±¸ìŒ</b>ì„ í•˜ë©´ ì´ë™í•©ë‹ˆë‹¤.<br>
        í°ì„ ë“¤ê³  ëª¸ì„ ëŒë ¤ ë°©í–¥ì„ ë§ì¶”ì„¸ìš”.
    </div>

    <button id="btn" class="btn">ë‚´ë¹„ ì‹œì‘</button>
</div>

<script>
// --- [ì„¤ì •] ë§µ í¬ê¸° ë° ê±°ë¦¬ê° ì¡°ì ˆ ---
const STEP_LENGTH = 0.000018; // í•œ ê±¸ìŒë‹¹ ì´ë™ ê±°ë¦¬ (ì•½ê°„ í‚¤ì›€)
const GAP = 0.00008; // êµ¬ì—­ ê°„ê²© (ê¸°ì¡´ë³´ë‹¤ 2ë°° ë„“í˜ -> ê±°ë¦¬ê° ì¦ê°€)
const BASE_LAT = 37.0; 
const BASE_LON = 127.0;

// 3x3 ê²©ì ë§µ (ì´ 9ê°œ êµ¬ì—­)
const AREAS = {
    // ì²«ë²ˆì§¸ ì¤„
    A: {name:"ì…êµ­ì¥(Gate 1)", lat:BASE_LAT, lon:BASE_LON},
    B: {name:"ë¡œë° ì„¼í„°", lat:BASE_LAT, lon:BASE_LON + GAP},
    C: {name:"í™˜ì „ì†Œ", lat:BASE_LAT, lon:BASE_LON + GAP*2},
    // ë‘ë²ˆì§¸ ì¤„
    D: {name:"ë©´ì„¸ì  ì¤‘ì•™", lat:BASE_LAT - GAP, lon:BASE_LON},
    E: {name:"í‘¸ë“œì½”íŠ¸", lat:BASE_LAT - GAP, lon:BASE_LON + GAP},
    F: {name:"íƒ‘ìŠ¹ë™ ì…”í‹€", lat:BASE_LAT - GAP, lon:BASE_LON + GAP*2},
    // ì„¸ë²ˆì§¸ ì¤„
    G: {name:"í™”ì¥ì‹¤", lat:BASE_LAT - GAP*2, lon:BASE_LON},
    H: {name:"í‚¤ì¦ˆì¡´", lat:BASE_LAT - GAP*2, lon:BASE_LON + GAP},
    I: {name:"VIP ë¼ìš´ì§€", lat:BASE_LAT - GAP*2, lon:BASE_LON + GAP*2}
};

// ì—°ê²° ì •ë³´ (ê²©ì í˜•íƒœ ì—°ê²°)
const EDGES = [
    ['A','B'], ['B','C'], // 1ì—´ ê°€ë¡œ
    ['D','E'], ['E','F'], // 2ì—´ ê°€ë¡œ
    ['G','H'], ['H','I'], // 3ì—´ ê°€ë¡œ
    ['A','D'], ['D','G'], // 1í–‰ ì„¸ë¡œ
    ['B','E'], ['E','H'], // 2í–‰ ì„¸ë¡œ
    ['C','F'], ['F','I']  // 3í–‰ ì„¸ë¡œ
];

// --- ì‹œìŠ¤í…œ ë³€ìˆ˜ ---
let userPos = null; 
let heading = 0;    
let currentStepCount = 0;
let isNavigating = false;
let path = []; // ê³„ì‚°ëœ ìµœë‹¨ ê²½ë¡œ
let canvas, ctx;

// ê°€ì†ë„ ì„¼ì„œ í•„í„° ë³€ìˆ˜
let lastStepTime = 0;

window.onload = () => {
    canvas = document.getElementById('map-canvas');
    ctx = canvas.getContext('2d');
    
    // Select Box ì±„ìš°ê¸°
    const s = document.getElementById('start');
    const e = document.getElementById('end');
    Object.keys(AREAS).forEach(k => {
        const opt = `<option value="${k}">[${k}] ${AREAS[k].name}</option>`;
        s.innerHTML += opt; e.innerHTML += opt;
    });
    s.value = "A"; e.value = "I"; // ëŒ€ê°ì„  ëìœ¼ë¡œ ê¸°ë³¸ ì„¤ì •

    document.getElementById('btn').onclick = startNav;
    window.addEventListener('resize', resize);
    resize();
    animate();
};

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight * 0.65;
}

function startNav() {
    // iOS ê¶Œí•œ ìš”ì²­
    if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
        DeviceMotionEvent.requestPermission().then(res => {
            if (res === 'granted') initSensors();
        }).catch(console.error);
    } else {
        initSensors();
    }

    const startNode = document.getElementById('start').value;
    const endNode = document.getElementById('end').value;
    
    if(startNode === endNode) return alert("ì¶œë°œì§€ì™€ ë„ì°©ì§€ê°€ ê°™ìŠµë‹ˆë‹¤.");

    // ê¸¸ì°¾ê¸° (BFS)
    path = findShortestPath(startNode, endNode);
    if(!path) return alert("ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

    userPos = {...AREAS[startNode]}; // ì¶œë°œì§€ë¡œ ì´ë™
    isNavigating = true;
    currentStepCount = 0;
    
    const btn = document.getElementById('btn');
    btn.innerText = "ì•ˆë‚´ ì¢…ë£Œ";
    btn.onclick = () => location.reload();
    btn.style.background = "#ef4444"; // ë¹¨ê°„ìƒ‰ ë³€ê²½
    
    updateStatus();
}

function initSensors() {
    // 1. ë°©í–¥ (ë‚˜ì¹¨ë°˜)
    window.addEventListener('deviceorientation', e => {
        if(e.webkitCompassHeading) heading = e.webkitCompassHeading;
        else if(e.alpha) heading = 360 - e.alpha;
    });

    // 2. ê±¸ìŒ ê°ì§€ (ê°€ì†ë„)
    window.addEventListener('devicemotion', e => {
        if(!isNavigating) return;
        const acc = e.accelerationIncludingGravity;
        if(!acc) return;

        const total = Math.sqrt(acc.x*acc.x + acc.y*acc.y + acc.z*acc.z);
        // ê±¸ìŒ ê°ë„: 11.2 (ë„ˆë¬´ ë¯¼ê°í•˜ë©´ 12.0ìœ¼ë¡œ ì˜¬ë¦¬ì„¸ìš”)
        if (total > 11.2) { 
            const now = Date.now();
            if (now - lastStepTime > 450) { // 0.45ì´ˆ ë”œë ˆì´ (ë”°ë‹¥ ë°©ì§€)
                takeStep();
                lastStepTime = now;
            }
        }
    });
}

// í•œ ê±¸ìŒ ì „ì§„ ë¡œì§
function takeStep() {
    currentStepCount++;
    document.getElementById('step-count').innerText = currentStepCount;
    
    // heading ë°©í–¥ìœ¼ë¡œ ì¢Œí‘œ ì´ë™
    const rad = (heading * Math.PI) / 180;
    // ì§€ë„ìƒì—ì„œ ë¶ìª½(Latì¦ê°€)ì„ 0ë„ë¡œ ê°€ì •
    userPos.lat += Math.cos(rad) * STEP_LENGTH; 
    userPos.lon += Math.sin(rad) * STEP_LENGTH;

    updateStatus();
}

function updateStatus() {
    if(!path || path.length === 0) return;

    // í˜„ì¬ ëª©í‘œ ì§€ì  ì°¾ê¸°
    // ê²½ë¡œìƒì˜ ë…¸ë“œë“¤ ì¤‘ ê°€ì¥ ê°€ê¹Œìš´ ë…¸ë“œë¥¼ ì°¾ê³ , ê·¸ ë‹¤ìŒ ë…¸ë“œë¥¼ ì•ˆë‚´
    let minDist = Infinity;
    let nearestIdx = -1;

    path.forEach((node, i) => {
        const d = getDist(userPos, AREAS[node]);
        if(d < minDist) { minDist = d; nearestIdx = i; }
    });

    // ë„ì°© íŒì • (ë§ˆì§€ë§‰ ë…¸ë“œì™€ 5m ì´ë‚´)
    const endNode = AREAS[path[path.length-1]];
    const distToEnd = getDist(userPos, endNode);

    if (distToEnd < 5) {
        document.getElementById('instr').innerText = "ë„ì°© ì™„ë£Œ! ğŸ‰";
        document.getElementById('dist').innerText = "ì•ˆë‚´ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.";
        isNavigating = false;
        return;
    }

    // ë‹¤ìŒ ëª©í‘œ ì•ˆë‚´
    let targetIdx = nearestIdx + 1;
    if (targetIdx >= path.length) targetIdx = path.length - 1;
    
    const targetNode = AREAS[path[targetIdx]];
    document.getElementById('instr').innerHTML = `<span class="text-white">${targetNode.name}</span> ë°©í–¥`;
    document.getElementById('dist').innerText = `ë‚¨ì€ ê±°ë¦¬ ì•½ ${distToEnd.toFixed(0)}m`;
}

// ê°„ë‹¨í•œ BFS ìµœë‹¨ê²½ë¡œ ì•Œê³ ë¦¬ì¦˜
function findShortestPath(start, end) {
    const adj = {};
    EDGES.forEach(([u, v]) => {
        if(!adj[u]) adj[u] = []; if(!adj[v]) adj[v] = [];
        adj[u].push(v); adj[v].push(u);
    });

    let queue = [[start]];
    let visited = new Set([start]);

    while(queue.length > 0) {
        let path = queue.shift();
        let node = path[path.length-1];
        
        if(node === end) return path;

        if(adj[node]) {
            for(let neighbor of adj[node]) {
                if(!visited.has(neighbor)) {
                    visited.add(neighbor);
                    queue.push([...path, neighbor]);
                }
            }
        }
    }
    return null;
}

// ê±°ë¦¬ ê³„ì‚° (ë¯¸í„° ë‹¨ìœ„ ê·¼ì‚¬ì¹˜)
function getDist(pos1, pos2) {
    const dLat = pos1.lat - pos2.lat;
    const dLon = pos1.lon - pos2.lon;
    // ìœ„ë„ 1ë„ = ì•½ 111km -> ë¯¸í„° í™˜ì‚° ë³´ì •
    return Math.sqrt(dLat*dLat + dLon*dLon) / 0.000009; 
}

// --- ë Œë”ë§ (Canvas) ---
function animate() {
    // ë°°ê²½
    ctx.fillStyle = "#000";
    ctx.fillRect(0,0,canvas.width, canvas.height);

    if(!userPos) {
        requestAnimationFrame(animate);
        return;
    }

    // ë§µ ìŠ¤ì¼€ì¼ (í™”ë©´ì— ë‹¤ ë“¤ì–´ì˜¤ê²Œ ì¡°ì •)
    const SCALE = 1800000; 
    const cx = canvas.width/2; 
    const cy = canvas.height * 0.65; // ë‚´ ìœ„ì¹˜ëŠ” ì•½ê°„ ì•„ë˜

    // ì¢Œí‘œ ë³€í™˜ (ë‚´ ìœ„ì¹˜ê°€ í•­ìƒ ì¤‘ì•™, ë‚´ê°€ ë³´ëŠ” ë°©í–¥ì´ í•­ìƒ ìœ„(UP))
    const toScreen = (lat, lon) => {
        let dy = (lat - userPos.lat) * SCALE; // ë¶ìª½ì´ +y
        let dx = (lon - userPos.lon) * SCALE; // ë™ìª½ì´ +x
        
        // íšŒì „ ë³€í™˜ (User Heading ë°˜ëŒ€ë¡œ ë§µì„ íšŒì „)
        const rad = -heading * Math.PI / 180;
        const rx = dx * Math.cos(rad) - dy * Math.sin(rad);
        const ry = dx * Math.sin(rad) + dy * Math.cos(rad);
        
        // Canvas ì¢Œí‘œê³„ëŠ” yê°€ ì•„ë˜ë¡œ ì¦ê°€í•˜ë¯€ë¡œ -ry ì ìš©
        return {x: cx + rx, y: cy - ry}; 
    };

    // 1. ì „ì²´ ê·¸ë¦¬ë“œ ì„  ê·¸ë¦¬ê¸° (íšŒìƒ‰)
    ctx.strokeStyle = "#333";
    ctx.lineWidth = 4;
    ctx.lineCap = "round";
    ctx.beginPath();
    EDGES.forEach(([u, v]) => {
        const p1 = toScreen(AREAS[u].lat, AREAS[u].lon);
        const p2 = toScreen(AREAS[v].lat, AREAS[v].lon);
        ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y);
    });
    ctx.stroke();

    // 2. ê²½ë¡œ í•˜ì´ë¼ì´íŠ¸ (íŒŒë€ìƒ‰)
    if (path && path.length > 0) {
        ctx.strokeStyle = "rgba(0, 255, 255, 0.4)";
        ctx.lineWidth = 20;
        ctx.beginPath();
        for(let i=0; i<path.length-1; i++) {
            const p1 = toScreen(AREAS[path[i]].lat, AREAS[path[i]].lon);
            const p2 = toScreen(AREAS[path[i+1]].lat, AREAS[path[i+1]].lon);
            ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y);
        }
        ctx.stroke();
    }

    // 3. ë…¸ë“œ ê·¸ë¦¬ê¸°
    Object.keys(AREAS).forEach(k => {
        const p = toScreen(AREAS[k].lat, AREAS[k].lon);
        
        // ëª©ì ì§€ ê°•ì¡°
        const isDest = (path && path[path.length-1] === k);
        
        ctx.fillStyle = isDest ? "#ef4444" : "#1e293b";
        ctx.beginPath(); ctx.arc(p.x, p.y, isDest? 12 : 8, 0, Math.PI*2); ctx.fill();
        
        ctx.fillStyle = isDest ? "#fca5a5" : "#94a3b8";
        ctx.font = isDest ? "bold 16px sans-serif" : "12px sans-serif";
        ctx.textAlign="center"; 
        ctx.fillText(AREAS[k].name, p.x, p.y-18);
    });

    // 4. ë‚´ í™”ì‚´í‘œ + ë¶€ì±„ê¼´ (í•­ìƒ í™”ë©´ ì¤‘ì•™ ê³ ì •)
    ctx.save();
    ctx.translate(cx, cy);
    
    // (1) ì‹œì•¼ê° ë¶€ì±„ê¼´ (FOV) - ë…¸ë€ìƒ‰
    // ë§µì€ ëŒë ¸ì§€ë§Œ í™”ì‚´í‘œëŠ” ê³ ì •ì´ë¯€ë¡œ, ë¶€ì±„ê¼´ë„ ê³ ì • (ìœ„ìª½ ë°©í–¥)
    const gradient = ctx.createRadialGradient(0,0, 10, 0,0, 120);
    gradient.addColorStop(0, "rgba(255, 220, 0, 0.3)"); // ì•ˆìª½ ì§„í•œ ë…¸ë‘
    gradient.addColorStop(1, "rgba(255, 220, 0, 0)");   // ë°”ê¹¥ìª½ íˆ¬ëª…
    
    ctx.fillStyle = gradient;
    ctx.beginPath();
    ctx.moveTo(0,0);
    // -90ë„ê°€ ìœ„ìª½(12ì‹œ)ë°©í–¥. ì¢Œìš° 30ë„ì”©(PI/6) ë¶€ì±„ê¼´
    ctx.arc(0, 0, 120, -Math.PI/2 - 0.5, -Math.PI/2 + 0.5); 
    ctx.fill();

    // (2) í™”ì‚´í‘œ ë³¸ì²´
    ctx.fillStyle = "#fff";
    ctx.shadowBlur = 10; ctx.shadowColor="white";
    ctx.beginPath(); 
    ctx.moveTo(0,-18); // ë¨¸ë¦¬
    ctx.lineTo(-12,12); // ì™¼ìª½ ë‚ ê°œ
    ctx.lineTo(0,8);    // ì˜¤ëª©
    ctx.lineTo(12,12);  // ì˜¤ë¥¸ìª½ ë‚ ê°œ
    ctx.fill();
    
    ctx.restore();

    requestAnimationFrame(animate);
}
</script>
</body>
</html>