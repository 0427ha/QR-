<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>Indoor PDR Nav</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
    body { background: #000; color: white; margin:0; overflow: hidden; touch-action: none; font-family: sans-serif; }
    #map-canvas { width:100%; height:65vh; background:#111; border-radius:0 0 30px 30px; }
    .overlay { position: absolute; top: 20px; width: 100%; text-align: center; z-index: 10; pointer-events: none; }
    .bottom-panel { position: absolute; bottom: 0; width: 100%; height: 35vh; background: #000; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; }
    .btn { background: #3b82f6; color: white; border:none; padding: 20px; font-size: 1.2rem; font-weight: bold; border-radius: 15px; width: 100%; margin-top: auto; }
    .step-counter { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; color: #aaa; }
    </style>
</head>
<body>

<div class="step-counter">ê±¸ìŒ ìˆ˜: <span id="step-count">0</span></div>

<div class="overlay">
    <div id="instr" class="text-3xl font-black text-cyan-400 drop-shadow-md">ì¶œë°œì§€ ì„ íƒ</div>
    <div id="dist" class="text-xl text-gray-400 mt-1"></div>
</div>

<canvas id="map-canvas"></canvas>

<div class="bottom-panel">
    <div class="text-gray-500 text-sm text-center mb-4">
        ì‹¤ë‚´ ëª¨ë“œ: í°ì„ ë“¤ê³  <b>ì œìë¦¬ ê±¸ìŒ</b>ì„ í•´ë³´ì„¸ìš”.<br>
        (ê°€ì†ë„ ì„¼ì„œë¡œ ê±¸ìŒì„ ê°ì§€í•©ë‹ˆë‹¤)
    </div>
    <div class="flex gap-2 mb-4">
        <select id="start" class="bg-gray-800 text-white p-3 rounded-lg flex-1"></select>
        <select id="end" class="bg-gray-800 text-white p-3 rounded-lg flex-1"></select>
    </div>
    <button id="btn" class="btn">ë‚´ë¹„ ì‹œì‘</button>
</div>

<script>
// --- ì„¤ì •: 1ê±¸ìŒë‹¹ ì´ë™ ê±°ë¦¬ (ë‹¨ìœ„: ìœ„ê²½ë„) ---
// ì‹¤ë‚´ ì§€ë„ ìŠ¤ì¼€ì¼ (ì‘ê²Œ ì„¤ì •)
const STEP_LENGTH = 0.000015; // ì•½ 1.5m
const BASE_LAT = 37.0; const BASE_LON = 127.0;
const GAP = 0.00005; // êµ¬ì—­ ê°„ê²©

const AREAS = {
    A: {name:"ì²´í¬ì¸ ì¹´ìš´í„°", lat:BASE_LAT, lon:BASE_LON},
    B: {name:"ë³´ì•ˆ ê²€ìƒ‰ëŒ€", lat:BASE_LAT + GAP, lon:BASE_LON},
    C: {name:"ë©´ì„¸ì  ì…êµ¬", lat:BASE_LAT + GAP*2, lon:BASE_LON},
    D: {name:"íƒ‘ìŠ¹ ê²Œì´íŠ¸", lat:BASE_LAT + GAP*2, lon:BASE_LON + GAP},
    E: {name:"í•­ê³µê¸° íƒ‘ìŠ¹", lat:BASE_LAT + GAP*2, lon:BASE_LON + GAP*2}
};

const EDGES = [
    {u:"A", v:"B"}, {u:"B", v:"C"}, {u:"C", v:"D"}, {u:"D", v:"E"}
];

// --- ë³€ìˆ˜ ---
let userPos = null; // í˜„ì¬ ë‚´ ìœ„ì¹˜
let heading = 0;    // í°ì´ ë³´ëŠ” ë°©í–¥ (0~360)
let currentStepCount = 0;
let isNavigating = false;
let route = [];
let canvas, ctx;

// ê°€ì†ë„ ì„¼ì„œ ê´€ë ¨
let lastAcc = {x:0, y:0, z:0};
let lastStepTime = 0;

window.onload = () => {
    canvas = document.getElementById('map-canvas');
    ctx = canvas.getContext('2d');
    
    const s = document.getElementById('start');
    const e = document.getElementById('end');
    Object.keys(AREAS).forEach(k => {
        const opt = `<option value="${k}">${AREAS[k].name}</option>`;
        s.innerHTML += opt; e.innerHTML += opt;
    });
    s.value = "A"; e.value = "E";

    document.getElementById('btn').onclick = startNav;
    window.addEventListener('resize', resize);
    resize();
    animate();
};

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight * 0.65;
}

function startNav() {
    // ê¶Œí•œ ìš”ì²­ (iOS 13+ ëŒ€ì‘)
    if (typeof DeviceMotionEvent.requestPermission === 'function') {
        DeviceMotionEvent.requestPermission().then(response => {
            if (response == 'granted') initSensors();
        }).catch(console.error);
    } else {
        initSensors();
    }

    const startKey = document.getElementById('start').value;
    const endKey = document.getElementById('end').value;
    
    // ë‹¨ìˆœ ê²½ë¡œ ìƒì„± (A->B->C...)
    route = Object.keys(AREAS).filter(k => k >= startKey && k <= endKey);
    if(startKey > endKey) route = route.reverse();

    userPos = {...AREAS[startKey]}; // ì‹œì‘ ìœ„ì¹˜ë¡œ ì í”„
    isNavigating = true;
    currentStepCount = 0;
    
    document.getElementById('btn').innerText = "ì¬ì„¤ì •";
    document.getElementById('btn').onclick = () => location.reload();
    document.getElementById('instr').innerText = "ì´ë™ ì‹œì‘";
}

function initSensors() {
    // 1. ë‚˜ì¹¨ë°˜ (ë°©í–¥)
    window.addEventListener('deviceorientation', e => {
        if(e.webkitCompassHeading) heading = e.webkitCompassHeading;
        else if(e.alpha) heading = 360 - e.alpha;
    });

    // 2. ê°€ì†ë„ (ê±¸ìŒ ê°ì§€ - Pedometer)
    window.addEventListener('devicemotion', e => {
        if(!isNavigating) return;
        
        const acc = e.accelerationIncludingGravity;
        if(!acc) return;

        // ì¤‘ë ¥ ê°€ì†ë„ ì œê±°ë¥¼ ìœ„í•œ ê°„ë‹¨í•œ í•„í„°
        // ê±¸ì„ ë•Œ ë°œìƒí•˜ëŠ” ìƒí•˜ í”ë“¤ë¦¼(Zì¶• or Total Magnitude) ê°ì§€
        const total = Math.sqrt(acc.x*acc.x + acc.y*acc.y + acc.z*acc.z);
        
        // ì„ê³„ê°’ 11.0 (ì¤‘ë ¥ 9.8ë³´ë‹¤ ì¡°ê¸ˆ í¼) - í°ì„ ë“¤ê³  ê±¸ì„ ë•Œ íŠ€ëŠ” ê°’
        // ë„ˆë¬´ ë¯¼ê°í•˜ë©´ ê°’ì„ ì˜¬ë¦¬ì„¸ìš” (12.0 ~ 13.0)
        if (total > 11.5) { 
            const now = Date.now();
            if (now - lastStepTime > 400) { // 0.4ì´ˆ ë‚´ ì¤‘ë³µ ê°ì§€ ë°©ì§€
                takeStep();
                lastStepTime = now;
            }
        }
    });
}

// --- í•µì‹¬: í•œ ê±¸ìŒ ì´ë™ ---
function takeStep() {
    currentStepCount++;
    document.getElementById('step-count').innerText = currentStepCount;
    
    // heading(ê°ë„) ë°©í–¥ìœ¼ë¡œ ì¢Œí‘œ ì´ë™
    // ìœ„ë„(y): cos, ê²½ë„(x): sin
    const rad = (heading * Math.PI) / 180;
    
    // ë¶ìª½ì´ 0ë„ë¼ ê°€ì •í•˜ê³  ì¢Œí‘œê³„ì— ë§ì¶¤ (ì§€ë„ ìƒ ë¶ìª½ = Lat ì¦ê°€)
    // ì‹¤ì œë¡œëŠ” ì¢Œí‘œê³„ ë³€í™˜ì´ ë³µì¡í•˜ì§€ë§Œ, ì—¬ê¸°ì„  ë‹¨ìˆœí™”
    // heading 0ë„(ë¶) -> yê°ì†Œ? í™”ë©´ìƒ ìœ„ìª½ì´ ë¶ìª½ì´ë©´ lat ì¦ê°€
    // ìŠ¤ë§ˆíŠ¸í° ë‚˜ì¹¨ë°˜: 0=ë¶, 90=ë™, 180=ë‚¨, 270=ì„œ
    
    // lat(ìœ„ë„)ëŠ” yì¶• ë°©í–¥, lon(ê²½ë„)ëŠ” xì¶• ë°©í–¥
    userPos.lat += Math.cos(rad) * STEP_LENGTH; 
    userPos.lon += Math.sin(rad) * STEP_LENGTH;

    checkArrival();
}

function checkArrival() {
    const targetKey = route[route.length-1];
    const target = AREAS[targetKey];
    
    // ê±°ë¦¬ ê³„ì‚°
    const dLat = (userPos.lat - target.lat);
    const dLon = (userPos.lon - target.lon);
    const dist = Math.sqrt(dLat*dLat + dLon*dLon) / 0.00001; // ëŒ€ëµ m í™˜ì‚°

    document.getElementById('dist').innerText = `ëª©ì ì§€ê¹Œì§€ ${dist.toFixed(0)}m`;
    
    if(dist < 5) {
        document.getElementById('instr').innerText = "ë„ì°© ì™„ë£Œ! ğŸ‰";
        isNavigating = false;
    }
}

// --- ê·¸ë¦¬ê¸° ë£¨í”„ ---
function animate() {
    ctx.fillStyle = "black";
    ctx.fillRect(0,0,canvas.width, canvas.height);

    if(!userPos) {
        requestAnimationFrame(animate);
        return;
    }

    const SCALE = 3000000;
    const cx = canvas.width/2; 
    const cy = canvas.height * 0.6;

    // ë³€í™˜ í•¨ìˆ˜ (ë‚´ ìœ„ì¹˜ê°€ í•­ìƒ ì¤‘ì•™)
    const toScreen = (lat, lon) => {
        let dy = (lat - userPos.lat) * SCALE;
        let dx = (lon - userPos.lon) * SCALE;
        
        // í™”ë©´ íšŒì „ (ë‚´ê°€ ë³´ëŠ” ë°©í–¥ì´ í•­ìƒ ìœ„ìª½)
        const rad = -heading * Math.PI / 180;
        const rx = dx * Math.cos(rad) - (-dy) * Math.sin(rad);
        const ry = dx * Math.sin(rad) + (-dy) * Math.cos(rad);
        
        return {x: cx + rx, y: cy + ry}; // yì¶• ë°˜ì „ ì—†ìŒ (ë‹¨ìˆœí™”)
    };

    // ê²½ë¡œ ê·¸ë¦¬ê¸°
    ctx.strokeStyle = "#333";
    ctx.lineWidth = 20;
    ctx.beginPath();
    Object.keys(AREAS).forEach((k, i) => {
        const p = toScreen(AREAS[k].lat, AREAS[k].lon);
        if(i==0) ctx.moveTo(p.x, p.y); else ctx.lineTo(p.x, p.y);
    });
    ctx.stroke();
    
    // ë…¸ë“œ
    Object.keys(AREAS).forEach(k => {
        const p = toScreen(AREAS[k].lat, AREAS[k].lon);
        ctx.fillStyle = "#555";
        ctx.beginPath(); ctx.arc(p.x, p.y, 8, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "#fff"; ctx.textAlign="center"; 
        ctx.fillText(AREAS[k].name, p.x, p.y-15);
    });

    // ë‚´ í™”ì‚´í‘œ (ì¤‘ì•™ ê³ ì •)
    ctx.save();
    ctx.translate(cx, cy);
    // ë§µì„ ëŒë ¸ìœ¼ë¯€ë¡œ í™”ì‚´í‘œëŠ” ê³ ì •
    ctx.fillStyle = "#00ffff";
    ctx.beginPath(); ctx.moveTo(0,-15); ctx.lineTo(-10,10); ctx.lineTo(0,5); ctx.lineTo(10,10); ctx.fill();
    ctx.restore();

    requestAnimationFrame(animate);
}
</script>
</body>
</html>