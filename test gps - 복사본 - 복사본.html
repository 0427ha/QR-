<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ê³µí•­ ì‹¤ë‚´ ë‚´ë¹„ê²Œì´ì…˜ - Tesla Style</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
    body {
        font-family: 'SF Pro Display', -apple-system, sans-serif;
        background: #000;
        color: white;
        margin:0;
        min-height: 100dvh;
        overflow-x: hidden;
    }
    .tesla-bg { background: #000000; }                   /* ì „ì²´ ë°°ê²½ ì—°í•œ íšŒìƒ‰ */
	#map-canvas {
    width:100%;
    height:520px;
    background:#000000;                /* ê²‰ í…Œë‘ë¦¬ëŠ” ê²€ì • */
    border-radius:20px;
    border: 1px solid #333;
    box-shadow: 0 4px 30px rgba(0,0,0,0.6);
    overflow: hidden;
    padding: 16px;                      /* ì´ê²Œ í•µì‹¬! ì•ˆìª½ë§Œ í°ìƒ‰ ë˜ê²Œ íŒ¨ë”© ì¤Œ */
    box-sizing: border-box;
}
    	.card {
        background: rgba(15,15,15,0.9);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255,255,255,0.08);
        padding:1.5rem;
        border-radius:20px;
    }

    /* í•˜ë‹¨ ë‚´ë¹„ ë°” í¬ê¸° ëŒ€í­ ì¶•ì†Œ + ê¹”ë”í•˜ê²Œ */
    #nav-bar {
        position:fixed; bottom:0; left:0; right:0;
        background: rgba(0,0,0,0.95);
        backdrop-filter: blur(30px);
        border-top: 1px solid rgba(255,255,255,0.08);
        padding:1rem 1rem 2rem;
        z-index:1000;
        transform: translateY(100%);
        transition: transform 0.4s ease;
    }
    #nav-bar.active { transform: translateY(0); }

    /* í…ìŠ¤íŠ¸ ë°˜ì§ì„ ì™„ì „ ì œê±° + í¬ê¸° ì¡°ì ˆ */
    #instruction {
        font-size: 2.2rem;          /* ê¸°ì¡´ 4xl â†’ ì¡°ê¸ˆ ì¤„ì„ */
        font-weight: 800;
        color: white !important;
        text-shadow: none !important; /* ë°˜ì§ì„ ì™„ì „ ì œê±° */
        line-height: 1.2;
    }
    #distance {
        font-size: 1.3rem;           /* ì‘ê³  ê¹”ë”í•˜ê²Œ */
        color: #888;
        margin-top: 0.5rem;
        /* ìœ„ì•„ë˜ ê°„ê²© ì¤„ì„ */
    }
    #icon i {
        width: 60px !important;       /* ì•„ì´ì½˜ í¬ê¸° ì¤„ì„ */
        height: 60px !important;
    }

    /* í…ŒìŠ¬ë¼ ì°¨ëŸ‰ ë„ˆë¬´ ì»¸ë˜ ê±° â†’ ë”± ì ë‹¹í•œ ì‚¬ì´ì¦ˆë¡œ */
    .tesla-car {
        filter: drop-shadow(0 0 20px #ffff00); /* ë¹›ì€ ë‚¨ê¸°ë˜ ê³¼í•˜ì§€ ì•Šê²Œ */
    }

    /* ë²„íŠ¼ë„ ì¢€ ì‘ê²Œ */
    #nav-btn {
        font-size: 1.4rem !important;
        padding: 1rem 2.5rem !important;
        border-radius: 999px;
    }
</style>
</head>
<body class="tesla-bg text-white">

<div class="max-w-5xl mx-auto p-5 pb-40">
    <div class="text-center mb-10 mt-8">
        <h1 class="text-5xl font-black tracking-tighter tesla-text">AIRPORT NAVIGATION</h1>
        <p class="text-gray-500 mt-2 text-sm">ì‹¤ë‚´ GPS + QR ì—°ë™ ì‹œìŠ¤í…œ</p>
    </div>

    <div class="card mb-6">
        <div id="status" class="p-5 rounded-2xl status-err text-center text-xl font-bold mb-6">
            ì¤€ë¹„ ì¤‘: ì¶œë°œì§€ì™€ ë„ì°©ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
                <label class="block text-cyan-400 font-bold text-lg mb-2">
                    ì¶œë°œ êµ¬ì—­
                    <span id="qr-hint" class="block text-xs text-cyan-300 mt-1"></span>
                </label>
                <select id="start" class="w-full p-5 bg-black/70 border border-gray-700 rounded-2xl text-xl font-medium focus:ring-4 focus:ring-cyan-500 focus:border-cyan-500 transition"></select>
            </div>
            <div>
                <label class="block text-cyan-400 font-bold text-lg mb-2">ë„ì°© êµ¬ì—­</label>
                <select id="end" class="w-full p-5 bg-black/70 border border-gray-700 rounded-2xl text-xl font-medium focus:ring-4 focus:ring-cyan-500 focus:border-cyan-500 transition"></select>
            </div>
            <div class="flex items-end">
                <button id="find" class="w-full bg-gradient-to-r from-cyan-500 to-blue-600 text-white font-black text-2xl py-6 rounded-2xl hover:from-cyan-400 hover:to-blue-500 transform hover:scale-105 transition shadow-2xl">
                    ê²½ë¡œ ì°¾ê¸°
                </button>
            </div>
        </div>
    </div>

    <div class="card">
        <h2 class="text-3xl font-black mb-5 tesla-text flex items-center gap-4">
            <i data-lucide="navigation" class="w-10 h-10"></i> ì‹¤ë‚´ ì§€ë„
        </h2>
        <canvas id="map-canvas"></canvas>
        <div id="info" class="mt-6 text-2xl font-bold text-center bg-black/50 rounded-2xl py-5 tesla-text"></div>
    </div>
</div>

<!-- í…ŒìŠ¬ë¼ ìŠ¤íƒ€ì¼ í•˜ë‹¨ ë‚´ë¹„ ë°” -->
<div id="nav-bar">
    <div class="max-w-5xl mx-auto">
        <div class="bg-black/80 backdrop-blur-xl rounded-3xl p-8 border border-white/10 shadow-2xl">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-8">
                    <div id="icon" class="tesla-car">
                        <i data-lucide="navigation" class="w-14 h-14 text-cyan-400"></i>
                    </div>
                    <div>
                        <div id="instruction" class="text-4xl font-black leading-tight" style="color:#00ffff; text-shadow: 0 0 20px #00ffff;">
                            ëŒ€ê¸° ì¤‘
                        </div>
                        <div id="distance" class="text-2xl text-cyan-200 mt-2 font-bold">ë‚¨ì€ ê²½ë¡œ: -</div>
                    </div>
                </div>
                <button id="nav-btn" class="bg-white text-black font-black text-2xl px-16 py-7 rounded-full shadow-2xl hover:scale-110 transition disabled:opacity-40" disabled>
                    ë‚´ë¹„ ì‹œì‘
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// ë°ì´í„° ì •ì˜
const AREAS = {
    A: {name:"êµ­ì œì„  ë„ì°©", lat:37.510000, lon:127.050000},
    B: {name:"ë©´ì„¸í’ˆ ìˆ˜ë ¹", lat:37.510000, lon:127.051800},
    C: {name:"í™˜ì „ì†Œ", lat:37.510000, lon:127.053600},
    D: {name:"êµ­ë‚´ì„  ì²´í¬ì¸", lat:37.508500, lon:127.050000},
    E: {name:"ì¶œêµ­ ì‹¬ì‚¬ëŒ€", lat:37.508500, lon:127.051800},
    F: {name:"í‘¸ë“œì½”íŠ¸", lat:37.508500, lon:127.053600},
    G: {name:"ë¼ìš´ì§€", lat:37.507000, lon:127.050000},
    H: {name:"ë©´ì„¸ì  ì¤‘ì•™", lat:37.507000, lon:127.051800},
    I: {name:"íƒ‘ìŠ¹ ê²Œì´íŠ¸", lat:37.507000, lon:127.053600}
};

// ì—£ì§€(ì—°ê²°) ë°ì´í„° (ì–‘ë°©í–¥ì„ ìœ„í•´ ALL_EDGESë¥¼ ìƒì„±í•˜ëŠ” ê¸°ë³¸ ë°ì´í„°)
const EDGES_DATA = [
    {u:"A", v:"B", dist:15, instr:"ë©´ì„¸í’ˆ ìˆ˜ë ¹ ë°©í–¥ìœ¼ë¡œ ì§ì§„", turn:"arrow-right"}, // A->B ë°©í–¥ ë³€ê²½
    {u:"B", v:"C", dist:15, instr:"í™˜ì „ì†Œ ë°©í–¥ìœ¼ë¡œ ìš°íšŒì „ í›„ ì§ì§„", turn:"corner-down-right"},
    {u:"D", v:"E", dist:15, instr:"ì¶œêµ­ ì‹¬ì‚¬ëŒ€ ë°©í–¥ìœ¼ë¡œ ì§ì§„", turn:"arrow-right"}, // D->E ë°©í–¥ ë³€ê²½
    {u:"E", v:"F", dist:15, instr:"í‘¸ë“œì½”íŠ¸ ë°©í–¥ìœ¼ë¡œ ì§ì§„", turn:"arrow-right"},
    {u:"G", v:"H", dist:15, instr:"ë©´ì„¸ì  ì¤‘ì•™ êµ¬ì—­ ë°©í–¥ìœ¼ë¡œ ì§ì§„", turn:"arrow-right"},
    {u:"H", v:"I", dist:15, instr:"íƒ‘ìŠ¹ ê²Œì´íŠ¸ ë°©í–¥ìœ¼ë¡œ ì§ì§„", turn:"arrow-right"},
    {u:"A", v:"D", dist:17, instr:"2ì¸µ êµ­ë‚´ì„  ì²´í¬ì¸ ë°©í–¥ ì—ìŠ¤ì»¬ë ˆì´í„° ì´ìš©", turn:"arrow-down"}, // A->D ë°©í–¥ ë³€ê²½
    {u:"B", v:"E", dist:17, instr:"2ì¸µ ì¶œêµ­ ì‹¬ì‚¬ëŒ€ ë°©í–¥ ì—ìŠ¤ì»¬ë ˆì´í„° ì´ìš©", turn:"arrow-down"},
    {u:"C", v:"F", dist:17, instr:"2ì¸µ í‘¸ë“œì½”íŠ¸ ë°©í–¥ ì—ìŠ¤ì»¬ë ˆì´í„° ì´ìš©", turn:"arrow-down"},
    {u:"D", v:"G", dist:17, instr:"3ì¸µ ë¼ìš´ì§€ ë°©í–¥ ì—ìŠ¤ì»¬ë ˆì´í„° ì´ìš©", turn:"arrow-down"},
    {u:"E", v:"H", dist:17, instr:"3ì¸µ ë©´ì„¸ì  ì¤‘ì•™ ë°©í–¥ ì—ìŠ¤ì»¬ë ˆì´í„° ì´ìš©", turn:"arrow-down"},
    {u:"F", v:"I", dist:17, instr:"3ì¸µ íƒ‘ìŠ¹ ê²Œì´íŠ¸ ë°©í–¥ ì—ìŠ¤ì»¬ë ˆì´í„° ì´ìš©", turn:"arrow-down"},
    {u:"A", v:"E", dist:21, instr:"ì¤‘ì•™ í™€ì„ ê°€ë¡œì§ˆëŸ¬ ì¶œêµ­ ì‹¬ì‚¬ëŒ€ ë°©í–¥ìœ¼ë¡œ ì§ì§„", turn:"arrow-right"},
    {u:"B", v:"D", dist:21, instr:"ì¤‘ì•™ í™€ì„ ê°€ë¡œì§ˆëŸ¬ êµ­ë‚´ì„  ì²´í¬ì¸ ë°©í–¥ìœ¼ë¡œ ì§ì§„", turn:"arrow-left"},
    {u:"B", v:"F", dist:21, instr:"í‘¸ë“œì½”íŠ¸ ë°©í–¥ìœ¼ë¡œ ìš°íšŒì „", turn:"corner-down-right"},
    {u:"E", v:"C", dist:21, instr:"í™˜ì „ì†Œ ë°©í–¥ìœ¼ë¡œ ì¢ŒíšŒì „", turn:"corner-down-left"}
];
// ì–‘ë°©í–¥ ì—°ê²° ì „ì²´ ë¦¬ìŠ¤íŠ¸ (ë‹¤ìµìŠ¤íŠ¸ë¼ìš©)
const ALL_EDGES = [];
EDGES_DATA.forEach(edge => {
    // ìˆœë°©í–¥ ì¶”ê°€
    ALL_EDGES.push({ from: edge.u, to: edge.v, dist: edge.dist, instruction: edge.instr, icon: edge.turn });
    // ì—­ë°©í–¥ ì¶”ê°€ (ê°„ë‹¨í•˜ê²Œ ì—­ë°©í–¥ ì„¤ëª… ìƒì„±)
    ALL_EDGES.push({ 
        from: edge.v, 
        to: edge.u, 
        dist: edge.dist, 
        instruction: edge.instr.replace(/ë°©í–¥ìœ¼ë¡œ ì§ì§„|ë°©í–¥ìœ¼ë¡œ ìš°íšŒì „|ë°©í–¥ìœ¼ë¡œ ì¢ŒíšŒì „/g, 'ë°©í–¥ìœ¼ë¡œ ë˜ëŒì•„ê°').replace(/ì´ìš©/g, 'ì´ìš© í›„ ë˜ëŒì•„ê°'), 
        icon: {
            'arrow-right': 'arrow-left',
            'arrow-left': 'arrow-right',
            'arrow-down': 'arrow-up',
            'arrow-up': 'arrow-down',
            'corner-down-right': 'corner-down-left',
            'corner-down-left': 'corner-down-right'
        }[edge.turn] || 'arrow-left' // ì—­ë°©í–¥ ì•„ì´ì½˜ì„ ë°˜ëŒ€ë¡œ ì„¤ì •
    });
});


// ì „ì—­ ë³€ìˆ˜
let canvas, ctx, route = null, watching = false, watchId = null;
let userPos = null, heading = 0, offset = {lat:0, lon:0};
let scale = 1, tx = 0, ty = 0; // ì¤Œ/íŒ¬ ë³€ìˆ˜

// URL íŒŒë¼ë¯¸í„°ë¥¼ ì½ëŠ” í•¨ìˆ˜
function getUrlParam(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
}

// DOM ë¡œë“œ í›„ ì´ˆê¸°í™”
window.onload = function() {
    canvas = document.getElementById('map-canvas');
    ctx = canvas.getContext('2d');
    
    // ì…€ë ‰íŠ¸ ì±„ìš°ê¸°
    const startSel = document.getElementById('start');
    const endSel = document.getElementById('end');
    Object.keys(AREAS).forEach(k => {
        const opt = `<option value="${k}">${k} - ${AREAS[k].name}</option>`;
        startSel.insertAdjacentHTML('beforeend', opt);
        endSel.insertAdjacentHTML('beforeend', opt);
    });
    startSel.value = "A"; // ê¸°ë³¸ê°’ ì„¤ì •
    endSel.value = "I";
    
    // ğŸš¨ URL íŒŒë¼ë¯¸í„° 'area' í™•ì¸ ë° ì¶œë°œì§€ ì„¤ì • (ë„ì°©ì§€ ëŒ€ì‹  ì¶œë°œì§€ë¡œ ë³€ê²½)
    const initialStart = getUrlParam('area'); // 'area' íŒŒë¼ë¯¸í„° ì‚¬ìš©
    let isValidInitialStart = false;
    
    if (initialStart) {
        const startId = initialStart.toUpperCase().trim();
        if (AREAS[startId]) {
            startSel.value = startId; // ğŸ‘ˆ ì¶œë°œì§€ë¡œ ì„¤ì •
            document.getElementById('qr-hint').textContent = `(URL: ${startId}ë¡œ ì¶œë°œì§€ ì„¤ì •ë¨)`;
            updateStatus("ok", `URL íŒŒë¼ë¯¸í„°: ì¶œë°œì§€ê°€ ${AREAS[startId].name}ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ë„ì°©ì§€ë¥¼ ì„ íƒí•˜ê³  ê²½ë¡œ ì°¾ê¸°ë¥¼ ëˆ„ë¥´ì„¸ìš”.`);
            isValidInitialStart = true;
        }
    }


    // ì´ë²¤íŠ¸
    document.getElementById('find').onclick = findRoute;
    document.getElementById('nav-btn').onclick = toggleNav;
    setupCanvasEvents();
    resizeCanvas();
    draw();
    lucide.createIcons();
    
    // ìœ íš¨í•œ area íŒŒë¼ë¯¸í„°ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ìƒíƒœ ë©”ì‹œì§€ ìœ ì§€
    if (!isValidInitialStart) {
        updateStatus("err", "ì¤€ë¹„ ì¤‘: ì¶œë°œì§€ì™€ ë„ì°©ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
    }
};

function resizeCanvas() {
    const w = canvas.parentElement.clientWidth;
    // ê°€ë¡œ í­ì— ë”°ë¼ ìº”ë²„ìŠ¤ í¬ê¸°ë¥¼ ì¡°ì ˆí•˜ì—¬ ë°˜ì‘í˜•ìœ¼ë¡œ ë§Œë“­ë‹ˆë‹¤.
    canvas.width = w > 900 ? 900 : w; 
    canvas.height = canvas.width * 0.6; // ê°€ë¡œì„¸ë¡œ ë¹„ìœ¨ ìœ ì§€
    if (canvas.height < 400) canvas.height = 400;
    draw();
}
window.addEventListener('resize', resizeCanvas);

// -------------------------
// ë‚´ë¹„ê²Œì´ì…˜ ë° ê²½ë¡œ ë¡œì§
// -------------------------

function findRoute() {
    if(watching) stopNav(); // ê²½ë¡œ ì¬íƒìƒ‰ ì‹œ ë‚´ë¹„ ì •ì§€

    const start = document.getElementById('start').value;
    const end = document.getElementById('end').value;
    
    if (start === end) {
        updateStatus("err", "ì¶œë°œì§€ì™€ ë„ì°©ì§€ê°€ ê°™ìŠµë‹ˆë‹¤!");
        return; 
    }

    route = dijkstra(start, end);
    if (!route) {
        updateStatus("err", "ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”");
        document.getElementById('nav-btn').disabled = true;
        document.getElementById('nav-bar').classList.remove('active');
        return;
    }
    
    route.currentStep = 0; // ê²½ë¡œ ì°¾ì„ ë•Œ ë‹¨ê³„ ì´ˆê¸°í™”

    document.getElementById('info').innerHTML = 
        `<strong>ì´ ê²½ë¡œ ê¸¸ì´: ${route.dist.toFixed(0)}m | ì˜ˆìƒ ì†Œìš” ì‹œê°„ ì•½ ${Math.ceil(route.dist/80)}ë¶„</strong>`;

    document.getElementById('nav-btn').disabled = false;
    document.getElementById('nav-btn').textContent = "ë‚´ë¹„ ì‹œì‘";
    document.getElementById('nav-btn').classList.replace('bg-red-500','bg-green-500');
    document.getElementById('nav-bar').classList.add('active');
    
    updateNavUI(route.steps[0].instruction, route.dist);
    draw();
    updateStatus("ok", "ê²½ë¡œ ê³„ì‚° ì™„ë£Œ! 'ë‚´ë¹„ ì‹œì‘'ì„ ëˆ„ë¥´ì„¸ìš”.");
}

function toggleNav() {
    if (!route) return;
    
    if (document.getElementById('nav-btn').textContent === "ì¬ì„¤ì •") {
        resetApp(); 
        return;
    }

    if (watching) {
        stopNav();
    } else {
        startNav();
    }
}

function startNav() {
    if (!navigator.geolocation) {
        updateStatus("err", "GPSë¥¼ ì§€ì›í•˜ì§€ ì•Šì•„ìš”");
        return;
    }
    
    watching = true;
    document.getElementById('nav-btn').textContent = "ì •ì§€";
    document.getElementById('nav-btn').classList.replace('bg-green-500','bg-red-500');
    updateStatus("ok", "GPS ì—°ê²° ì¤‘...");

    // ë°©í–¥ ì„¼ì„œ
    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission().then(r => {
            if (r === 'granted') window.addEventListener('deviceorientation', oriHandler);
        }).catch(e => console.error("Orientation permission denied:", e));
    } else {
        window.addEventListener('deviceorientation', oriHandler);
    }

    // GPS ì‹œì‘ (ì˜¤í”„ì…‹ ê³„ì‚° ë° ì´ˆê¸° ìœ„ì¹˜ ì„¤ì •)
    navigator.geolocation.getCurrentPosition(pos => {
        const realLat = pos.coords.latitude;
        const realLon = pos.coords.longitude;
        const startArea = AREAS[route.path[0]];
        // ì˜¤í”„ì…‹ ê³„ì‚° (ì‹¤ì œ GPSì™€ ê°€ìƒ ì§€ë„ ì‹œì‘ì ì˜ ì°¨ì´)
        offset.lat = realLat - startArea.lat;
        offset.lon = realLon - startArea.lon;
        updateStatus("ok", "ì˜¤í”„ì…‹ ì„¤ì • ì™„ë£Œ! ì´ë™ ì‹œì‘í•˜ì„¸ìš”");
        
        // ì²« ìœ„ì¹˜ ì²˜ë¦¬
        onLocation(pos);
    }, onError, { enableHighAccuracy: true, timeout: 5000 });

    watchId = navigator.geolocation.watchPosition(onLocation, onError, {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 5000
    });
}

function stopNav() {
    watching = false;
    if (watchId) navigator.geolocation.clearWatch(watchId);
    window.removeEventListener('deviceorientation', oriHandler);
    document.getElementById('nav-btn').textContent = "ì¬ê°œ";
    document.getElementById('nav-btn').classList.replace('bg-red-500','bg-yellow-500');
    updateStatus("err", "ë‚´ë¹„ê²Œì´ì…˜ ì¼ì‹œ ì •ì§€ë¨");
}

function onLocation(pos) {
    if (!watching || !route) return;

    const realLat = pos.coords.latitude;
    const realLon = pos.coords.longitude;
    
    // ì˜¤í”„ì…‹ ì ìš©í•´ì„œ ì§€ë„ ì¢Œí‘œê³„ë¡œ ë³€í™˜
    userPos = {
        lat: realLat - offset.lat,
        lon: realLon - offset.lon,
        acc: pos.coords.accuracy
    };

    updateStatus("ok", `GPS ì¶”ì  ì¤‘ | ì •í™•ë„ ${pos.coords.accuracy.toFixed(1)}m`);

    const step = route.steps[route.currentStep];
    const target = AREAS[step.to];
    
    // 1. í˜„ì¬ ìœ„ì¹˜ì—ì„œ ë‹¤ìŒ ë…¸ë“œê¹Œì§€ì˜ ì§ì„  ê±°ë¦¬ (ë‹¨ê³„ í†µê³¼ ì¡°ê±´)
    const distToNextNode = haversine(userPos.lat, userPos.lon, target.lat, target.lon); 
    
    // 2. ì´ ë‚¨ì€ ê²½ë¡œ ê±°ë¦¬ ê³„ì‚°
    // í˜„ì¬ ë‹¨ê³„ì˜ ë‚¨ì€ ê±°ë¦¬ë¥¼ í•´ë‹¹ ë‹¨ê³„ì˜ ì •ì˜ëœ ê¸¸ì´(step.dist)ë¡œ ì œí•œí•˜ì—¬, GPS ì˜¤ì°¨ë¡œ ì¸í•œ ì´ ê±°ë¦¬ ë¶€í’€ë¦¼ì„ ë°©ì§€í•©ë‹ˆë‹¤.
    let currentStepRemaining = Math.min(step.dist, distToNextNode);

    let totalRemainingDist = 0;
    // í˜„ì¬ ë‹¨ê³„ì˜ ë‚¨ì€ ê±°ë¦¬ë¥¼ ìš°ì„  ì¶”ê°€
    totalRemainingDist += currentStepRemaining; 
    
    // ë‹¤ìŒ ë‹¨ê³„ë“¤ì˜ ê±°ë¦¬ ì¶”ê°€
    for (let i = route.currentStep + 1; i < route.steps.length; i++) {
        totalRemainingDist += route.steps[i].dist;
    }

    // ë‚´ë¹„ê²Œì´ì…˜ UI ì—…ë°ì´íŠ¸ (ì´ ë‚¨ì€ ê±°ë¦¬ ì‚¬ìš©)
    updateNavUI(step.instruction, totalRemainingDist);
    
    // ë‹¨ê³„ í†µê³¼ ì²´í¬ (ì§ì„  ê±°ë¦¬ ì‚¬ìš©)
    // ğŸš¨ ë…¸ë“œ í†µê³¼ ì„ê³„ê°’ì„ 8mì—ì„œ 15më¡œ ë†’ì—¬ ì´ë™ ì†ë„(ê²½ë¡œ ì§„í–‰)ë¥¼ ë¹ ë¥´ê²Œ ë³´ì´ë„ë¡ ìˆ˜ì •
    if (distToNextNode < 30) { // 30m ì´ë‚´ ì§„ì… ì‹œ ë‹¤ìŒ ë‹¨ê³„ë¡œ (ì‚¬ìš©ì ì†ë„ ì¦ê°€ íš¨ê³¼)
        route.currentStep++;
        if (route.currentStep >= route.steps.length) {
            arrive();
        } else {
            // ë‹¤ìŒ ë‹¨ê³„ë¡œ ë„˜ì–´ê°ˆ ë•Œ UI ê°±ì‹ ì„ ìœ„í•´ ê±°ë¦¬ ì¬ê³„ì‚° (ìƒˆë¡œìš´ ë‹¨ê³„ì˜ ê±°ë¦¬ì™€ ì´ ë‚¨ì€ ê±°ë¦¬)
            const nextStep = route.steps[route.currentStep];
            const nextTarget = AREAS[nextStep.to];
            const nextDistToNextNode = haversine(userPos.lat, userPos.lon, nextTarget.lat, nextTarget.lon); 
            
            let nextStepRemaining = Math.min(nextStep.dist, nextDistToNextNode);
            let newTotalRemainingDist = nextStepRemaining;
            for (let i = route.currentStep + 1; i < route.steps.length; i++) {
                newTotalRemainingDist += route.steps[i].dist;
            }
            updateNavUI(nextStep.instruction, newTotalRemainingDist);
        }
    }

    draw();
}

function oriHandler(e) {
    // ë””ë°”ì´ìŠ¤ ë°©í–¥ ì„¼ì„œ ë°ì´í„° ì²˜ë¦¬ (heading ë³€ìˆ˜ ì—…ë°ì´íŠ¸)
    // webkit-device-orientationì€ ì ˆëŒ€ê°’(compass)ì„ alphaì— ì œê³µí•©ë‹ˆë‹¤.
    if (e.alpha !== null) heading = e.alpha; 
}

function onError(e) {
    if (watching) {
        updateStatus("err", "GPS ì˜¤ë¥˜: " + e.message + " (ì‹ í˜¸ ë³µêµ¬ ëŒ€ê¸° ì¤‘)");
    }
}

function arrive() {
    stopNav();
    document.getElementById('instruction').textContent = "ëª©ì ì§€ ë„ì°©! ğŸ¥³";
    document.getElementById('distance').textContent = "ì¶•í•˜í•©ë‹ˆë‹¤! ì´ ê²½ë¡œ 0m ë‚¨ìŒ";
    document.getElementById('icon').innerHTML = `<i data-lucide="map-pin" class="w-10 h-10"></i>`;
    lucide.createIcons();
    
    document.getElementById('nav-btn').textContent = "ì¬ì„¤ì •";
    document.getElementById('nav-btn').classList.replace('bg-yellow-500','bg-blue-600');
    updateStatus("ok", "ëª©ì ì§€ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤!");
}

function resetApp() {
    stopNav();
    route = null;
    userPos = null;
    heading = 0;
    offset = {lat:0, lon:0};
    document.getElementById('nav-bar').classList.remove('active');
    document.getElementById('nav-btn').disabled = true;
    document.getElementById('nav-btn').textContent = "ë‚´ë¹„ ì‹œì‘";
    document.getElementById('nav-btn').classList.replace('bg-blue-600','bg-green-500');
    document.getElementById('qr-hint').textContent = '';
    updateNavUI('ëŒ€ê¸° ì¤‘', 0);
    updateStatus("err", "ì¤€ë¹„ ì¤‘: ì¶œë°œì§€ì™€ ë„ì°©ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
    draw();
}

function updateNavUI(instruction, totalRemainingDist) {
    document.getElementById('instruction').textContent = instruction;
    document.getElementById('distance').textContent = `ë‚¨ì€ ì´ ê²½ë¡œ: ${totalRemainingDist.toFixed(0)}m`;
    
    // ê²½ë¡œê°€ ìˆê³  í˜„ì¬ ë‹¨ê³„ê°€ ìœ íš¨í•  ë•Œë§Œ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
    if (route && route.currentStep < route.steps.length) {
        const step = route.steps[route.currentStep];
        document.getElementById('icon').innerHTML = `<i data-lucide="${step.icon}" class="w-10 h-10"></i>`;
        lucide.createIcons();
    }
}

// ë‹¤ìµìŠ¤íŠ¸ë¼ (ê²½ë¡œ ê°ì²´ì— distì™€ instruction í¬í•¨í•˜ë„ë¡ ìˆ˜ì •)
function dijkstra(start, end) {
    const graph = {};
    ALL_EDGES.forEach(e => {
        graph[e.from] = graph[e.from] || [];
        graph[e.from].push({ to: e.to, dist: e.dist, instruction: e.instruction, icon: e.icon });
    });

    const dist = {}, prev = {}, q = new Set(Object.keys(AREAS));
    Object.keys(AREAS).forEach(k => dist[k] = Infinity);
    dist[start] = 0;

    while (q.size) {
        let min = null;
        // ê°€ì¥ ê±°ë¦¬ê°€ ì§§ì€ ë…¸ë“œ ì°¾ê¸°
        q.forEach(n => { if (dist[n] < dist[min] || min === null) min = n; });
        if (min === end || dist[min] === Infinity) break;
        q.delete(min);

        graph[min] && graph[min].forEach(edge => {
            const alt = dist[min] + edge.dist;
            if (alt < dist[edge.to]) {
                dist[edge.to] = alt;
                prev[edge.to] = { node: min, edge: edge };
            }
        });
    }

    if (dist[end] === Infinity) return null;

    const pathNodes = [];
    const steps = [];
    let totalDist = dist[end];
    let u = end;
    
    // ê²½ë¡œ ì—­ì¶”ì 
    while (u) { pathNodes.unshift(u); u = prev[u] ? prev[u].node : null; }
    
    // ë‹¨ê³„ ì •ë³´ ì¶”ì¶œ
    for (let i = 0; i < pathNodes.length - 1; i++) {
        const fromNode = pathNodes[i];
        const toNode = pathNodes[i+1];
        
        // prev ê°ì²´ì—ì„œ toNodeë¡œ ì˜¤ëŠ” ë° ì‚¬ìš©ëœ ì—£ì§€ ì •ë³´ë¥¼ ì°¾ì•„ ë‹¨ê³„ì— ì¶”ê°€
        if (prev[toNode] && prev[toNode].node === fromNode) {
            steps.push({
                from: fromNode,
                to: toNode,
                dist: prev[toNode].edge.dist, // ë‹¨ê³„ë³„ ê±°ë¦¬ í¬í•¨
                instruction: prev[toNode].edge.instruction,
                icon: prev[toNode].edge.icon
            });
        }
    }
    
    // ìµœì¢… ë„ì°© ì•„ì´ì½˜ ì„¤ì •
    if (steps.length > 0) {
        steps[steps.length - 1].icon = "map-pin";
        steps[steps.length - 1].instruction = `${AREAS[end].name}ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤.`;
    }

    return {path: pathNodes, steps, dist: totalDist, currentStep: 0};
}

// í•˜ë²„ì‹  ê±°ë¦¬ (ì‚¬ìš©ì ì¢Œí‘œì™€ ë§µ ì¢Œí‘œ ê°„ì˜ ê±°ë¦¬ ì¸¡ì •)
function haversine(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const toRad = x => x * Math.PI / 180;
    const dlat = toRad(lat2-lat1);
    const dlon = toRad(lon2-lon1);
    const a = Math.sin(dlat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dlon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function updateStatus(type, msg) {
    const el = document.getElementById('status');
    el.textContent = msg;
    el.className = "p-3 rounded-lg text-sm font-medium mb-4 " + (type==="ok"?"status-ok":"status-err");
}

// ìº”ë²„ìŠ¤ ê·¸ë¦¬ê¸° â†’ ì§„ì§œ í…ŒìŠ¬ë¼ FSD í™”ë©´ìœ¼ë¡œ ì™„ì „ ë³€ê²½ (ê¸°ëŠ¥ 100% ìœ ì§€!)
// ì‹¤ë‚´ ì§€ë„ - ê²€ì • í…Œë‘ë¦¬ + í°ìƒ‰ ì•ˆìª½ + ë…¸ë€ ì‚¼ê°í˜• ì‚¬ìš©ì
function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    
    // ì™„ì „ ê²€ì€ ë°°ê²½
    ctx.fillStyle = "#000000";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // ì¢Œí‘œ ê³„ì‚°
    let minLat = Infinity, maxLat = -Infinity, minLon = Infinity, maxLon = -Infinity;
    Object.values(AREAS).forEach(a => {
        minLat = Math.min(minLat, a.lat); maxLat = Math.max(maxLat, a.lat);
        minLon = Math.min(minLon, a.lon); maxLon = Math.max(maxLon, a.lon);
    });
    const latRange = maxLat - minLat;
    const lonRange = maxLon - minLon;
    const ratio = Math.min(canvas.width / lonRange, canvas.height / latRange) * 0.85;

    const latLonToCanvas = (lat, lon) => {
        const cx = (minLon + maxLon) / 2;
        const cy = (minLat + maxLat) / 2;
        let x = (lon - cx) * ratio + canvas.width / 2;
        let y = (lat - cy) * ratio * -1 + canvas.height / 2;
        x = canvas.width / 2 + (x - canvas.width / 2) * scale + tx;
        y = canvas.height / 2 + (y - canvas.height / 2) * scale + ty;
        return {x, y};
    };

    // 1. ì—°ê²°ì„  (ì–´ë‘ìš´ íšŒìƒ‰)
    ctx.strokeStyle = "#444444";
    ctx.lineWidth = 4 * scale;
    EDGES_DATA.forEach(e => {
        const p1 = latLonToCanvas(AREAS[e.u].lat, AREAS[e.u].lon);
        const p2 = latLonToCanvas(AREAS[e.v].lat, AREAS[e.v].lon);
        ctx.beginPath();
        ctx.moveTo(p1.x, p1.y);
        ctx.lineTo(p2.x, p2.y);
        ctx.stroke();
    });

    // 2. ê²½ë¡œ (ë°ì€ íŒŒë€ìƒ‰)
    if (route) {
        ctx.strokeStyle = "#60a5fa";
        ctx.lineWidth = 9 * scale;
        ctx.lineCap = 'round';
        ctx.beginPath();
        route.path.forEach((id, i) => {
            const p = latLonToCanvas(AREAS[id].lat, AREAS[id].lon);
            i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y);
        });
        ctx.stroke();
    }

    // 3. ë…¸ë“œ (ì–´ë‘ìš´ ì› + í° ê¸€ì)
    Object.entries(AREAS).forEach(([id, a]) => {
        const {x, y} = latLonToCanvas(a.lat, a.lon);
        const isOnRoute = route && route.path.includes(id);        // ì´ ì¤„ ì¶”ê°€ ë˜ëŠ” êµì²´
	const isCurrent = isOnRoute;

        ctx.fillStyle = isCurrent ? "#34d399" : "#1e40af";  // í˜„ì¬: ì²­ë¡, ê²½ë¡œ: ì§„íŒŒë‘
        ctx.beginPath();
        ctx.arc(x, y, 16 * scale, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = "white";
        ctx.font = `bold ${18 * scale}px sans-serif`;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(id, x, y);
    });

    // 4. ì‚¬ìš©ì = ë…¸ë€ ì‚¼ê°í˜• + ì‹œì•¼ê° ë¶€ì±„ê¼´ (Gradient íš¨ê³¼)
    if (userPos) {
        const {x, y} = latLonToCanvas(userPos.lat, userPos.lon);

        ctx.save();
        ctx.translate(x, y);
        // Canvasì˜ 0ë„ëŠ” ì˜¤ë¥¸ìª½(East), Headingì˜ 0ë„ëŠ” ìœ„ìª½(North)ì´ë¯€ë¡œ -90ë„ ë³´ì •
        ctx.rotate((heading - 90) * Math.PI / 180);

        // --- [ì¶”ê°€ëœ ë¶€ë¶„] ì‹œì•¼ê° ë¶€ì±„ê¼´ ê·¸ë¦¬ê¸° ---
        const fovRadius = 120 * scale; // ë¶€ì±„ê¼´ ë°˜ì§€ë¦„ (ì›í•˜ëŠ” ë§Œí¼ ì¡°ì ˆ)
        
        // ê·¸ë¼ë°ì´ì…˜ ìƒì„± (ì¤‘ì‹¬ì€ ì§„í•˜ê³  ë°–ìœ¼ë¡œ ê°ˆìˆ˜ë¡ íˆ¬ëª…í•´ì§)
        const gradient = ctx.createRadialGradient(0, 0, 10 * scale, 0, 0, fovRadius);
        gradient.addColorStop(0, "rgba(251, 191, 36, 0.5)"); // ì•ˆìª½: ë°˜íˆ¬ëª… ë…¸ë‘
        gradient.addColorStop(1, "rgba(251, 191, 36, 0)");   // ë°”ê¹¥ìª½: ì™„ì „ íˆ¬ëª…

        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.moveTo(0, 0); // ì¤‘ì‹¬ì 
        // -45ë„ ~ +45ë„ (ì´ 90ë„ ê°ë„) ë¶€ì±„ê¼´ ê·¸ë¦¬ê¸°
        ctx.arc(0, 0, fovRadius, -Math.PI / 4, Math.PI / 4); 
        ctx.closePath();
        ctx.fill();
        // -------------------------------------

        // ê¸°ì¡´ í™”ì‚´í‘œ(ì‚¼ê°í˜•) ê·¸ë¦¬ê¸°
        ctx.fillStyle = "#fbbf24";
        ctx.beginPath();
        ctx.moveTo(0, -22 * scale);
        ctx.lineTo(-14 * scale, 14 * scale);
        ctx.lineTo(14 * scale, 14 * scale);
        ctx.closePath();
        ctx.fill();

        ctx.strokeStyle = "#f59e0b";
        ctx.lineWidth = 3 * scale;
        ctx.stroke();

        ctx.restore();
    }
}

// í„°ì¹˜/ë§ˆìš°ìŠ¤ ì¤Œ & íŒ¬
function setupCanvasEvents() {
    let dragging = false, lastX, lastY, initialScale = 1;
    let st = []; // For touch points
    let touchDist = 0; // For pinch zoom distance

    // Mouse events
    canvas.addEventListener('wheel', e => {
        e.preventDefault();
        // ì¤Œ ì¤‘ì‹¬ì ì„ ë§ˆìš°ìŠ¤ ìœ„ì¹˜ë¡œ ì„¤ì •í•˜ë ¤ë©´ ë” ë³µì¡í•œ ë¡œì§ì´ í•„ìš”í•˜ì§€ë§Œ, ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœ ì¤‘ì•™ ì¤Œì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        scale = Math.max(0.5, Math.min(5, scale * (e.deltaY < 0 ? 1.1 : 0.9)));
        draw();
    }, { passive: false });

    canvas.addEventListener('mousedown', e => { dragging = true; lastX = e.clientX; lastY = e.clientY; });
    canvas.addEventListener('mousemove', e => {
        if (dragging) {
            tx += e.clientX - lastX; ty += e.clientY - lastY;
            lastX = e.clientX; lastY = e.clientY;
            draw();
        }
    });
    canvas.addEventListener('mouseup', () => dragging = false);
    canvas.addEventListener('mouseleave', () => dragging = false);

    // Touch events
    canvas.addEventListener('touchstart', e => { 
        e.preventDefault(); 
        st = Array.from(e.touches);
        if (st.length === 1) {
            dragging = true; lastX = st[0].clientX; lastY = st[0].clientY;
        } else if (st.length === 2) {
            initialScale = scale;
            touchDist = Math.hypot(st[0].clientX - st[1].clientX, st[0].clientY - st[1].clientY);
            dragging = false; // ë‘ ì†ê°€ë½ í„°ì¹˜ ì‹œ íŒ¬ ê¸°ëŠ¥ì€ ì •ì§€
        }
    }, { passive: false });

    canvas.addEventListener('touchmove', e => {
        e.preventDefault(); 
        const t = Array.from(e.touches);
        if (t.length === 1 && dragging) { 
            tx += t[0].clientX - lastX; ty += t[0].clientY - lastY; 
            lastX = t[0].clientX; lastY = t[0].clientY; 
        } else if (t.length === 2 && st.length === 2) {
            const newDist = Math.hypot(t[0].clientX - t[1].clientX, t[0].clientY - t[1].clientY);
            if (touchDist > 0) {
                scale = Math.max(0.5, Math.min(5, initialScale * (newDist / touchDist)));
            }
        }
        draw();
    }, { passive: false });

    canvas.addEventListener('touchend', () => { 
        dragging = false; 
        st = [];
        // ë‚´ë¹„ê²Œì´ì…˜ ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³µêµ¬ ë¡œì§ (ì¤Œ/íŒ¬ í›„ ìƒíƒœ ë³µì›)
        if (route && route.currentStep >= route.steps.length) { 
             document.getElementById('nav-btn').textContent = "ì¬ì„¤ì •";
             document.getElementById('nav-btn').classList.replace('bg-yellow-500','bg-blue-600');
        } else if (watching) {
            document.getElementById('nav-btn').textContent = "ì •ì§€";
            document.getElementById('nav-btn').classList.replace('bg-yellow-500','bg-red-500');
        } else if(route) {
            document.getElementById('nav-btn').textContent = "ì¬ê°œ";
            document.getElementById('nav-btn').classList.replace('bg-red-500','bg-yellow-500');
        }
    });
}
</script>
</body>
</html>